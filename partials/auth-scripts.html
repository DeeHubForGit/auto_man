<!-- Conditionally load config.local.js if it exists (dev only, gitignored) -->
<script>
(function() {
  // Try to load config.local.js silently - if it 404s, that's fine (production)
  const script = document.createElement('script');
  script.src = 'assets/js/config.local.js';
  script.onerror = function() {
    // Silently fail - config.js is already loaded
  };
  document.head.appendChild(script);
})();
</script>

<!-- Supabase library (UMD) -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<!-- Single global client for ALL pages -->
<script src="assets/js/supabaseClient.js"></script>

<!-- partials/auth-scripts.html -->
<script>
// Guard: avoid re-initialising if this partial is included multiple times
if (!window.__authBootstrapped) {
  window.__authBootstrapped = true;

  // 1) Wait for include.js to finish injecting partials, if it exposes a hook.
  // If your include.js does not provide a hook, we polyfill a resolved one.
  window.whenIncludesDone = window.whenIncludesDone || Promise.resolve();

  // 2) Create a single Supabase client with stable storageKey.
  //    If you already have assets/js/supabaseClient.js, keep it, but ensure it only runs once.
  (function initSupabaseOnce(){
    if (window.supabaseClient) return;
    // If you keep a separate file, you can early-return here and rely on that one.
    // Inline minimal client creation to guarantee availability:
    // NOTE: assumes @supabase/supabase-js already loaded globally somewhere once.
    const supabaseUrl = window.SITE_CONFIG?.SUPABASE_URL;
    const supabaseKey = window.SITE_CONFIG?.SUPABASE_ANON_KEY;
    if (!supabaseUrl || !supabaseKey) {
      console.warn('[auth] Missing SUPABASE config in SITE_CONFIG');
      return;
    }
    window.supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        storageKey: 'sb-automansite-auth'
      }
    });

    // Handle password recovery redirect
    window.supabaseClient.auth.onAuthStateChange((event, session) => {
      if (event === 'PASSWORD_RECOVERY' && !window.location.pathname.includes('reset-password.html')) {
        window.location.href = '/reset-password.html';
      }
    });
  })();

  // 3) Expose a single promise that resolves when:
  //    - partials are injected
  //    - supabase client exists
  //    - current session has been fetched
  window.authReady = (async () => {
    // Wait for other partials to finish loading (header, etc.)
    await window.whenIncludesDone;

    // Wait for client
    let tries = 20;
    while (!window.supabaseClient && tries-- > 0) {
      await new Promise(r => setTimeout(r, 25));
    }
    if (!window.supabaseClient) {
      console.error('[auth] Supabase client missing after wait');
      return { session: null, user: null };
    }

    // Ask Supabase for current session
    const { data, error } = await window.supabaseClient.auth.getSession();
    if (error) console.warn('[auth] getSession error:', error);
    const session = data?.session || null;
    const user = session?.user || null;

    return { session, user };
  })();
}
</script>
