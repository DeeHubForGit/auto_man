<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reset Password - Auto-Man Driving School</title>
  <meta name="description" content="Set a new password for your Auto-Man Driving School account." />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="assets/theme.css" rel="stylesheet">
  <script src="assets/config.js"></script>
  <script src="assets/render-helpers.js" defer></script>
  <script src="assets/include.js" defer></script>
  <script src="assets/js/modal.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Auth scripts (global Supabase client) MUST load before header -->
  <div data-include="partials/auth-scripts.html"></div>
  <!-- Shared Header - permanent container prevents layout shift -->
  <div id="header-container" style="min-height: 70px;">
    <div data-include="partials/header.html"></div>
  </div>

  <main class="py-16">
    <div class="container mx-auto px-4">
      <div class="max-w-md mx-auto bg-white rounded-2xl border p-8 shadow">
        <!-- Loading State -->
        <div id="loadingState" class="text-center">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p class="text-gray-600">Verifying reset link...</p>
        </div>

        <!-- Invalid/Expired Link -->
        <div id="invalidState" class="hidden text-center">
          <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </div>
          <h2 class="text-2xl font-bold mb-2">Invalid or Expired Link</h2>
          <p class="text-gray-600 mb-6">
            This password reset link is invalid or has expired. Reset links can only be used once and expire after 1 hour. If you already reset your password, you can log in with your new password.
          </p>
          <div class="space-y-3">
            <a href="forgot-password.html" class="block w-full btn-primary py-2.5 rounded-lg text-center font-medium">
              Request New Reset Link
            </a>
            <a href="login.html" class="block w-full btn-secondary py-2.5 rounded-lg font-medium text-center">
              Try Logging In
            </a>
          </div>
        </div>

        <!-- Reset Form -->
        <div id="resetForm" class="hidden">
          <h1 class="text-3xl font-extrabold mb-2 text-center">Set New Password</h1>
          <p class="text-sm text-gray-600 mb-6 text-center">Choose a strong password for your account.</p>

          <form id="newPasswordForm" class="space-y-4" novalidate>
            <div>
              <label class="block text-sm font-medium mb-1" for="newPassword">New Password</label>
              <div class="relative">
                <input 
                  id="newPassword" 
                  type="password" 
                  class="w-full border rounded-lg px-3 py-2 pr-16 text-black focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                  required
                  autocomplete="new-password"
                  minlength="12"
                  pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\[\]{};':\"\\|,.<>/?]).{12,}$"
                />
                <button type="button" id="toggleNewPwd" class="absolute right-2 top-1/2 -translate-y-1/2 px-2 py-1 text-sm border rounded bg-white text-gray-800 hover:bg-gray-100 font-medium">Show</button>
              </div>
              <p id="passwordError" class="text-xs text-red-400 mt-1 hidden"></p>
              
              <!-- Password strength indicator -->
              <div class="mt-2">
                <div class="flex gap-1 mb-1">
                  <div id="strength-1" class="h-1 flex-1 bg-gray-200 rounded"></div>
                  <div id="strength-2" class="h-1 flex-1 bg-gray-200 rounded"></div>
                  <div id="strength-3" class="h-1 flex-1 bg-gray-200 rounded"></div>
                  <div id="strength-4" class="h-1 flex-1 bg-gray-200 rounded"></div>
                </div>
                <p id="strengthText" class="text-xs text-gray-500"></p>
              </div>

              <!-- Password requirements -->
              <ul class="mt-2 text-xs text-gray-600 space-y-1">
                <li id="req-length" class="flex items-center gap-1">
                  <span class="text-gray-400">○</span> At least 12 characters
                </li>
                <li id="req-uppercase" class="flex items-center gap-1">
                  <span class="text-gray-400">○</span> One uppercase letter (A-Z)
                </li>
                <li id="req-lowercase" class="flex items-center gap-1">
                  <span class="text-gray-400">○</span> One lowercase letter (a-z)
                </li>
                <li id="req-number" class="flex items-center gap-1">
                  <span class="text-gray-400">○</span> One number (0-9)
                </li>
                <li id="req-special" class="flex items-center gap-1">
                  <span class="text-gray-400">○</span> One special character (!@#$%^&* etc.)
                </li>
              </ul>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1" for="confirmPassword">Confirm New Password</label>
              <div class="relative">
                <input 
                  id="confirmPassword" 
                  type="password" 
                  class="w-full border rounded-lg px-3 py-2 pr-16 text-black focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                  required
                  autocomplete="new-password"
                />
                <button type="button" id="toggleConfirmPwd" class="absolute right-2 top-1/2 -translate-y-1/2 px-2 py-1 text-sm border rounded bg-white text-gray-800 hover:bg-gray-100 font-medium">Show</button>
              </div>
              <p id="confirmError" class="text-xs text-red-400 mt-1 hidden"></p>
            </div>
            
            <button 
              type="submit" 
              id="submitBtn"
              class="w-full btn-primary py-2.5 rounded-lg font-medium">
              Reset Password
            </button>
          </form>
        </div>

        <!-- Success State -->
        <div id="successState" class="hidden text-center">
          <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
          <h2 class="text-2xl font-bold mb-2">Password Reset Successful!</h2>
          <p class="text-gray-600 mb-6">
            Your password has been updated. You can now log in with your new password.
          </p>
          <a href="login.html" class="block w-full btn-primary py-2.5 rounded-lg font-medium text-center">
            Go to Log In
          </a>
        </div>
      </div>
    </div>
  </main>

  <div data-include="partials/footer.html"></div>

  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      // Wait for Supabase client
      while (!window.supabaseClient) {
        await new Promise(r => setTimeout(r, 100));
      }

      const loadingState = document.getElementById('loadingState');
      const invalidState = document.getElementById('invalidState');
      const resetForm = document.getElementById('resetForm');
      const successState = document.getElementById('successState');
      const form = document.getElementById('newPasswordForm');
      const newPasswordInput = document.getElementById('newPassword');
      const confirmPasswordInput = document.getElementById('confirmPassword');
      const toggleNewPwd = document.getElementById('toggleNewPwd');
      const toggleConfirmPwd = document.getElementById('toggleConfirmPwd');
      const passwordError = document.getElementById('passwordError');
      const confirmError = document.getElementById('confirmError');
      const submitBtn = document.getElementById('submitBtn');

      // Check if we have a valid recovery session
      const { data: { session }, error } = await window.supabaseClient.auth.getSession();
      
      loadingState.classList.add('hidden');

      if (error || !session) {
        // No valid session - show invalid state
        invalidState.classList.remove('hidden');
        return;
      }

      // Valid session - show reset form
      resetForm.classList.remove('hidden');

      // Toggle password visibility
      toggleNewPwd.addEventListener('click', function() {
        const type = newPasswordInput.type === 'password' ? 'text' : 'password';
        newPasswordInput.type = type;
        toggleNewPwd.textContent = type === 'password' ? 'Show' : 'Hide';
      });

      toggleConfirmPwd.addEventListener('click', function() {
        const type = confirmPasswordInput.type === 'password' ? 'text' : 'password';
        confirmPasswordInput.type = type;
        toggleConfirmPwd.textContent = type === 'password' ? 'Show' : 'Hide';
      });

      // Password strength checker
      function checkPasswordStrength(password) {
        const requirements = {
          length: password.length >= 12,
          hasUpper: /[A-Z]/.test(password),
          hasLower: /[a-z]/.test(password),
          hasNumber: /\d/.test(password),
          hasSpecial: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>/?]/.test(password)
        };

        // Update requirement indicators (✓ / ○)
        const reqMap = {
          length: 'req-length',
          hasUpper: 'req-uppercase',
          hasLower: 'req-lowercase',
          hasNumber: 'req-number',
          hasSpecial: 'req-special'
        };

        Object.entries(reqMap).forEach(([key, id]) => {
          const span = document.getElementById(id)?.querySelector('span');
          if (span) {
            span.textContent = requirements[key] ? '✓' : '○';
          }
        });

        const metCount = Object.values(requirements).filter(Boolean).length;

        // Update strength bars
        const strengthBars = document.querySelectorAll('#strength-1, #strength-2, #strength-3, #strength-4');
        const strengthText = document.getElementById('strengthText');

        strengthBars.forEach((bar, index) => {
          bar.className = 'h-1 flex-1 bg-gray-200 rounded';
          if (index < metCount && metCount > 0) {
            if (metCount <= 2) {
              bar.classList.add('bg-red-500');
            } else if (metCount === 3) {
              bar.classList.add('bg-orange-500');
            } else {
              bar.classList.add('bg-green-500');
            }
          }
        });

        // Strength label
        if (metCount === 0) {
          strengthText.textContent = '';
        } else if (metCount <= 2) {
          strengthText.textContent = 'Strength: Weak';
        } else if (metCount === 3) {
          strengthText.textContent = 'Strength: Fair';
        } else {
          strengthText.textContent = 'Strength: Strong';
        }

        // Optional: return whether all requirements are met
        return metCount === Object.keys(requirements).length;
      }

      // Real-time password strength checking
      newPasswordInput.addEventListener('input', function() {
        checkPasswordStrength(this.value);
        if (passwordError.textContent) {
          passwordError.classList.add('hidden');
          newPasswordInput.classList.remove('border-red-400');
        }
      });

      // Clear confirm error on input
      confirmPasswordInput.addEventListener('input', function() {
        if (confirmError.textContent) {
          confirmError.classList.add('hidden');
          confirmPasswordInput.classList.remove('border-red-400');
        }
      });

      // Validation
      function validatePassword() {
        const password = newPasswordInput.value;
        const requirements = {
          length: password.length >= 12,
          hasUpper: /[A-Z]/.test(password),
          hasLower: /[a-z]/.test(password),
          hasNumber: /\d/.test(password),
          hasSpecial: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>/?]/.test(password)
        };

        if (!password) {
          showPasswordError('Please enter a new password');
          return false;
        }

        if (!requirements.length || !requirements.hasUpper || !requirements.hasLower || !requirements.hasNumber || !requirements.hasSpecial) {
          showPasswordError('Password must meet all requirements');
          return false;
        }

        hidePasswordError();
        return true;
      }

      function validateConfirmPassword() {
        const password = newPasswordInput.value;
        const confirm = confirmPasswordInput.value;

        if (!confirm) {
          showConfirmError('Please confirm your password');
          return false;
        }

        if (password !== confirm) {
          showConfirmError('Passwords do not match');
          return false;
        }

        hideConfirmError();
        return true;
      }

      function showPasswordError(message) {
        passwordError.textContent = message;
        passwordError.classList.remove('hidden');
        newPasswordInput.classList.add('border-red-400');
      }

      function hidePasswordError() {
        passwordError.classList.add('hidden');
        newPasswordInput.classList.remove('border-red-400');
      }

      function showConfirmError(message) {
        confirmError.textContent = message;
        confirmError.classList.remove('hidden');
        confirmPasswordInput.classList.add('border-red-400');
      }

      function hideConfirmError() {
        confirmError.classList.add('hidden');
        confirmPasswordInput.classList.remove('border-red-400');
      }

      // Handle form submission
      form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const isPasswordValid = validatePassword();
        const isConfirmValid = validateConfirmPassword();

        if (!isPasswordValid || !isConfirmValid) return;

        const newPassword = newPasswordInput.value;

        // Disable button during submission
        submitBtn.disabled = true;
        submitBtn.textContent = 'Resetting...';
        submitBtn.classList.add('opacity-50', 'cursor-not-allowed');

        try {
          const { error } = await window.supabaseClient.auth.updateUser({
            password: newPassword
          });

          if (error) throw error;

          // Success! Show success state briefly, then redirect to login
          resetForm.classList.add('hidden');
          successState.classList.remove('hidden');
          
          // Auto-redirect to login after 2 seconds
          setTimeout(() => {
            window.location.href = 'login.html?reset=success';
          }, 2000);

        } catch (err) {
          console.error('[reset-password] Error:', err);
          Modal.error(err.message || 'Failed to reset password. Please try again.');
          
          submitBtn.disabled = false;
          submitBtn.textContent = 'Reset Password';
          submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      });
    });
  </script>
</body>
</html>
