<!-- My Contact Messages Section -->
<div class="bg-white rounded-2xl border shadow-sm p-5">
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-3">
      <h2 class="text-xl font-semibold">My Contact Messages</h2>
      <span id="myContactsCount" class="text-sm text-gray-600"></span>
    </div>
  </div>
  
  <div id="myContactsList" class="space-y-3"></div>
</div>

<script>
(function() {
  async function loadMyContactMessages() {
    const box = document.getElementById('myContactsList');
    const countEl = document.getElementById('myContactsCount');
    
    if (!box || !window.supabaseClient || !window.currentUser) {
      console.log('[portal-contacts] Cannot load contact messages - missing requirements');
      return;
    }
    
    const userEmail = window.currentUser.email;
    
    box.innerHTML = '<div class="p-8 text-center text-gray-500">Loading messages...</div>';
    
    try {
      const { data, error } = await window.supabaseClient
        .from('contact_messages')
        .select('*')
        .eq('email', userEmail)
        .order('created_at', { ascending: false });
      
      if (error) {
        console.error('[portal-contacts] Error loading contact messages:', error);
        box.innerHTML = '<div class="p-4 text-center text-red-600">Error loading messages</div>';
        return;
      }
      
      const messages = Array.isArray(data) ? data : [];
      
      if (countEl) {
        countEl.textContent = messages.length > 0 ? `(${messages.length})` : '';
      }
      
      if (messages.length === 0) {
        box.innerHTML = `
          <div class="p-8 text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
            <p class="text-gray-300 text-lg">No contact messages yet</p>
          </div>
        `;
        return;
      }
      
      // Render messages (matching admin-contacts style)
      box.innerHTML = '';
      
      messages.forEach(row => {
        const card = document.createElement('div');
        card.className = 'contact-card mb-3';
        
        const name = row.name || 'Anonymous';
        const email = row.email || '';
        const phone = row.phone || '';
        const message = row.message || '';
        const date = new Date(row.created_at).toLocaleString('en-AU', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
        
        card.innerHTML = `
          <div class="font-semibold mb-1">${name}</div>

          <div class="text-sm mb-1 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                d="M21.75 7.5v9a2.25 2.25 0 0 1-2.25 2.25h-15A2.25 2.25 0 0 1 2.25 16.5v-9m19.5 0A2.25 2.25 0 0 0 19.5 5.25h-15A2.25 2.25 0 0 0 2.25 7.5m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.915l-7.5 4.5a2.25 2.25 0 0 1-2.31 0l-7.5-4.5A2.25 2.25 0 0 1 2.25 7.743V7.5" />
            </svg>
            <span>${email || 'â€”'}</span>
          </div>

          ${phone ? `
            <div class="text-sm mb-2 flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M2.25 6.75c0 7.456 6.044 13.5 13.5 13.5a2.25 2.25 0 0 0 2.25-2.25v-1.17a1.5 1.5 0 0 0-1.03-1.422l-3.03-1.01a1.5 1.5 0 0 0-1.64.54l-.64.85a10.5 10.5 0 0 1-4.56-4.56l.85-.64a1.5 1.5 0 0 0 .54-1.64l-1.01-3.03A1.5 1.5 0 0 0 6.17 4.5H5a2.25 2.25 0 0 0-2.75 2.25z" />
              </svg>
              <span>${phone}</span>
            </div>
          ` : '<div class="mb-2"></div>'}

          <div class="whitespace-pre-wrap mb-2"><strong>Message:</strong> ${message}</div>
          <div class="text-xs opacity-80 mt-2">${date}</div>
        `;
        
        box.appendChild(card);
      });
      
    } catch (err) {
      console.error('[portal-contacts] Unexpected error:', err);
      box.innerHTML = '<div class="p-4 text-center text-red-600">Error loading messages</div>';
    }
  }
  
  // Load when client data is available
  window.addEventListener('clientDataLoaded', function() {
    loadMyContactMessages();
  });
  
  // Also try loading if we're already initialized
  if (window.currentUser) {
    loadMyContactMessages();
  }
})();
</script>
