<!-- Admin Calendar Section -->
<script src="assets/js/googleCalendar.js?v=3"></script>
<style>
  /* Scoped styles for calendar bookings */
  #section-calendar .booking-card {
    cursor: pointer;
    transition: all 0.2s ease;
    overflow: visible;
  }
  
  #section-calendar .booking-card .booking-time {
    font-weight: 600;
  }
  
  /* Compact view - hide details by default */
  #section-calendar .booking-card .booking-details {
    display: none;
  }
  
  /* Expanded view on hover - show full details - DESKTOP ONLY */
  @media (min-width: 769px) {
    #section-calendar .booking-card:hover {
      z-index: 50 !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: scale(1.02);
      height: auto !important;
      min-height: fit-content !important;
      overflow: visible;
    }
    
    #section-calendar .booking-card:hover .booking-details {
      display: block;
    }
    /* Desktop hover: hide entire summary when details are shown to avoid duplicates */
    #section-calendar .booking-card:hover .booking-summary {
      display: none !important;
    }
  }
  
  /* Compact summary styling */
  #section-calendar .booking-summary {
    line-height: 1.2;
  }
  
  #section-calendar .booking-summary .booking-name {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  /* Cancel button styling */
  #section-calendar .booking-cancel-btn {
      width: 18px;
      height: 18px;
      padding: 0;                       /* tightest fit */
      border-radius: 50%;               /* perfect circle */
      background: transparent;
      color: #dc2626;                   /* normal soft red */
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s ease, color 0.15s ease;
      margin-left: auto;
      margin-right: -4px;
      flex-shrink: 0;                   /* prevent shrinking */
  }

  #section-calendar .booking-cancel-btn:hover {
      background: rgba(220, 38, 38, 0.10); /* tighter, softer halo */
      color: #b91c1c;                      /* subtle darkening */
  }

  #section-calendar .booking-cancel-btn svg {
    display: block;
  }
  
  @media (max-width: 768px) {
    /* Hide red cancel X on collapsed cards in the grid */
    #section-calendar .booking-card:not(.booking-active) .booking-cancel-btn {
      display: none !important;
    }

    /* Show it again on the expanded mobile popup */
    #section-calendar .booking-card.booking-active .booking-cancel-btn {
      display: inline-flex !important;
    }
  }


  /* Wrapper for button and content to use flexbox */
  #section-calendar .booking-card-content {
    display: flex;
    align-items: flex-start;
    gap: 2px;
  }
  
  #section-calendar .booking-card-text {
    flex: 1;
    min-width: 0;
  }
  
  #section-calendar .booking-cancel-btn {
    align-self: flex-start;
    margin-top: 0px;
  }
  
  /* Show cancel button always for now */
  #section-calendar .booking-card .booking-cancel-btn {
    display: inline-flex;
  }
  
  /* Ensure status dropdown is always visible in expanded state */
  #section-calendar .booking-card .booking-status-select {
    margin-top: 0.25rem;
  }
  
  /* Ensure header row and time column are visible on dark background */
  #section-calendar .calendar-header {
    color: #111827 !important;
    background-color: #f3f4f6 !important;
  }
  #section-calendar .calendar-time-cell {
    color: #111827 !important;
    background-color: #f9fafb !important;
    padding: 4px 6px; /* Tighter vertical spacing for mobile */
    position: sticky;
    left: 0;
    z-index: 10;
  }
  
  /* Hide mobile-only elements on desktop */
  #section-calendar .mobile-only {
    display: none;
  }
  
  /* Tighter row height for mobile */
  #section-calendar #weekGrid > div > div {
    min-height: 56px; /* down from 80px */
  }
  
  /* Fix for header time cell */
  #section-calendar .calendar-header:first-child {
    position: sticky;
    left: 0;
    z-index: 20;
    background-color: #f3f4f6 !important;
  }
  
  /* Calendar grid cells */
  #section-calendar #weekGrid > div {
    background-color: white !important;
    border-color: #e5e7eb !important;
  }
  
  /* Calendar title and text */
  #section-calendar h2,
  #section-calendar .text-sm {
    color: #111827 !important;
  }
  
  /* Calendar navigation buttons ‚Äì reuse global btn/btn-primary colours */
  #section-calendar .calendar-nav-btn {
    /* size tweaks only */
    height: 32px;
    min-width: 32px;
    padding: 0.25rem 0.5rem;
    line-height: 1;
    border-radius: 0.5rem; /* match other buttons */
    font-weight: 500;
  }

  /* Make icon-based button match text buttons */
  #section-calendar .calendar-nav-btn svg {
    width: 20px;
    height: 20px;
    display: block;
  }
  
  /* Mobile scroll improvements */
  #section-calendar #calendar {
    overflow-x: auto;
    overflow-y: auto;
  }
  
  /* Desktop: wider columns */
  #section-calendar #weekGrid {
    min-width: auto; /* Allow mobile to shrink */
  }
  
  /* Visible scrollbar for mobile */
  #section-calendar #calendar::-webkit-scrollbar {
    height: 8px;
    width: 8px;
  }
  
  #section-calendar #calendar::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
  }
  
  #section-calendar #calendar::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
  }
  
  #section-calendar #calendar::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }
  
  /* Firefox scrollbar */
  #section-calendar #calendar {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f1f5f9;
  }
  
  /* Mobile: narrower columns so all 7 days fit */
  @media (max-width: 768px) {
  /* Always hide elements marked web-only on mobile (even when expanded) */
  #section-calendar .web-only { display: none !important; }
    /* Hide desktop-only content in compact blue blocks */
    #section-calendar .booking-card .desktop-only {
      display: none !important;
    }
    
    /* Show mobile-only content */
    #section-calendar .booking-card .mobile-only {
      display: block !important;
    }
    
    /* In expanded view, show everything */
    #section-calendar .booking-card.booking-active .desktop-only {
      display: block !important;
    }
    
    #section-calendar #weekGrid {
      grid-template-columns: 35px repeat(7, 1fr) !important;
      min-width: 100% !important; /* Remove forced scroll, fit to screen */
    }

    #section-calendar .calendar-header,
    #section-calendar .calendar-time-cell {
      padding: 2px 1px;
      font-size: 9px;
      line-height: 1.0;
      text-align: center;
    }

    /* Slightly shorter rows to reduce vertical scroll */
    #section-calendar #weekGrid > div > div {
      min-height: 48px;
    }
    
    /* Reduce cell padding for tighter fit */
    #section-calendar #weekGrid > div > div {
      padding: 1px;
    }
    
    /* Mobile: compact blocks, expand on tap */
    /* Default: show as a simple bar with name/suburb */
    #section-calendar .booking-card {
      /* Colors set via inline styles for booking vs non-booking */
      border-left: none !important;
      border-radius: 2px;
      padding: 2px 3px !important;
      overflow: hidden;
      font-size: 9px !important;
      line-height: 1.2;
      font-weight: 500;
    }
    
    /* Hide cancel button in compact mobile view to prevent accidental presses */
    #section-calendar .booking-card .booking-cancel-btn {
      display: none !important;
    }
    
    /* Show cancel button in expanded mobile popup */
    #section-calendar .booking-card.booking-active .booking-cancel-btn {
      display: inline-flex !important;
    }
    
    /* Text color set via inline styles */
    #section-calendar .booking-card .booking-name {
      /* Color inherited from parent */
    }
    
    /* Show minimal info in compact view */
    #section-calendar .booking-card .booking-summary {
      display: block !important;
    }
    
    /* Text color set via inline styles */
    #section-calendar .booking-card .booking-summary > * {
      /* Color inherited from inline styles */
    }    /* Hide detailed info by default */
    #section-calendar .booking-card .booking-details {
      display: none;
    }

    /* Expanded: centered modal wider for readability */
    #section-calendar .booking-card.booking-active {
      /* Background color set via inline styles (blue-200 for bookings, gray-100 for non-bookings) */
      border-left: 2px solid #3b82f6 !important;
      padding: 12px 16px !important;
      z-index: 50 !important;
      overflow: visible;
      position: fixed !important;
      left: 50% !important;
      top: 50% !important;
      transform: translate(-50%, -50%) !important;
      width: 90vw !important;
      max-width: 420px !important;
      height: auto !important;
      max-height: 80vh !important;
      overflow-y: auto !important;
      box-shadow: 0 14px 48px rgba(0,0,0,0.35) !important;
      font-size: 13px !important;
      border-radius: 12px !important;
    }
    
    /* Text color set via inline styles (dark blue for bookings, dark gray for non-bookings) */
    #section-calendar .booking-card.booking-active .booking-name { 
      font-weight: 600;
    }
    /* Hide mobile summary when expanded to avoid duplication (details remain visible) */
    #section-calendar .booking-card.booking-active .booking-summary { display: none !important; }
    
    /* Move cancel button left on mobile expanded view to avoid overlap with close X */
    #section-calendar .booking-card.booking-active .booking-cancel-btn { 
      margin-right: 24px !important; 
    }
    
    /* Close button for mobile modal (neutral gray, overlays content) */
    #section-calendar .booking-close-btn {
      position: absolute;
      top: 10px;           /* align with cancel button */
      right: 10px;
      width: 18px;
      height: 18px;
      background: transparent;  /* no fill */
      color: #6b7280 !important; /* gray-500 */
      border: none;
      border-radius: 50%;       /* still clickable circle area */
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      font-weight: bold;
      line-height: 0.75;
      z-index: 60;
    }
    
    #section-calendar .booking-close-btn:hover {
      background: rgba(0,0,0,0.04);
      color: #374151 !important; /* gray-700 */
    }

    #section-calendar .booking-card.booking-active .booking-details {
      display: block;
    }
    
    /* Backdrop for closing modal */
    #section-calendar .booking-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 45;
    }
    
    #section-calendar .booking-backdrop.active {
      display: block;
    }
  }
  
</style>
<section id="section-calendar" class="section-content bg-white border rounded-2xl shadow-sm p-5" style="background-color: white !important; color: #111827 !important;">
  <!-- Week range + navigation -->
  <div class="flex items-center justify-between mb-3" role="group" aria-label="Calendar navigation">
    <div class="flex items-center gap-3">
      <span id="weekRange" class="text-base sm:text-lg font-bold text-blue-600">
        Week: 09/11/25 - 15/11/25
      </span>
      <div class="flex items-center gap-2">
        <button id="prevWeek" class="btn btn-primary-light calendar-nav-btn !px-2 !py-1" aria-label="Previous week">‚Üê</button>
        <button id="nextWeek" class="btn btn-primary calendar-nav-btn !px-2 !py-1" aria-label="Next week">‚Üí</button>
        <button id="todayBtn" class="btn btn-outline-blue calendar-nav-btn !px-2 !py-1" title="Today" aria-label="Jump to today">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8"  y1="2" x2="8"  y2="6"></line>
            <line x1="3"  y1="10" x2="21" y2="10"></line>
            <text x="12" y="16" text-anchor="middle" font-size="9" font-weight="bold" fill="currentColor">{{DAY}}</text>
          </svg>
        </button>
        <button id="refreshBtn" class="btn btn-outline-blue calendar-nav-btn !px-2 !py-1" title="Refresh calendar" aria-label="Refresh calendar">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
  
  <!-- No bookings message - displayed below navigation -->
  <div id="noBookingsMsg" class="text-blue-500 font-semibold text-center mb-3 hidden">
    No bookings found for this week
  </div>

  <div id="calendar" class="overflow-auto max-h-[600px] relative">
    <div id="weekGrid" class="grid grid-cols-8 text-sm" style="grid-template-columns: 80px repeat(7, minmax(120px, 1fr));"></div>
  </div>
</section>

<script>
(function() {
  // Calendar logic
  function addDays(d, n) { const r = new Date(d); r.setDate(r.getDate() + n); return r; }
  let weekStart = new Date();

  function renderWeek(startDate) {
    weekStart = new Date(startDate);
    weekStart.setDate(weekStart.getDate() - weekStart.getDay());
    // Set to start of day (midnight) to avoid timezone issues
    weekStart.setHours(0, 0, 0, 0);
    const grid = document.getElementById('weekGrid');
    if (!grid) return;
    grid.innerHTML = '';

    // Display week range
    const weekEnd = addDays(weekStart, 6);
    const rangeEl = document.getElementById('weekRange');
    if (rangeEl) {
      const formatShortDate = (date) => {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = String(date.getFullYear()).slice(-2);
        return `${day}/${month}/${year}`;
      };
      const isMobile = window.matchMedia('(max-width: 768px)').matches;
      rangeEl.textContent = isMobile
        ? `${formatShortDate(weekStart)} - ${formatShortDate(weekEnd)}`
        : `Week: ${formatShortDate(weekStart)} - ${formatShortDate(weekEnd)}`;
    }

    // Header row with dates
    const headerRow = document.createElement('div');
    headerRow.className = 'contents';
    const days = ['Time', 'Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    days.forEach((day, idx) => {
      const cell = document.createElement('div');
      cell.className = 'calendar-header font-semibold p-2 border sticky top-0 z-10';
      if (idx === 0) cell.classList.add('left-0', 'z-20');
      if (idx > 0) {
        const date = addDays(weekStart, idx - 1);
        // For mobile: show day name on line 1, date on line 2
        const isMobile = window.matchMedia('(max-width: 768px)').matches;
        if (isMobile) {
          cell.innerHTML = `<div style="line-height: 1.1;">${day}</div><div style="line-height: 1.1;">${date.getDate()}/${date.getMonth() + 1}</div>`;
        } else {
          cell.textContent = `${day} ${date.getDate()}/${date.getMonth() + 1}`;
        }
      } else {
        cell.textContent = day;
      }
      headerRow.appendChild(cell);
    });
    grid.appendChild(headerRow);

    // Time slots (8am-6pm)
    const dayCells = {};
    for (let h = 8; h < 18; h++) {
      const row = document.createElement('div');
      row.className = 'contents';
      const timeCell = document.createElement('div');
      timeCell.className = 'calendar-time-cell p-2 border sticky left-0 z-10 font-medium';
      timeCell.textContent = `${h}:00`;
      row.appendChild(timeCell);
      for (let d = 0; d < 7; d++) {
        const cell = document.createElement('div');
        cell.className = 'p-2 border min-h-[80px] relative overflow-visible';
        cell.dataset.day = d;
        cell.dataset.hour = h;
        const key = `${d}-${h}`;
        dayCells[key] = cell;
        row.appendChild(cell);
      }
      grid.appendChild(row);
    }

    // Fetch and display bookings
    fetchBookings(weekStart, dayCells);

    // Update Today button with current day number
    const todayBtn = document.getElementById('todayBtn');
    const todayNum = new Date().getDate();
    const todayText = todayBtn.querySelector('text');
    if (todayText) {
      todayText.textContent = todayNum;
    }

    // Controls
    todayBtn.onclick = () => renderWeek(new Date());
    document.getElementById('prevWeek').onclick = () => { const d = addDays(weekStart,-7); renderWeek(d); };
    document.getElementById('nextWeek').onclick = () => { const d = addDays(weekStart,7); renderWeek(d); };
    document.getElementById('refreshBtn').onclick = () => renderWeek(weekStart); // Refresh current week
  }

  async function fetchBookings(weekStart, dayCells) {
    console.log('üîç DEBUGGING: fetchBookings called');
    console.log('üîç weekStart:', weekStart);
    console.log('üîç supabaseClient exists:', !!window.supabaseClient);
    
    if (!window.supabaseClient) {
      console.error('‚ùå Supabase client not initialized');
      const calendar = document.getElementById('calendar');
      if (calendar) {
        calendar.innerHTML = '<div class="p-4 bg-red-50 text-red-800 rounded">‚ùå Supabase client not initialized. Check console for errors.</div>';
      }
      return;
    }

    const weekEnd = addDays(weekStart, 7);
    console.log('üìÖ Fetching bookings for week:', weekStart.toISOString(), 'to', weekEnd.toISOString());
    
    // First, fetch all services to create a lookup map
    const { data: services, error: servicesError } = await window.supabaseClient
      .from('service')
      .select('code, name');
    
    const serviceMap = {};
    if (services && !servicesError) {
      services.forEach(svc => {
        serviceMap[svc.code] = svc.name;
      });
    }
    
    // Query bookings - exclude cancelled bookings
    console.log('üöÄ Fetching bookings...');
    const { data: bookings, error } = await window.supabaseClient
      .from('booking')
      .select('*')
      .gte('start_time', weekStart.toISOString())
      .lt('start_time', weekEnd.toISOString())
      .neq('status', 'cancelled')
      .order('start_time');

    if (error) {
      console.error('‚ùå Error fetching bookings:', error);
      console.log('üîç Error details:', JSON.stringify(error, null, 2));
      const weekRange = document.getElementById('weekRange');
      if (weekRange) {
        weekRange.innerHTML = `<span class="text-red-600">‚ö†Ô∏è Error loading bookings: ${error.message}</span>`;
      }
      return;
    }

    console.log(`‚úÖ Found ${bookings?.length || 0} bookings for this week:`, bookings);

    if (!bookings || bookings.length === 0) {
      console.log('‚ÑπÔ∏è No bookings found for this week');

      // Update week range
      const weekRange = document.getElementById('weekRange');
      if (weekRange) {
        const formatShortDate = (date) => {
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const year = String(date.getFullYear()).slice(-2);
          return `${day}/${month}/${year}`;
        };
        weekRange.textContent = `Week: ${formatShortDate(weekStart)} - ${formatShortDate(addDays(weekStart, 6))}`;
      }

      // Show message beside buttons
      const msg = document.getElementById('noBookingsMsg');
      if (msg) {
        msg.textContent = "No bookings found for this week";
        msg.classList.remove("hidden");
      }

      return;
    } else {
      const msg = document.getElementById('noBookingsMsg');
      if (msg) msg.classList.add("hidden");
    }

    bookings.forEach(booking => {
      const start = new Date(booking.start_time);
      const end = new Date(booking.end_time);
      
      // Database stores TIMESTAMPTZ which JavaScript converts to local browser time
      // Use local time methods since the Date object is already in browser timezone
      const dayOfWeek = start.getDay();
      const hour = start.getHours();
      const key = `${dayOfWeek}-${hour}`;
      const cell = dayCells[key];
      
      // Calculate duration in hours for spanning multiple time slots
      const durationMs = end.getTime() - start.getTime();
      const durationHours = durationMs / (1000 * 60 * 60);
      
      console.log('üìç Placing booking:', { 
        booking_id: booking.id, 
        dayOfWeek, 
        hour, 
        key, 
        hasCell: !!cell, 
        is_booking: booking.is_booking,
        durationHours: durationHours.toFixed(2)
      });
      
      if (cell) {
        const bookingDiv = document.createElement('div');
        // JavaScript Date automatically converts to browser local time
        const time = start.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
        const endTime = end.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
        
        // Calculate exact pixel height based on duration
        // Each cell is 80px min-height on desktop, 48px on mobile
        const isMobile = window.matchMedia('(max-width: 768px)').matches;
        // Determine actual rendered cell height (fallback to defaults)
        let cellHeight = isMobile ? 48 : 80;
        try {
          // Find any existing time slot cell to measure
          const sampleCell = document.querySelector('#weekGrid div.p-2.border.min-h-[80px]');
          if (sampleCell) {
            cellHeight = sampleCell.getBoundingClientRect().height || cellHeight;
          }
        } catch (e) { /* ignore measurement errors */ }
        // Desktop-only: subtract vertical padding to use the content height so 1h equals exactly one grid rectangle
        let effectiveCellHeight = cellHeight;
        if (!isMobile) {
          const cs = getComputedStyle(cell);
          const py = (parseFloat(cs.paddingTop) || 0) + (parseFloat(cs.paddingBottom) || 0);
          effectiveCellHeight = Math.max(cellHeight - py, 0);
        }
        const heightPx = durationHours * effectiveCellHeight;
        
        // Decide detail level by visual height (works for 1h/1.5h/2h)
        let detailLevel = 1;                    // ~1h
        if (heightPx >= 120) detailLevel = 2;   // ~1.5h
        if (heightPx >= 160) detailLevel = 3;   // ~2h
        
        // Calculate minutes offset from the hour for precise positioning
        const minutes = start.getMinutes();
        const minuteOffset = (minutes / 60) * effectiveCellHeight;
        
        // Use is_booking flag to determine display type
        if (booking.is_booking) {
          // This is a booking with client information - show service name
          bookingDiv.className = 'booking-card text-xs border-l-2 border-blue-600 p-1 rounded absolute left-0 right-0 z-10';
          bookingDiv.style.backgroundColor = '#bfdbfe';
          bookingDiv.style.color = '#111827';
          const padAdjust = isMobile ? 4 : 8; // subtract internal card padding so the block visually fits one rectangle
          bookingDiv.style.height = `${Math.max(heightPx - padAdjust, 4)}px`;
          bookingDiv.style.top = `${minuteOffset}px`;
          
          const serviceName = serviceMap[booking.service_code] || 'Driving Lesson';
          const clientName = [booking.first_name, booking.last_name].filter(Boolean).join(' ') || 'Unknown Client';
          
          // Determine transmission type from service code
          const transmissionType = booking.service_code?.includes('manual') ? 'Manual' : 'Automatic';
          
          // Build a compact location label for mobile
          let locationLabel = '';
          if (booking.pickup_location) {
            // Trim whitespace and remove trailing commas
            locationLabel = booking.pickup_location.trim().replace(/,+$/, '');
            // Truncate for small screens
            if (locationLabel.length > 26) {
              locationLabel = locationLabel.substring(0, 26) + '...';
            }
          }
          
          // Build HTML based on detail level
          let summaryHTML = '';
          let detailsHTML = '';
          
          if (detailLevel === 1) {
            // Compact view: desktop shows richer info; mobile minimal (transmission + duration + address)
            // Shorten 'Automatic' to 'Auto' for mobile summary
            const shortTransmission = transmissionType === 'Automatic' ? 'Auto' : transmissionType;
            const transmissionLine = `${transmissionType} - ${durationHours}h`;
            // Duration implied by block height; omit address in desktop summary to reduce duplication.
            const desktopAddress = booking.pickup_location ? `üìç ${booking.pickup_location}` : '';
            summaryHTML = `
              <div class="desktop-only font-semibold" style="color:#111827;">${transmissionLine}</div>
              <!-- Desktop summary shows address only; client name removed for space -->
              <div class="desktop-only summary-address-l1" style="color:#374151;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;line-height:1.2;">${desktopAddress}</div>
              <div class="mobile-only font-semibold" style="color:#111827;">${shortTransmission}</div>
              <div class="mobile-only" style="display:none;color:#374151;">${locationLabel}</div>
            `;
            // Details order (both desktop + mobile): Auto/Manual, Address, Client, Mobile, Time, Status
            const addressInDetailsL1 = booking.pickup_location ? `<div class=\"text-xs mb-1 details-address-l1\" style=\"color:#1e40af;\">üìç ${booking.pickup_location}</div>` : '';
            detailsHTML = `
              <div class="text-sm font-semibold mb-1" style="color:#1e40af;">${transmissionLine}</div>
              ${addressInDetailsL1}
              <div class="text-sm font-semibold mb-1" style="color:#1e40af;">${clientName}</div>
              ${booking.mobile ? `<div class=\"text-xs mb-1\" style=\"color:#1e40af;\">üì± ${booking.mobile}</div>` : ''}
              <div class="text-xs mb-1 font-medium" style="color:#1e40af;">üïê ${time} - ${endTime}</div>
              <div class="mt-1">
                <select class="booking-status-select text-xs border border-gray-300 rounded px-1 py-0.5 w-full" 
                        data-booking-id="${booking.id}" 
                        data-google-event-id="${booking.google_event_id || ''}"
                        data-original-status="${booking.status || 'confirmed'}">
                  <option value="confirmed" ${(booking.status || 'confirmed') === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                  <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Completed</option>
                  <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                  <option value="no_show" ${booking.status === 'no_show' ? 'selected' : ''}>No Show</option>
                </select>
              </div>
            `;
          } else if (detailLevel === 2) {
            // 1.5 hours: Show service, client, address (2 lines), times, mobile. Status on hover.
            summaryHTML = `
              <div class="font-semibold" style="color:#111827;">${transmissionType} - ${durationHours}h</div>
              <!-- Client name removed from web summary to prioritise address -->
              ${booking.pickup_location ? `<div class="text-xs summary-address" style="color:#374151;display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3;">üìç ${booking.pickup_location}</div>` : ''}
              <div class="text-xs mt-1 font-medium" style="color:#374151;">üïê ${time} - ${endTime}</div>
              ${booking.mobile ? `<div class="text-xs summary-mobile" style="color:#374151;">üì± ${booking.mobile}</div>` : ''}
            `;
            detailsHTML = `
              <div class="text-sm font-semibold mb-1" style="color:#111827;">${transmissionType} - ${durationHours}h</div>
              ${booking.pickup_location ? `<div class=\"text-xs mb-1\" style=\"color:#374151;\">üìç ${booking.pickup_location}</div>` : ''}
              <div class="text-sm font-semibold mb-1" style="color:#111827;">${clientName}</div>
              ${booking.mobile ? `<div class=\"text-xs mb-1\" style=\"color:#374151;\">üì± ${booking.mobile}</div>` : ''}
              <div class="mt-1">
                <select class="booking-status-select text-xs border border-gray-300 rounded px-1 py-0.5 w-full" 
                        data-booking-id="${booking.id}" 
                        data-google-event-id="${booking.google_event_id || ''}"
                        data-original-status="${booking.status || 'confirmed'}">
                  <option value="confirmed" ${(booking.status || 'confirmed') === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                  <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Completed</option>
                  <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                  <option value="no_show" ${booking.status === 'no_show' ? 'selected' : ''}>No Show</option>
                </select>
              </div>
            `;
          } else {
            // 2+ hours: Show all info including status
            summaryHTML = `
              <div class="font-semibold" style="color:#111827;">${transmissionType} - ${durationHours}h</div>
              <!-- Client name removed from web summary to prioritise address -->
              ${booking.pickup_location ? `<div class="text-xs summary-address" style="color:#374151;display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3;">üìç ${booking.pickup_location}</div>` : ''}
              <div class="text-xs mt-1 font-medium" style="color:#374151;">üïê ${time} - ${endTime}</div>
              ${booking.mobile ? `<div class="text-xs summary-mobile" style="color:#374151;">üì± ${booking.mobile}</div>` : ''}
              <div class="mt-1 desktop-only">
                <select class="booking-status-select text-xs border border-gray-300 rounded px-1 py-0.5 w-full" 
                        data-booking-id="${booking.id}" 
                        data-google-event-id="${booking.google_event_id || ''}"
                        data-original-status="${booking.status || 'confirmed'}">
                  <option value="confirmed" ${(booking.status || 'confirmed') === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                  <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Completed</option>
                  <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                  <option value="no_show" ${booking.status === 'no_show' ? 'selected' : ''}>No Show</option>
                </select>
              </div>
            `;
            detailsHTML = `
              <div class="text-sm font-semibold mb-1" style="color:#111827;">${transmissionType} - ${durationHours}h</div>
              ${booking.pickup_location ? `<div class=\"text-xs mb-1\" style=\"color:#374151;\">üìç ${booking.pickup_location}</div>` : ''}
              <div class="text-sm font-semibold mb-1" style="color:#111827;">${clientName}</div>
              ${booking.mobile ? `<div class=\"text-xs mb-1\" style=\"color:#374151;\">üì± ${booking.mobile}</div>` : ''}
              <div class="mt-1">
                <select class="booking-status-select text-xs border border-gray-300 rounded px-1 py-0.5 w-full" 
                        data-booking-id="${booking.id}" 
                        data-google-event-id="${booking.google_event_id || ''}"
                        data-original-status="${booking.status || 'confirmed'}">
                  <option value="confirmed" ${(booking.status || 'confirmed') === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                  <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Completed</option>
                  <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                  <option value="no_show" ${booking.status === 'no_show' ? 'selected' : ''}>No Show</option>
                </select>
              </div>
            `;
          }
          
          bookingDiv.innerHTML = `
            <div class="booking-card-content">
              <div class="booking-card-text">
                <div class="booking-summary">
                  ${summaryHTML}
                </div>
                ${detailsHTML ? `<div class="booking-details">${detailsHTML}</div>` : ''}
              </div>
              <button class="booking-cancel-btn" data-booking-id="${booking.id}" data-google-event-id="${booking.google_event_id || ''}" title="Cancel booking" aria-label="Cancel booking">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="15" y1="9" x2="9" y2="15"></line>
                  <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
              </button>
            </div>
          `;
        } else {
          // This is a regular calendar appointment - show title and times
          bookingDiv.className = 'booking-card text-xs border-l-2 border-gray-400 p-1 rounded absolute left-0 right-0 z-10';
          bookingDiv.style.backgroundColor = '#f3f4f6';
          bookingDiv.style.color = '#374151';
          const padAdjust2 = isMobile ? 4 : 8;
          bookingDiv.style.height = `${Math.max(heightPx - padAdjust2, 4)}px`;
          bookingDiv.style.top = `${minuteOffset}px`;
          
          const eventTitle = booking.event_title || 'Appointment';
          
          bookingDiv.innerHTML = `
            <div class="booking-card-content">
              <div class="booking-card-text">
                <div class="font-semibold" style="color:#374151;">${eventTitle}</div>
                <div class="booking-time" style="color:#374151;">${time} - ${endTime}</div>
              </div>
              <button class="booking-cancel-btn" data-booking-id="${booking.id}" data-google-event-id="${booking.google_event_id || ''}" data-event-title="${eventTitle}" title="Cancel event" aria-label="Cancel event">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="15" y1="9" x2="9" y2="15"></line>
                  <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
              </button>
            </div>
          `;
        }
        
        cell.appendChild(bookingDiv);
      }
    });

    // Add event listeners to all status dropdowns
    document.querySelectorAll('.booking-status-select').forEach(select => {
      select.addEventListener('change', async function(e) {
        const bookingId = this.getAttribute('data-booking-id');
        const originalStatus = this.getAttribute('data-original-status');
        const newStatus = this.value;
        
        console.log(`[calendar] Status change: booking ${bookingId} from ${originalStatus} to ${newStatus}`);
        
        // If changing to cancelled, show confirmation modal
        if (newStatus === 'cancelled') {
          // Check if Modal is available
          if (window.Modal && window.Modal.confirm) {
            window.Modal.confirm(
              'Are you sure you want to cancel this booking?',
              async () => {
                // User confirmed - proceed with cancellation
                await handleBookingCancellation(this, bookingId, originalStatus);
              },
              () => {
                // User cancelled - revert to original status
                console.log('[calendar] Cancellation cancelled, reverting to:', originalStatus);
                this.value = originalStatus;
              },
              'Cancel Booking'
            );
          } else {
            // Fallback to native confirm if Modal not loaded
            if (confirm('Are you sure you want to cancel this booking?')) {
              await handleBookingCancellation(this, bookingId, originalStatus);
            } else {
              this.value = originalStatus;
            }
          }
        } else {
          // For other status changes, update immediately
          await updateBookingStatus(this, bookingId, newStatus, originalStatus);
        }
      });
    });
    
    // Add event listeners to all cancel buttons
    document.querySelectorAll('.booking-cancel-btn').forEach(btn => {
      btn.addEventListener('click', async function(e) {
        e.stopPropagation(); // Prevent card expansion on mobile
        
        const bookingId = this.getAttribute('data-booking-id');
        const googleEventId = this.getAttribute('data-google-event-id');
        const eventTitle = this.getAttribute('data-event-title');
        
        // Check if this is a regular event (has event-title) or a booking
        const isRegularEvent = !!eventTitle;
        
        console.log(`[calendar] Cancel button clicked for ${isRegularEvent ? 'event' : 'booking'} ${bookingId}`);
        
        // Show confirmation modal with appropriate message
        const confirmMessage = isRegularEvent 
          ? `Are you sure you want to cancel "${eventTitle}"?`
          : 'Are you sure you want to cancel this booking?';
        const confirmTitle = isRegularEvent ? 'Cancel Event' : 'Cancel Booking';
        
        if (window.Modal && window.Modal.confirm) {
          window.Modal.confirm(
            confirmMessage,
            async () => {
              // User confirmed - proceed with cancellation
              await handleBookingCancellation(this, bookingId, null, googleEventId);
            },
            null,
            confirmTitle
          );
        } else {
          // Fallback to native confirm if Modal not loaded
          if (confirm(confirmMessage)) {
            await handleBookingCancellation(this, bookingId, null, googleEventId);
          }
        }
      });
    });
    
    // Wrap mobile setup in a function so it can be called on resize
    function setupMobileInteractions() {
      const isMobile = window.matchMedia('(max-width: 768px)').matches;
      const viewportWidth = window.innerWidth;
      console.log('[mobile] Viewport width:', viewportWidth, 'isMobile:', isMobile);
      
      if (!isMobile) {
        console.log('[mobile] Not mobile, skipping mobile interactions setup');
        return;
      }
      
      console.log('[mobile] Setting up mobile interactions');
      
      // Create backdrop element
      let backdrop = document.getElementById('booking-backdrop');
      if (!backdrop) {
        backdrop = document.createElement('div');
        backdrop.id = 'booking-backdrop';
        backdrop.className = 'booking-backdrop';
        document.body.appendChild(backdrop);
        console.log('[mobile] Created backdrop element');
      }
      
      const cards = document.querySelectorAll('#section-calendar .booking-card');
      console.log('[mobile] Found', cards.length, 'booking cards');
      
      if (cards.length === 0) {
        // No cards yet - calendar may still be loading, this is normal
        return;
      }
      
      // Function to close all active bookings
      const closeAllBookings = () => {
        cards.forEach(c => {
          c.classList.remove('booking-active');
          // Temporarily disable pointer events to clear hover state
          c.style.pointerEvents = 'none';
          setTimeout(() => { c.style.pointerEvents = ''; }, 10);
        });
        backdrop.classList.remove('active');
        // Remove any injected close buttons to restore compact layout
        document.querySelectorAll('#section-calendar .booking-close-btn').forEach(btn => btn.remove());
      };
      
      // Remove existing backdrop listeners by replacing it
      const newBackdrop = backdrop.cloneNode(true);
      backdrop.parentNode.replaceChild(newBackdrop, backdrop);
      backdrop = newBackdrop;
      
      // Click backdrop to close
      backdrop.addEventListener('click', closeAllBookings);
      
      // Click calendar grid to close popup - use event delegation
      const calendar = document.getElementById('calendar');
      if (calendar) {
        // Remove old flag to allow re-adding listener
        if (calendar.dataset.mobileListenerAdded) {
          console.log('[mobile] Calendar listener already exists, skipping');
        } else {
          calendar.dataset.mobileListenerAdded = 'true';
          calendar.addEventListener('click', (e) => {
            // Only close if clicking the calendar itself or a grid cell, not a booking card
            if (!e.target.closest('.booking-card')) {
              const backdrop = document.getElementById('booking-backdrop');
              if (backdrop && backdrop.classList.contains('active')) {
                const cards = document.querySelectorAll('#section-calendar .booking-card');
                cards.forEach(c => {
                  c.classList.remove('booking-active');
                  // Temporarily disable pointer events to clear hover state
                  c.style.pointerEvents = 'none';
                  setTimeout(() => { c.style.pointerEvents = ''; }, 10);
                });
                backdrop.classList.remove('active');
                document.querySelectorAll('#section-calendar .booking-close-btn').forEach(btn => btn.remove());
              }
            }
          });
        }
      }
      
      // Clone each card to remove old event listeners, then add new ones
      cards.forEach((card, index) => {
        // Check if this card already has the listener
        if (card.dataset.mobileListenerAdded) {
          console.log('[mobile] Card', index, 'already has listener, skipping');
          return;
        }
        
        card.dataset.mobileListenerAdded = 'true';
        card.addEventListener('click', (e) => {
          console.log('[mobile] Card clicked');
          // Ignore clicks on the status dropdowns, close button, or cancel button
          if (e.target.closest('.booking-status-select')) return;
          if (e.target.closest('.booking-close-btn')) return;
          if (e.target.closest('.booking-cancel-btn')) return;

          e.stopPropagation();

          // Close others
          const allCards = document.querySelectorAll('#section-calendar .booking-card');
          allCards.forEach(c => {
            if (c !== card) c.classList.remove('booking-active');
          });

          // Toggle this one
          const isOpening = !card.classList.contains('booking-active');
          card.classList.toggle('booking-active');
          console.log('[mobile] Card toggled, isOpening:', isOpening);
          
          // Show/hide backdrop
          if (isOpening) {
            backdrop.classList.add('active');
            
            // Add close button if not already present
            if (!card.querySelector('.booking-close-btn')) {
              const closeBtn = document.createElement('button');
              closeBtn.className = 'booking-close-btn';
              closeBtn.innerHTML = '√ó';
              closeBtn.setAttribute('aria-label', 'Close');
              closeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                closeAllBookings();
              });
              card.appendChild(closeBtn);
            }
          } else {
            backdrop.classList.remove('active');
            // Remove close button on closing this card
            const btn = card.querySelector('.booking-close-btn');
            if (btn) btn.remove();
          }
        });
      });
    }
    
    // Mobile: tap a blue block to toggle details
    setupMobileInteractions();
    
    // Handle window resize to clean up states when switching between desktop/mobile
    let resizeTimeout;
    let wasMobile = window.matchMedia('(max-width: 768px)').matches;
    
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        const isMobile = window.matchMedia('(max-width: 768px)').matches;
        const cards = document.querySelectorAll('#section-calendar .booking-card');
        const backdrop = document.getElementById('booking-backdrop');
        
        if (!isMobile) {
          // Switching to desktop: clean up mobile popup states
          cards.forEach(c => {
            c.classList.remove('booking-active');
            // Remove mobile listener flag so it can be re-added when switching back to mobile
            delete c.dataset.mobileListenerAdded;
          });
          if (backdrop) backdrop.classList.remove('active');
          document.querySelectorAll('#section-calendar .booking-close-btn').forEach(btn => btn.remove());
          
          // Clear calendar listener flag
          const calendar = document.getElementById('calendar');
          if (calendar) delete calendar.dataset.mobileListenerAdded;
          
          // If we just switched from mobile to desktop, refresh the calendar to recalculate heights
          if (wasMobile && !isMobile) {
            console.log('[calendar] Switched from mobile to desktop - refreshing calendar');
            renderWeek(weekStart);
          }
        } else if (wasMobile !== isMobile) {
          // Switching to mobile: re-setup mobile interactions and clean up
          console.log('[calendar] Switched from desktop to mobile - setting up mobile interactions');
          document.querySelectorAll('#section-calendar .booking-close-btn').forEach(btn => btn.remove());
          if (backdrop) backdrop.classList.remove('active');
          
          // Force remove hover states by temporarily disabling pointer events
          cards.forEach(c => {
            c.style.pointerEvents = 'none';
          });
          setTimeout(() => {
            cards.forEach(c => {
              c.style.pointerEvents = '';
            });
          }, 50);
          
          // Re-setup mobile interactions for existing cards
          setupMobileInteractions();
        }
        
        // Update the previous state
        wasMobile = isMobile;
      }, 100);
    });
    
    // Helper function to get current admin email
    async function getAdminEmail() {
      if (!window.supabaseClient) {
        console.error('[calendar] getAdminEmail: supabaseClient not available');
        return null;
      }
      
      try {
        const { data: { session } } = await window.supabaseClient.auth.getSession();
        return session?.user?.email || null;
      } catch (error) {
        console.error('[calendar] Error getting admin email:', error);
        return null;
      }
    }
    
    // Helper function to handle booking cancellation (used by both cancel button and status change)
    async function handleBookingCancellation(element, bookingId, originalStatus = null, googleEventId = null) {
      // Get google event ID from element if not provided
      if (!googleEventId && element.hasAttribute('data-google-event-id')) {
        googleEventId = element.getAttribute('data-google-event-id');
      }
      
      // Get admin email
      const adminEmail = await getAdminEmail();
      
      // Disable the element while processing
      const isDropdown = element.tagName === 'SELECT';
      const originalBg = element.style.backgroundColor;
      if (isDropdown) {
        element.style.backgroundColor = '#fef3c7'; // yellow-100
      }
      element.disabled = true;
      
      try {
        // Use the shared Google Calendar cancellation function
        if (window.GoogleCalendar && window.GoogleCalendar.cancelBooking) {
          const result = await window.GoogleCalendar.cancelBooking(bookingId, googleEventId, adminEmail);
          
          if (!result.success) {
            throw new Error(result.error || 'Failed to cancel booking');
          }
          
          console.log('[calendar] ‚úÖ Booking cancelled successfully');
          
          // If this is a status dropdown, update its state
          if (isDropdown) {
            element.setAttribute('data-original-status', 'cancelled');
            element.value = 'cancelled';
            element.style.backgroundColor = '#d1fae5'; // green-100
          }
          
          // Refresh the calendar after a short delay to show the updated state
          setTimeout(() => {
            console.log('[calendar] Refreshing calendar view after cancellation...');
            renderWeek(weekStart);
          }, 1500);
        } else {
          throw new Error('GoogleCalendar not available');
        }
      } catch (err) {
        console.error('[calendar] Exception cancelling booking:', err);
        
        // If this is a status dropdown and we have an original status, revert to it
        if (isDropdown && originalStatus) {
          element.value = originalStatus;
        }
        
        if (window.Modal && window.Modal.error) {
          window.Modal.error('Failed to cancel booking: ' + err.message);
        } else {
          alert('Failed to cancel booking: ' + err.message);
        }
        
        if (isDropdown) {
          element.style.backgroundColor = '#fee2e2'; // red-100
        }
      } finally {
        element.disabled = false;
        
        // Restore original background after delay (only for dropdowns)
        if (isDropdown) {
          setTimeout(() => {
            element.style.backgroundColor = originalBg;
          }, 2000);
        }
      }
    }
    
    // Helper function to update booking status
    async function updateBookingStatus(selectElement, bookingId, newStatus, originalStatus) {
      const originalBg = selectElement.style.backgroundColor;
      selectElement.style.backgroundColor = '#fef3c7'; // yellow-100
      selectElement.disabled = true;
      
      try {
        // If cancelling, use Google Calendar integration with admin email tracking
        if (newStatus === 'cancelled') {
          const googleEventId = selectElement.getAttribute('data-google-event-id');
          await handleBookingCancellation(selectElement, bookingId, originalStatus, googleEventId);
          return; // handleBookingCancellation manages the rest
        }
        
        // For non-cancellation status changes, update database directly
        const { error } = await window.supabaseClient
          .from('booking')
          .update({ status: newStatus })
          .eq('id', bookingId);
        
        if (error) {
          console.error('[calendar] Error updating status:', error);
          selectElement.value = originalStatus;
          alert('Failed to update booking status: ' + error.message);
          selectElement.style.backgroundColor = '#fee2e2'; // red-100
        } else {
          console.log('[calendar] ‚úÖ Status updated successfully');
          selectElement.setAttribute('data-original-status', newStatus);
          selectElement.style.backgroundColor = '#d1fae5'; // green-100
          
          setTimeout(() => {
            selectElement.style.backgroundColor = originalBg;
          }, 1000);
        }
      } catch (err) {
        console.error('[calendar] Exception updating status:', err);
        selectElement.value = originalStatus;
        alert('Failed to update booking status: ' + err.message);
        selectElement.style.backgroundColor = '#fee2e2'; // red-100
      } finally {
        selectElement.disabled = false;
      }
    }
  }

  // Initialize calendar when this partial loads
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => renderWeek(new Date()));
  } else {
    renderWeek(new Date());
  }
})();
</script>
