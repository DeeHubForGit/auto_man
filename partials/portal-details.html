<div class="bg-white rounded-2xl border shadow-sm">
  <!-- Header -->
  <div class="px-6 py-4 border-b flex items-center justify-between gap-3">
    <div>
      <h2 class="text-2xl font-bold text-gray-900">My Details</h2>
      <p class="text-sm text-gray-600 mt-1">Manage your personal information and preferences</p>
    </div>
    <div>
      <button
        type="submit"
        form="clientDetailsForm"
        class="px-5 py-2.5 btn-primary rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
        Save
      </button>
    </div>
  </div>

  <!-- Form -->
  <form id="clientDetailsForm" class="p-6 space-y-6" novalidate>
    
    <!-- Personal Information -->
    <div>
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Personal Information</h3>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" for="firstName">
            First Name <span class="text-red-500">*</span>
          </label>
          <input 
            type="text" 
            id="firstName" 
            name="first_name"
            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            required
          />
          <p id="firstNameError" class="text-xs text-red-500 mt-1 hidden"></p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" for="lastName">
            Last Name <span class="text-red-500">*</span>
          </label>
          <input 
            type="text" 
            id="lastName" 
            name="last_name"
            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            required
          />
          <p id="lastNameError" class="text-xs text-red-500 mt-1 hidden"></p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" for="mobile">
            Mobile Number <span class="text-red-500">*</span>
          </label>
          <input 
            type="tel" 
            id="mobile" 
            name="mobile"
            placeholder="04XX XXX XXX"
            inputmode="tel"
            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            required
          />
          <p id="mobileError" class="text-xs text-red-500 mt-1 hidden"></p>
          <p class="text-xs text-gray-500 mt-1">For lesson reminders and updates</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" for="learnerPermitNumber">
            License/Permit Number
          </label>
          <input 
            type="text" 
            id="learnerPermitNumber" 
            name="learner_permit_number"
            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>
      </div>
    </div>

    <!-- Emergency Contact -->
    <div class="pt-6 border-t">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Emergency Contact</h3>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" for="emergencyContactName">
            Contact Name
          </label>
          <input 
            type="text" 
            id="emergencyContactName" 
            name="emergency_contact_name"
            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" for="emergencyContactPhone">
            Contact Phone
          </label>
          <input 
            type="tel" 
            id="emergencyContactPhone" 
            name="emergency_contact_phone"
            inputmode="tel"
            placeholder="0403 632 313 or (03) 9876 5432"
            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
          <p id="emergencyContactPhoneError" class="text-xs text-red-500 mt-1 hidden"></p>
        </div>
      </div>
    </div>

    <!-- Medical & Learning Needs -->
    <div class="pt-6 border-t">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Medical & Learning Information</h3>
      
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2" for="medicalConditions">
          Medical Conditions
        </label>
        <textarea 
          id="medicalConditions" 
          name="medical_conditions"
          rows="3"
          placeholder="Please list any medical conditions we should be aware of (e.g., epilepsy, diabetes, anxiety)"
          class="w-full border border-gray-300 rounded-lg px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        ></textarea>
        <p class="text-xs text-gray-500 mt-1">This information helps us provide better support during lessons</p>
      </div>

      <div class="space-y-3">
        <label class="flex items-start gap-3 cursor-pointer">
          <input 
            type="checkbox" 
            id="isBeginner" 
            name="is_beginner"
            class="mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
          />
          <div>
            <span class="text-sm font-medium text-gray-900">I am a complete beginner</span>
            <p class="text-xs text-gray-500">We'll start with the basics and build your confidence</p>
          </div>
        </label>

        <label class="flex items-start gap-3 cursor-pointer">
          <input 
            type="checkbox" 
            id="isAnxiousNervous" 
            name="is_anxious_nervous"
            class="mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
          />
          <div>
            <span class="text-sm font-medium text-gray-900">I am an anxious or nervous driver</span>
            <p class="text-xs text-gray-500">We'll provide extra support and patience</p>
          </div>
        </label>

        <label class="flex items-start gap-3 cursor-pointer">
          <input 
            type="checkbox" 
            id="isSenior" 
            name="is_senior"
            class="mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
          />
          <div>
            <span class="text-sm font-medium text-gray-900">I am a senior driver</span>
            <p class="text-xs text-gray-500">We'll provide help and support as you prepare for a retest</p>
          </div>
        </label>
      </div>

      <div class="mt-4">
        <label class="flex items-start gap-3 cursor-pointer">
          <input 
            type="checkbox" 
            id="hasOtherLearningNeeds" 
            name="has_other_learning_needs"
            class="mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
            onchange="toggleOtherLearningNeeds()"
          />
          <div class="flex-1">
            <span class="text-sm font-medium text-gray-900">I have other learning needs or preferences</span>
            <p class="text-xs text-gray-500 mb-2">Please tell us anything else that would help us tailor your lessons</p>
            <input 
              type="text" 
              id="learningNeedsOther" 
              name="learning_needs_other"
              disabled
              placeholder="Please specify..."
              class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm text-black focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed"
            />
          </div>
        </label>
      </div>
    </div>

    <!-- Notes -->
    <div class="pt-6 border-t">
      <label class="block text-sm font-medium text-gray-700 mb-2" for="notes">
        Additional Notes
      </label>
      <textarea 
        id="notes" 
        name="notes"
        rows="3"
        placeholder="Any other information you'd like to share"
        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
      ></textarea>
    </div>

    <!-- Action Buttons -->
    <div class="flex gap-3 pt-6">
      <button 
        type="submit" 
        class="px-6 py-3 btn-primary rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
      >
        Save
      </button>
    </div>

    <p class="text-xs text-gray-500">
      <span class="text-red-500">*</span> Required fields
    </p>
  </form>
</div>

<script>
  // Load client details when data is available
  window.addEventListener('clientDataLoaded', function(e) {
    loadClientDetails();
  });

  // Toggle other learning needs text input
  function toggleOtherLearningNeeds() {
    const checkbox = document.getElementById('hasOtherLearningNeeds');
    const textbox = document.getElementById('learningNeedsOther');
    textbox.disabled = !checkbox.checked;
    if (checkbox.checked) {
      textbox.focus();
    } else {
      textbox.value = '';
    }
  }
  window.toggleOtherLearningNeeds = toggleOtherLearningNeeds;

  // Per-field validation on blur
  document.getElementById('mobile').addEventListener('blur', function(){
    const v = this.value.trim();
    if (!v) {
      showError('mobile','mobileError','Mobile number is required');
    } else if (!Validation.isValidAuMobile(v)) {
      showError('mobile','mobileError','Enter a valid AU mobile (e.g. 04XX XXX XXX or +61 4XX XXX XXX)');
    } else {
      clearError('mobile','mobileError');
      // Snap formatting to display format
      const stored = Validation.normaliseMobileForStorage(v);
      this.value = Validation.formatAuMobileDisplay(stored);
    }
  });
  document.getElementById('emergencyContactPhone').addEventListener('blur', function(){
    const v = this.value.trim();
    if (!v) { 
      clearError('emergencyContactPhone','emergencyContactPhoneError'); 
      return; 
    }
    const stored = Validation.normalisePhoneForStorage(v);
    if (!stored) {
      showError('emergencyContactPhone','emergencyContactPhoneError','Enter a valid Australian mobile (04XX XXX XXX) or landline (0X XXXX XXXX)');
    } else {
      clearError('emergencyContactPhone','emergencyContactPhoneError');
      // Snap formatting to display format
      this.value = Validation.formatAuPhoneDisplay(stored);
    }
  });

  function loadClientDetails() {
    if (!window.clientData) return;

    const data = window.clientData;
    
    // Populate form fields
    document.getElementById('firstName').value = data.first_name || '';
    document.getElementById('lastName').value = data.last_name || '';
    document.getElementById('mobile').value = Validation.formatAuMobileDisplay(data.mobile || '');
    document.getElementById('learnerPermitNumber').value = data.learner_permit_number || '';
    document.getElementById('emergencyContactName').value = data.emergency_contact_name || '';
    document.getElementById('emergencyContactPhone').value = Validation.formatAuPhoneDisplay(data.emergency_contact_phone || '');
    document.getElementById('medicalConditions').value = data.medical_conditions || '';
    document.getElementById('isAnxiousNervous').checked = data.is_anxious_nervous || false;
    document.getElementById('isBeginner').checked = data.is_beginner || false;
    document.getElementById('isSenior').checked = data.is_senior || false;
    
    // Handle other learning needs checkbox and text
    const hasOther = data.learning_needs_other ? true : false;
    document.getElementById('hasOtherLearningNeeds').checked = hasOther;
    document.getElementById('learningNeedsOther').value = data.learning_needs_other || '';
    document.getElementById('learningNeedsOther').disabled = !hasOther;
    
    document.getElementById('notes').value = data.notes || '';
  }

  // Validation helper functions
  function showError(fieldId, errorId, message) {
    console.log('Showing error for', fieldId, ':', message);
    const field = document.getElementById(fieldId);
    const error = document.getElementById(errorId);
    
    if (!field || !error) {
      console.error('Field or error element not found:', fieldId, errorId);
      return;
    }
    
    field.classList.add('border-red-400');
    error.textContent = message;
    error.classList.remove('hidden');
    field.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  function clearError(fieldId, errorId) {
    const field = document.getElementById(fieldId);
    const error = document.getElementById(errorId);
    
    if (!field || !error) return;
    
    field.classList.remove('border-red-400');
    error.classList.add('hidden');
  }

  function validateClientDetailsForm(){
    // Clear all errors first
    clearError('firstName', 'firstNameError');
    clearError('lastName', 'lastNameError');
    clearError('mobile', 'mobileError');
    clearError('emergencyContactPhone', 'emergencyContactPhoneError');

    let hasError = false;

    const first = document.getElementById('firstName').value.trim();
    const last  = document.getElementById('lastName').value.trim();
    const mobile= document.getElementById('mobile').value.trim();
    const ePhone= document.getElementById('emergencyContactPhone').value.trim();

    if (!first) { showError('firstName', 'firstNameError', 'First name is required'); hasError = true; }
    if (!last)  { showError('lastName', 'lastNameError', 'Last name is required');   hasError = true; }
    
    // Mobile validation - must be valid
    if (!mobile) { 
      showError('mobile', 'mobileError', 'Mobile number is required'); 
      hasError = true; 
    } else if (!Validation.isValidAuMobile(mobile)) { 
      showError('mobile', 'mobileError', 'Enter a valid AU mobile (e.g. 04XX XXX XXX or +61 4XX XXX XXX)'); 
      hasError = true; 
    }
    
    // Emergency phone validation - must be valid if provided
    if (ePhone) {
      const storedPhone = Validation.normalisePhoneForStorage(ePhone);
      if (!storedPhone) { 
        showError('emergencyContactPhone', 'emergencyContactPhoneError', 'Enter a valid Australian mobile or landline'); 
        hasError = true; 
      }
    }

    return !hasError;
  }
  window.validateClientDetailsForm = validateClientDetailsForm;

  // Handle form submission
  document.getElementById('clientDetailsForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    // Validate all fields; block save if invalid
    if (!validateClientDetailsForm()) {
      return;
    }

    if (!window.supabaseClient || !window.currentUser) {
      Modal.error('Not authenticated. Please log in again.');
      return;
    }

    // Collect form data - normalize phone numbers to canonical storage format
    const mobileRaw = document.getElementById('mobile').value.trim();
    const emergencyPhoneRaw = document.getElementById('emergencyContactPhone').value.trim();
    
    const storedMobile = Validation.normaliseMobileForStorage(mobileRaw).value || '';
    const storedEmergencyPhone = emergencyPhoneRaw ? Validation.normalisePhoneForStorage(emergencyPhoneRaw) : null;
    
    const formData = {
      first_name: document.getElementById('firstName').value.trim(),
      last_name: document.getElementById('lastName').value.trim(),
      mobile: storedMobile, // Save canonical format (0404096768 or +61404096768)
      learner_permit_number: document.getElementById('learnerPermitNumber').value.trim() || null,
      emergency_contact_name: document.getElementById('emergencyContactName').value.trim() || null,
      emergency_contact_phone: storedEmergencyPhone, // Save canonical format (mobile or landline)
      medical_conditions: document.getElementById('medicalConditions').value.trim() || null,
      is_anxious_nervous: document.getElementById('isAnxiousNervous').checked,
      is_beginner: document.getElementById('isBeginner').checked,
      is_senior: document.getElementById('isSenior').checked,
      learning_needs_other: document.getElementById('hasOtherLearningNeeds').checked ? document.getElementById('learningNeedsOther').value.trim() : null,
      notes: document.getElementById('notes').value.trim() || null,
      updated_at: new Date().toISOString()
    };
    
    console.log('Validation passed, saving data...');

    try {
      const { data, error } = await window.supabaseClient
        .from('client')
        .update(formData)
        .eq('id', window.currentUser.id);

      if (error) throw error;

      // Update local data
      window.clientData = { ...window.clientData, ...formData };

      // Format phone displays after save
      document.getElementById('mobile').value = Validation.formatAuMobileDisplay(storedMobile);
      if (storedEmergencyPhone) {
        document.getElementById('emergencyContactPhone').value = Validation.formatAuPhoneDisplay(storedEmergencyPhone);
      }

      Modal.success('Your details have been saved successfully!', 'Details Updated');
    } catch (err) {
      console.error('Error saving details:', err);
      Modal.error('Could not save your details. Please try again.', 'Save Failed');
    }
  });
</script>
