<!-- Admin Calendar Section -->
<script src="assets/js/googleCalendar.js"></script>
<style>
  /* Scoped styles for calendar bookings - ensure dark text on light backgrounds */
  #section-calendar .booking-card {
    color: #111827 !important;
    cursor: pointer;
    transition: all 0.2s ease;
    overflow: hidden;
  }
  #section-calendar .booking-card * {
    color: #111827 !important;
  }
  #section-calendar .booking-card .booking-time {
    color: #111827 !important;
    font-weight: 600;
  }
  #section-calendar .booking-card .booking-name {
    color: #111827 !important;
  }
  #section-calendar .booking-card .booking-service {
    color: #374151 !important;
  }
  
  /* Compact view - hide details by default */
  #section-calendar .booking-card .booking-details {
    display: none;
  }
  
  /* Expanded view on hover - show full details */
  #section-calendar .booking-card:hover {
    z-index: 50 !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: scale(1.02);
    height: auto !important;
    min-height: fit-content !important;
    overflow: visible;
  }
  
  #section-calendar .booking-card:hover .booking-details {
    display: block;
  }
  
  /* Compact summary styling */
  #section-calendar .booking-summary {
    line-height: 1.2;
  }
  
  #section-calendar .booking-summary .booking-name {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  /* Ensure status dropdown is always visible in expanded state */
  #section-calendar .booking-card .booking-status-select {
    margin-top: 0.25rem;
  }
  
  /* Ensure header row and time column are visible on dark background */
  #section-calendar .calendar-header {
    color: #111827 !important;
    background-color: #f3f4f6 !important;
  }
  #section-calendar .calendar-time-cell {
    color: #111827 !important;
    background-color: #f9fafb !important;
  }
  
  /* Calendar grid cells */
  #section-calendar #weekGrid > div {
    background-color: white !important;
    border-color: #e5e7eb !important;
  }
  
  /* Calendar title and text */
  #section-calendar h2,
  #section-calendar .text-sm {
    color: #111827 !important;
  }
  
  /* Calendar navigation buttons - medium blue with white text */
  #section-calendar .calendar-nav-btn {
    background-color: #2563eb !important;
    color: white !important;
    border: 1px solid #2563eb !important;
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    font-medium: 500;
    transition: background-color 0.2s;
  }
  #section-calendar .calendar-nav-btn:hover {
    background-color: #1d4ed8 !important;
  }
</style>
<section id="section-calendar" class="section-content bg-white border rounded-2xl shadow-sm p-5" style="background-color: white !important; color: #111827 !important;">
  <!-- Week range + navigation + message -->
  <div class="flex items-center justify-between mb-3" role="group" aria-label="Calendar navigation">
    <div class="flex items-center gap-3">
      <span id="weekRange" class="text-lg font-bold text-blue-600">
        Week: 09/11/2025 - 15/11/2025
      </span>
      <div class="flex items-center gap-2">
        <button id="prevWeek" class="calendar-nav-btn !px-2 !py-1" aria-label="Previous week">‚Üê</button>
        <button id="nextWeek" class="calendar-nav-btn !px-2 !py-1" aria-label="Next week">‚Üí</button>
        <button id="todayBtn" class="calendar-nav-btn !px-3 !py-1" aria-label="Jump to today">Today</button>
      </div>
      <span id="noBookingsMsg" class="text-blue-500 font-semibold hidden ml-2">
        No bookings found for this week
      </span>
    </div>
  </div>

  <div id="calendar" class="overflow-auto max-h-[600px] relative">
    <div id="weekGrid" class="grid grid-cols-8 text-sm" style="grid-template-columns: 80px repeat(7, minmax(120px, 1fr));"></div>
  </div>
</section>

<script>
(function() {
  // Calendar logic
  function addDays(d, n) { const r = new Date(d); r.setDate(r.getDate() + n); return r; }
  let weekStart = new Date();

  function renderWeek(startDate) {
    weekStart = new Date(startDate);
    weekStart.setDate(weekStart.getDate() - weekStart.getDay());
    const grid = document.getElementById('weekGrid');
    if (!grid) return;
    grid.innerHTML = '';

    // Display week range
    const weekEnd = addDays(weekStart, 6);
    const rangeEl = document.getElementById('weekRange');
    if (rangeEl) {
      rangeEl.textContent = `Week: ${weekStart.toLocaleDateString('en-AU')} - ${weekEnd.toLocaleDateString('en-AU')}`;
    }

    // Header row with dates
    const headerRow = document.createElement('div');
    headerRow.className = 'contents';
    const days = ['Time', 'Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    days.forEach((day, idx) => {
      const cell = document.createElement('div');
      cell.className = 'calendar-header font-semibold p-2 border sticky top-0 z-10';
      if (idx === 0) cell.classList.add('left-0', 'z-20');
      if (idx > 0) {
        const date = addDays(weekStart, idx - 1);
        cell.textContent = `${day} ${date.getDate()}/${date.getMonth() + 1}`;
      } else {
        cell.textContent = day;
      }
      headerRow.appendChild(cell);
    });
    grid.appendChild(headerRow);

    // Time slots (8am-6pm)
    const dayCells = {};
    for (let h = 8; h < 18; h++) {
      const row = document.createElement('div');
      row.className = 'contents';
      const timeCell = document.createElement('div');
      timeCell.className = 'calendar-time-cell p-2 border sticky left-0 z-10 font-medium';
      timeCell.textContent = `${h}:00`;
      row.appendChild(timeCell);
      for (let d = 0; d < 7; d++) {
        const cell = document.createElement('div');
        cell.className = 'p-2 border min-h-[80px] relative overflow-visible';
        cell.dataset.day = d;
        cell.dataset.hour = h;
        const key = `${d}-${h}`;
        dayCells[key] = cell;
        row.appendChild(cell);
      }
      grid.appendChild(row);
    }

    // Fetch and display bookings
    fetchBookings(weekStart, dayCells);

    // Controls
    document.getElementById('todayBtn').onclick = () => renderWeek(new Date());
    document.getElementById('prevWeek').onclick = () => { const d = addDays(weekStart,-7); renderWeek(d); };
    document.getElementById('nextWeek').onclick = () => { const d = addDays(weekStart,7); renderWeek(d); };
  }

  async function fetchBookings(weekStart, dayCells) {
    console.log('üîç DEBUGGING: fetchBookings called');
    console.log('üîç weekStart:', weekStart);
    console.log('üîç supabaseClient exists:', !!window.supabaseClient);
    
    if (!window.supabaseClient) {
      console.error('‚ùå Supabase client not initialized');
      const calendar = document.getElementById('calendar');
      if (calendar) {
        calendar.innerHTML = '<div class="p-4 bg-red-50 text-red-800 rounded">‚ùå Supabase client not initialized. Check console for errors.</div>';
      }
      return;
    }

    const weekEnd = addDays(weekStart, 7);
    console.log('üìÖ Fetching bookings for week:', weekStart.toISOString(), 'to', weekEnd.toISOString());
    
    // First, fetch all services to create a lookup map
    const { data: services, error: servicesError } = await window.supabaseClient
      .from('service')
      .select('code, name');
    
    const serviceMap = {};
    if (services && !servicesError) {
      services.forEach(svc => {
        serviceMap[svc.code] = svc.name;
      });
    }
    
    // Query bookings - exclude cancelled bookings
    console.log('üöÄ Fetching bookings...');
    const { data: bookings, error } = await window.supabaseClient
      .from('booking')
      .select('*')
      .gte('start_time', weekStart.toISOString())
      .lt('start_time', weekEnd.toISOString())
      .neq('status', 'cancelled')
      .order('start_time');

    if (error) {
      console.error('‚ùå Error fetching bookings:', error);
      console.log('üîç Error details:', JSON.stringify(error, null, 2));
      const weekRange = document.getElementById('weekRange');
      if (weekRange) {
        weekRange.innerHTML = `<span class="text-red-600">‚ö†Ô∏è Error loading bookings: ${error.message}</span>`;
      }
      return;
    }

    console.log(`‚úÖ Found ${bookings?.length || 0} bookings for this week:`, bookings);

    if (!bookings || bookings.length === 0) {
      console.log('‚ÑπÔ∏è No bookings found for this week');

      // Update week range
      const weekRange = document.getElementById('weekRange');
      if (weekRange) {
        weekRange.textContent = `Week: ${weekStart.toLocaleDateString('en-AU')} - ${addDays(weekStart, 6).toLocaleDateString('en-AU')}`;
      }

      // Show message beside buttons
      const msg = document.getElementById('noBookingsMsg');
      if (msg) {
        msg.textContent = "No bookings found for this week";
        msg.classList.remove("hidden");
      }

      return;
    } else {
      const msg = document.getElementById('noBookingsMsg');
      if (msg) msg.classList.add("hidden");
    }

    bookings.forEach(booking => {
      const start = new Date(booking.start_time);
      const end = new Date(booking.end_time);
      const dayOfWeek = start.getDay();
      const hour = start.getHours();
      const key = `${dayOfWeek}-${hour}`;
      const cell = dayCells[key];
      
      // Calculate duration in hours for spanning multiple time slots
      const durationMs = end.getTime() - start.getTime();
      const durationHours = durationMs / (1000 * 60 * 60);
      
      console.log('üìç Placing booking:', { 
        booking_id: booking.id, 
        dayOfWeek, 
        hour, 
        key, 
        hasCell: !!cell, 
        is_booking: booking.is_booking,
        durationHours: durationHours.toFixed(2)
      });
      
      if (cell) {
        const bookingDiv = document.createElement('div');
        const time = start.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });
        const endTime = end.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });
        
        // Calculate exact pixel height based on duration
        // Each cell is 80px min-height, so calculate proportionally
        const cellHeight = 80; // matches min-h-[80px]
        const heightPx = durationHours * cellHeight;
        
        // Decide detail level by visual height (works for 1h/1.5h/2h)
        let detailLevel = 1;                    // ~1h
        if (heightPx >= 120) detailLevel = 2;   // ~1.5h
        if (heightPx >= 160) detailLevel = 3;   // ~2h
        
        // Calculate minutes offset from the hour for precise positioning
        const minutes = start.getMinutes();
        const minuteOffset = (minutes / 60) * cellHeight;
        
        // Use is_booking flag to determine display type
        if (booking.is_booking) {
          // This is a booking with client information - show service name
          bookingDiv.className = 'booking-card text-xs bg-blue-100 border-l-2 border-blue-600 p-1 rounded absolute left-0 right-0 z-10';
          bookingDiv.style.height = `${heightPx - 4}px`; // -4px for padding
          bookingDiv.style.top = `${minuteOffset}px`;
          
          const serviceName = serviceMap[booking.service_code] || 'Driving Lesson';
          const clientName = [booking.first_name, booking.last_name].filter(Boolean).join(' ') || 'Unknown Client';
          
          // Determine transmission type from service code
          const transmissionType = booking.service_code?.includes('manual') ? 'Manual' : 'Automatic';
          
          // Build HTML based on detail level
          let summaryHTML = '';
          let detailsHTML = '';
          
          if (detailLevel === 1) {
            // 1 hour: Minimal info, most in hover details
            summaryHTML = `
              <div class="font-semibold text-gray-900">${transmissionType} - ${durationHours}h</div>
              <div class="booking-name font-medium truncate">${clientName}</div>
              ${booking.pickup_location ? `<div class="text-gray-600 truncate" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">üìç ${booking.pickup_location}</div>` : ''}
            `;
            detailsHTML = `
              <div class="text-gray-700 text-xs mb-1 font-medium">üïê ${time} - ${endTime}</div>
              ${booking.mobile ? `<div class="text-gray-600 text-xs mb-1">üì± ${booking.mobile}</div>` : ''}
              <div class="mt-1">
                <select class="booking-status-select text-xs border border-gray-300 rounded px-1 py-0.5 w-full" 
                        data-booking-id="${booking.id}" 
                        data-google-event-id="${booking.google_event_id || ''}"
                        data-original-status="${booking.status || 'confirmed'}">
                  <option value="confirmed" ${(booking.status || 'confirmed') === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                  <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Completed</option>
                  <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                  <option value="no_show" ${booking.status === 'no_show' ? 'selected' : ''}>No Show</option>
                </select>
              </div>
            `;
          } else if (detailLevel === 2) {
            // 1.5 hours: Show service, client, address (2 lines), times, mobile. Status on hover.
            summaryHTML = `
              <div class="font-semibold text-gray-900">${transmissionType} - ${durationHours}h</div>
              <div class="booking-name font-medium truncate">${clientName}</div>
              ${booking.pickup_location ? `<div class="text-gray-600 text-xs" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3;">üìç ${booking.pickup_location}</div>` : ''}
              <div class="text-gray-700 text-xs mt-1 font-medium">üïê ${time} - ${endTime}</div>
              ${booking.mobile ? `<div class="text-gray-600 text-xs">üì± ${booking.mobile}</div>` : ''}
            `;
            detailsHTML = `
              <div class="mt-1">
                <select class="booking-status-select text-xs border border-gray-300 rounded px-1 py-0.5 w-full" 
                        data-booking-id="${booking.id}" 
                        data-google-event-id="${booking.google_event_id || ''}"
                        data-original-status="${booking.status || 'confirmed'}">
                  <option value="confirmed" ${(booking.status || 'confirmed') === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                  <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Completed</option>
                  <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                  <option value="no_show" ${booking.status === 'no_show' ? 'selected' : ''}>No Show</option>
                </select>
              </div>
            `;
          } else {
            // 2+ hours: Show all info including status
            summaryHTML = `
              <div class="font-semibold text-gray-900">${transmissionType} - ${durationHours}h</div>
              <div class="booking-name font-medium truncate">${clientName}</div>
              ${booking.pickup_location ? `<div class="text-gray-600 text-xs" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3;">üìç ${booking.pickup_location}</div>` : ''}
              <div class="text-gray-700 text-xs mt-1 font-medium">üïê ${time} - ${endTime}</div>
              ${booking.mobile ? `<div class="text-gray-600 text-xs">üì± ${booking.mobile}</div>` : ''}
              <div class="mt-1">
                <select class="booking-status-select text-xs border border-gray-300 rounded px-1 py-0.5 w-full" 
                        data-booking-id="${booking.id}" 
                        data-google-event-id="${booking.google_event_id || ''}"
                        data-original-status="${booking.status || 'confirmed'}">
                  <option value="confirmed" ${(booking.status || 'confirmed') === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                  <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Completed</option>
                  <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                  <option value="no_show" ${booking.status === 'no_show' ? 'selected' : ''}>No Show</option>
                </select>
              </div>
            `;
            detailsHTML = ''; // No additional details needed - everything is shown
          }
          
          bookingDiv.innerHTML = `
            <div class="booking-summary">
              ${summaryHTML}
            </div>
            ${detailsHTML ? `<div class="booking-details">${detailsHTML}</div>` : ''}
          `;
        } else {
          // This is a regular calendar appointment - show title and times
          bookingDiv.className = 'booking-card text-xs bg-gray-100 border-l-2 border-gray-400 p-1 rounded absolute left-0 right-0 z-10';
          bookingDiv.style.height = `${heightPx - 4}px`; // -4px for padding
          bookingDiv.style.top = `${minuteOffset}px`;
          
          const eventTitle = booking.event_title || 'Appointment';
          
          bookingDiv.innerHTML = `
            <div class="booking-time font-semibold text-gray-700">${time} - ${endTime}</div>
            <div class="text-gray-600">${eventTitle}</div>
          `;
        }
        
        cell.appendChild(bookingDiv);
      }
    });

    // Add event listeners to all status dropdowns
    document.querySelectorAll('.booking-status-select').forEach(select => {
      select.addEventListener('change', async function(e) {
        const bookingId = this.getAttribute('data-booking-id');
        const originalStatus = this.getAttribute('data-original-status');
        const newStatus = this.value;
        
        console.log(`[calendar] Status change: booking ${bookingId} from ${originalStatus} to ${newStatus}`);
        
        // If changing to cancelled, show confirmation modal
        if (newStatus === 'cancelled') {
          // Check if Modal is available
          if (window.Modal && window.Modal.confirm) {
            window.Modal.confirm(
              'Are you sure you want to cancel this booking?',
              async () => {
                // User confirmed - proceed with cancellation
                await updateBookingStatus(this, bookingId, newStatus, originalStatus);
              },
              () => {
                // User cancelled - revert to original status
                console.log('[calendar] Cancellation cancelled, reverting to:', originalStatus);
                this.value = originalStatus;
              },
              'Cancel Booking'
            );
          } else {
            // Fallback to native confirm if Modal not loaded
            if (confirm('Are you sure you want to cancel this booking?')) {
              await updateBookingStatus(this, bookingId, newStatus, originalStatus);
            } else {
              this.value = originalStatus;
            }
          }
        } else {
          // For other status changes, update immediately
          await updateBookingStatus(this, bookingId, newStatus, originalStatus);
        }
      });
    });
    
    // Helper function to update booking status
    async function updateBookingStatus(selectElement, bookingId, newStatus, originalStatus) {
      const originalBg = selectElement.style.backgroundColor;
      selectElement.style.backgroundColor = '#fef3c7'; // yellow-100
      selectElement.disabled = true;
      
      try {
        // If cancelling, use Google Calendar integration
        if (newStatus === 'cancelled') {
          const googleEventId = selectElement.getAttribute('data-google-event-id');
          
          // Use the shared Google Calendar cancellation function
          if (window.GoogleCalendar && window.GoogleCalendar.cancelBooking) {
            const result = await window.GoogleCalendar.cancelBooking(bookingId, googleEventId);
            
            if (!result.success) {
              throw new Error(result.error || 'Failed to cancel booking');
            }
            
            console.log('[calendar] ‚úÖ Booking cancelled successfully (including Google Calendar)');
            selectElement.setAttribute('data-original-status', newStatus);
            selectElement.style.backgroundColor = '#d1fae5'; // green-100
            
            // Refresh the calendar after a short delay to show the updated state
            setTimeout(() => {
              console.log('[calendar] Refreshing calendar view after cancellation...');
              if (typeof renderWeek === 'function' && window.currentWeekStart) {
                renderWeek(window.currentWeekStart);
              } else {
                // Fallback: reload the page
                window.location.reload();
              }
            }, 1500);
          } else {
            // Fallback if GoogleCalendar not loaded - just update database
            console.warn('[calendar] GoogleCalendar not available, updating database only');
            const { error } = await window.supabaseClient
              .from('booking')
              .update({ status: newStatus })
              .eq('id', bookingId);
            
            if (error) throw error;
            
            selectElement.setAttribute('data-original-status', newStatus);
            selectElement.style.backgroundColor = '#d1fae5'; // green-100
            
            // Refresh the calendar after a short delay
            setTimeout(() => {
              console.log('[calendar] Refreshing calendar view after cancellation...');
              if (typeof renderWeek === 'function' && window.currentWeekStart) {
                renderWeek(window.currentWeekStart);
              } else {
                window.location.reload();
              }
            }, 1500);
          }
        } else {
          // For non-cancellation status changes, update database directly
          const { error } = await window.supabaseClient
            .from('booking')
            .update({ status: newStatus })
            .eq('id', bookingId);
          
          if (error) {
            console.error('[calendar] Error updating status:', error);
            selectElement.value = originalStatus;
            alert('Failed to update booking status: ' + error.message);
            selectElement.style.backgroundColor = '#fee2e2'; // red-100
          } else {
            console.log('[calendar] ‚úÖ Status updated successfully');
            selectElement.setAttribute('data-original-status', newStatus);
            selectElement.style.backgroundColor = '#d1fae5'; // green-100
            
            setTimeout(() => {
              selectElement.style.backgroundColor = originalBg;
            }, 1000);
          }
        }
      } catch (err) {
        console.error('[calendar] Exception updating status:', err);
        selectElement.value = originalStatus;
        alert('Failed to update booking status: ' + err.message);
        selectElement.style.backgroundColor = '#fee2e2'; // red-100
      } finally {
        selectElement.disabled = false;
      }
    }
  }

  // Initialize calendar when this partial loads
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => renderWeek(new Date()));
  } else {
    renderWeek(new Date());
  }
})();
</script>
