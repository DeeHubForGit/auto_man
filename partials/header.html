<!-- header.html -->
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  /* Anti-flicker + reserve space so content below never jumps */
  html.loading * { transition: none !important; }
  header { min-height: 70px; }

  /* ---------- Header sizing guardrails ---------- */
  /* Stop page-level "leading-*" utilities from inflating header */
  header .nav-link,
  header nav a,
  header .btn { line-height: 1.25rem !important; } /* 20px */

  /* Consistent button height/shape in header */
  header .btn {
    height: 2.25rem;          /* 36px */
    padding: 0 1rem;          /* horizontal stays the same */
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  /* If a large button is ever placed in header, keep it tidy too */
  header .btn.btn-lg {
    height: 2.5rem;           /* 40px */
    padding: 0 1.125rem;
  }
</style>

<header class="bg-white shadow-sm sticky top-0 z-50">
  <div class="container mx-auto px-4 py-3 flex items-center justify-between gap-2">
    <!-- Left: logo + title grouped -->
    <div class="flex items-center gap-2 min-w-0 flex-shrink-0">
      <img src="images/auto-man-small-logo-website-header.png" alt="Auto-Man Driving School logo" class="h-8 w-8 flex-shrink-0" decoding="async" fetchpriority="high" />
      <!-- Full text on large screens, "Auto-Man" on small/medium -->
      <a href="index.html" class="logo text-base sm:text-lg lg:text-xl font-bold tracking-tight whitespace-nowrap" style="font-family: Tahoma, Verdana, sans-serif;">
        <span class="hidden lg:inline">Auto-Man Driving School</span>
        <span class="lg:hidden">Auto-Man</span>
      </a>
    </div>

    <!-- Desktop nav -->
    <nav class="hidden lg:flex items-center gap-4 xl:gap-6 text-sm relative flex-shrink">
      <!-- Services + dropdown -->
      <div class="relative group">
        <a id="nav-services" href="index.html#services" class="text-light-hover-blue inline-flex items-center gap-1">
          Services
          <svg aria-hidden="true" focusable="false" width="14" height="14" viewBox="0 0 20 20" class="mt-[1px]">
            <path d="M6 8l4 4 4-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </a>

        <!-- Desktop dropdown -->
        <div
          id="nav-services-menu"
          class="absolute left-0 top-full w-64 bg-white border rounded-lg shadow-lg py-2 z-50
                 hidden group-hover:block hover:block focus-within:block"
        >
          <a class="block px-4 py-2 hover:bg-blue-50" href="beginner-drivers.html">Beginner Drivers</a> 
          <a class="block px-4 py-2 hover:bg-blue-50" href="driving-test-package.html">Driving Test Package</a>
          <a class="block px-4 py-2 hover:bg-blue-50" href="overseas-licence.html">Overseas Licence Conversion</a>
          <a class="block px-4 py-2 hover:bg-blue-50" href="nervous-drivers.html">Nervous Drivers</a>
          <a class="block px-4 py-2 hover:bg-blue-50" href="senior-drivers.html">Senior Driver Retests</a>
          <a class="block px-4 py-2 hover:bg-blue-50" href="special-requirements.html">Special Requirements</a>
        </div>
      </div>

      <a href="about.html" class="text-light-hover-blue">About Us</a>
      <a href="service-areas.html" class="text-light-hover-blue">Service Areas</a>
      <a href="faq.html" class="text-light-hover-blue">FAQs</a>
      <!-- <a href="index.html#pricing" class="hover:text-blue-600">Lesson Packages</a> -->
      <a href="contact.html" class="text-light-hover-blue">Contact</a>
    </nav>

    <!-- Auth controls (middle cluster) -->
    <div class="hidden lg:flex items-center gap-2 xl:gap-3 flex-shrink-0">
      <!-- Sign Up as text link - hidden by default -->
      <a href="signup.html" id="signupBtn" 
        class="hidden md:inline-block btn btn-secondary">
        Sign Up
      </a>

      <!-- Login as button - hidden by default -->
      <a href="login.html" id="loginBtn" class="hidden md:inline-block btn btn-primary-light">Login</a>
      <!-- Log Out button (desktop) - hidden by default -->
      <button id="logoutBtnHeader" class="hidden md:inline-block btn btn-secondary">Log Out</button>
      <!-- My Account - hidden by default -->
      <a href="portal.html" id="portalBtnHeader" class="hidden md:inline-block text-light-hover-blue transition-colors">My Account</a>
      
      <!-- Admin - desktop, hidden by default -->
      <a href="admin.html" 
        id="adminBtn" 
        class="hidden md:inline-block text-white hover:text-blue-300 transition-colors">
        Admin
      </a>
    </div>

    <!-- Right: Auth, Phone, WhatsApp, Book, Menu -->
    <div class="flex items-center gap-2 xl:gap-3 flex-shrink-0">
      <!-- Sign Up - visible on mobile when not logged in -->
      <a href="signup.html" id="signupBtnMobile" 
        class="lg:hidden text-sm text-gray-700 hover:text-gray-900 text-center leading-tight" style="white-space:normal;">
        Sign<br>Up
      </a>
      
      <!-- Login - visible on mobile when not logged in -->
      <a href="login.html" id="loginBtnMobile2" 
        class="lg:hidden text-sm text-blue-dark font-medium whitespace-nowrap">
        Login
      </a>
      
      <!-- My Account - visible on mobile when logged in -->
      <a href="portal.html" id="portalBtnMobileHeader" 
        class="hidden lg:hidden text-sm text-gray-700 hover:text-gray-900 whitespace-nowrap" title="My Account">
        <span class="hidden sm:inline">My Account</span>
        <span class="sm:hidden">Acct</span>
      </a>
      
      <!-- Admin - mobile, hidden by default -->
      <a href="admin.html" 
        id="adminBtnMobile" 
        class="hidden lg:hidden text-white hover:text-blue-300 transition-colors">
        Admin
      </a>
      
      <!-- Log Out - visible on mobile when logged in -->
      <button id="logoutBtnMobileHeader" 
        class="hidden lg:hidden text-sm text-gray-700 hover:text-gray-900 p-1" title="Log Out" aria-label="Log Out">
        <i class="fa-solid fa-right-from-bracket text-lg"></i>
      </button>
      
      <!-- Phone - hidden on mobile and small tablets -->
      <a href="tel:{{PHONE_LINK}}" 
        class="hidden xl:inline-flex items-center gap-2 text-blue-dark font-semibold whitespace-nowrap">
        ðŸ“± {{PHONE}}
      </a>

      <!-- WhatsApp button - opens app on mobile, web on desktop -->
      <a href="#" onclick="window.openWhatsApp(); return false;" 
        class="btn btn-secondary whitespace-nowrap flex items-center gap-1"
        aria-label="Chat on WhatsApp">
        <i class="fa-brands fa-whatsapp text-lg" aria-hidden="true"></i>
        <span class="hidden xl:inline">WhatsApp</span>
      </a>

      <!-- Book Now - always visible, text changes by screen size -->
      <a href="booking.html"
        class="btn btn-primary btn-lg whitespace-nowrap">
        <span class="hidden sm:inline">Book Now</span>
        <span class="sm:hidden">Book</span>
      </a>
      
      <!-- Mobile menu toggle - hidden on large screens -->
      <button id="menuToggleBtn" type="button" class="lg:hidden px-3 py-2 border rounded select-none touch-manipulation z-50 pointer-events-auto" style="-webkit-tap-highlight-color: transparent;" onclick="toggleMenu()" aria-label="Toggle menu" aria-expanded="false" aria-controls="mobileMenu" role="button">â˜°</button>
    </div>
  </div>

  <!-- Mobile Nav -->
  <div id="mobileMenu"
      class="lg:hidden hidden fixed inset-x-0 top-[70px] z-50 bg-white text-slate-900 border-t shadow-lg max-h-[calc(100vh-70px)] overflow-y-auto">
    <nav class="px-4 py-3 flex flex-col gap-2 text-base">
      <!-- Services (collapsible) -->
      <button id="mobileServicesBtn"
            type="button"
            class="flex items-center justify-between w-full py-2 font-medium"
            aria-controls="mobileServicesSubmenu"
            aria-expanded="false"
            onclick="(function(e){e.preventDefault();e.stopPropagation();var s=document.getElementById('mobileServicesSubmenu');var btn=document.getElementById('mobileServicesBtn');if(!s||!btn)return false;var hidden=s.classList.toggle('hidden');if(!hidden){s.classList.add('block');}else{s.classList.remove('block');}btn.setAttribute('aria-expanded', hidden?'false':'true');var c=btn.querySelector('[data-caret]');if(c)c.classList.toggle('rotate-180',!hidden);return false;})(event)">
        <span>Services</span>
        <span data-caret class="transition-transform transform">â–¼</span>
      </button>

      <div id="mobileServicesSubmenu" class="hidden pl-3 border-l flex flex-col gap-2">
        <a class="block py-1 hover:underline" href="index.html#services" onclick="window.closeMenu?window.closeMenu():null">All Services</a>
        <a class="block py-1 hover:underline" href="beginner-drivers.html" onclick="window.closeMenu?window.closeMenu():null">Beginner Drivers</a>
        <a class="block py-1 hover:underline" href="driving-test-package.html" onclick="window.closeMenu?window.closeMenu():null">Driving Test Package</a>
        <a class="block py-1 hover:underline" href="overseas-licence.html" onclick="window.closeMenu?window.closeMenu():null">Overseas Licence Conversion</a>
        <a class="block py-1 hover:underline" href="nervous-drivers.html" onclick="window.closeMenu?window.closeMenu():null">Nervous Drivers</a>
        <a class="block py-1 hover:underline" href="senior-drivers.html" onclick="window.closeMenu?window.closeMenu():null">Senior Driver Retests</a>
        <a class="block py-1 hover:underline" href="special-requirements.html" onclick="window.closeMenu?window.closeMenu():null">Special Requirements</a>
      </div>

      <a class="block py-2 hover:underline" href="about.html" onclick="window.closeMenu?window.closeMenu():null">About Us</a>
      <a class="block py-2 hover:underline" href="service-areas.html" onclick="window.closeMenu?window.closeMenu():null">Service Areas</a>
      <a class="block py-2 hover:underline" href="faq.html" onclick="window.closeMenu?window.closeMenu():null">FAQs</a>
      <a class="block py-2 hover:underline" href="contact.html" onclick="window.closeMenu?window.closeMenu():null">Contact</a>
      
      <!-- Phone -->
      <a href="tel:{{PHONE_LINK}}"
        class="flex items-center gap-2 py-2 font-semibold text-blue-dark"
        onclick="window.closeMenu?window.closeMenu():null">ðŸ“± Call {{PHONE}}</a>
    </nav>
    
    <!-- Close handle at bottom -->
    <div class="flex justify-center py-3 border-t border-gray-200 bg-gray-50">
      <button onclick="window.closeMenu?window.closeMenu():null" class="w-12 h-1 bg-gray-400 rounded-full hover:bg-gray-500 transition-colors" aria-label="Close menu"></button>
    </div>
  </div>

</header>

<script>
// WhatsApp launcher function
window.openWhatsApp = function() {
  const phone = "61403632313";
  const isMobile = /Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);

  if (isMobile) {
    // Mobile â†’ try to open WhatsApp app directly
    window.location.href = `whatsapp://send?phone=${phone}`;
  } else {
    // Desktop â†’ go straight to WhatsApp Web chat
    window.open(`https://web.whatsapp.com/send?phone=${phone}`, '_blank');
  }
};

// Anti-flicker: disable transitions on first paint
document.documentElement.classList.add('loading');
addEventListener('DOMContentLoaded', () =>
  requestAnimationFrame(() => document.documentElement.classList.remove('loading'))
);

// Global logout function - resilient with direct API fallback
window.headerLogout = function headerLogout() {
  // Wait for Modal to be available
  if (window.Modal && window.Modal.confirm) {
    window.Modal.confirm(
      'Are you sure you want to log out?',
      window.performLogout,
      null,
      'Log Out'
    );
  } else {
    // Modal not loaded yet, wait a bit and try again
    setTimeout(function() {
      if (window.Modal && window.Modal.confirm) {
        window.Modal.confirm(
          'Are you sure you want to log out?',
          window.performLogout,
          null,
          'Log Out'
        );
      } else {
        // Fallback: just logout without confirmation
        console.warn('[logout] Modal not available, logging out without confirmation');
        window.performLogout();
      }
    }, 100);
  }
};

// Actual logout implementation - make it global so Modal callback can access it
window.performLogout = async function performLogout() {
  const url = window.SUPABASE_URL || window.supabaseUrl || (window.supabaseClient && window.supabaseClient.rest && window.supabaseClient.rest.url?.replace('/rest/v1','').replace(/^\/+|\/+$/g,''));
  const key = window.SUPABASE_ANON_KEY || window.supabaseAnonKey;

  try {
    const { data: { session } } = await window.supabaseClient.auth.getSession().catch(() => ({data:{}}));

    // Try server logout (2s max). If this stalls we still continue.
    if (session?.access_token && url && key) {
      await Promise.race([
        fetch(`${url}/auth/v1/logout`, {
          method: 'POST',
          headers: { apikey: key, Authorization: `Bearer ${session.access_token}` },
          keepalive: true  // improves chances during navigation
        }),
        new Promise((_, rej) => setTimeout(() => rej(new Error('signOut timeout')), 2000))
      ]).catch(err => console.warn('[logout] server logout issue:', err?.message || err));
    } else {
      // Fallback to SDK with a 2s cap
      await Promise.race([
        window.supabaseClient.auth.signOut({ scope: 'global' }),
        new Promise((_, rej) => setTimeout(() => rej(new Error('SDK signOut timeout')), 2000))
      ]).catch(err => console.warn('[logout] SDK logout issue:', err?.message || err));
    }
  } finally {
    // Local cleanup (always)
    try {
      Object.keys(localStorage).forEach(k => {
        if (k.startsWith('sb-') || k.includes('supabase')) localStorage.removeItem(k);
      });
    } catch {}

    // Optional: notify other tabs
    try { localStorage.setItem('sb-signout', String(Date.now())); } catch {}

    // Go home
    window.location.href = 'index.html';
  }
};

(function() {

    let headerHasRendered = false;

    function revealHeaderOnce() {
      if (headerHasRendered) return;
      headerHasRendered = true;

      const hc = document.getElementById('header-container');
      if (hc) hc.classList.remove('hydrating');
    }

  // Wait for everything to be ready before initializing
  function waitForReady() {

    // Check if all dependencies are ready
    if (document.readyState === 'loading' || !window.supabaseClient) {
      setTimeout(waitForReady, 100);
      return;
    }
    init();
  }

  function init() {

    // ---------- Auth state (await authReady + bind once) ----------
    function setVisible(el, show) {
      if (!el) return;
      const id = el.id || '(no id)';

      if (show) {
        // Remove hidden class and restore display
        el.classList.remove('hidden');
        el.classList.remove('md:hidden');
        el.style.display = '';
        el.setAttribute('aria-hidden', 'false');
      } else {
        // Hide the element
        el.classList.add('hidden');
        el.classList.add('md:hidden');
        el.style.display = 'none';
        el.setAttribute('aria-hidden', 'true');
      }

    }

    async function updateHeaderAuth() {
      const signupBtn        = document.getElementById('signupBtn');
      const loginBtn         = document.getElementById('loginBtn');
      const portalBtnHeader  = document.getElementById('portalBtnHeader');
      const logoutBtnHeader  = document.getElementById('logoutBtnHeader');
      const adminBtn         = document.getElementById('adminBtn');

      const signupBtnMobile        = document.getElementById('signupBtnMobile');
      const loginBtnMobile2        = document.getElementById('loginBtnMobile2');
      const portalBtnMobileHeader  = document.getElementById('portalBtnMobileHeader');
      const logoutBtnMobileHeader  = document.getElementById('logoutBtnMobileHeader');
      const adminBtnMobile         = document.getElementById('adminBtnMobile');

      function applyLoggedOut() {
        // Desktop
        setVisible(signupBtn, true);
        setVisible(loginBtn,  true);
        setVisible(portalBtnHeader, false);
        setVisible(logoutBtnHeader, false);
        setVisible(adminBtn, false);

        // Mobile
        setVisible(signupBtnMobile, true);
        setVisible(loginBtnMobile2, true);
        setVisible(portalBtnMobileHeader, false);
        setVisible(logoutBtnMobileHeader, false);
        setVisible(adminBtnMobile, false);

        // After first render, reveal header
        revealHeaderOnce();
      }

      function applyLoggedIn(isAdmin) {
        // Desktop
        setVisible(signupBtn, false);
        setVisible(loginBtn,  false);
        setVisible(portalBtnHeader, !isAdmin); // hide My Account for admins
        setVisible(logoutBtnHeader, true);
        setVisible(adminBtn, isAdmin);

        // Mobile
        setVisible(signupBtnMobile, false);
        setVisible(loginBtnMobile2, false);
        setVisible(portalBtnMobileHeader, !isAdmin);
        setVisible(logoutBtnMobileHeader, true);
        setVisible(adminBtnMobile, isAdmin);

        // After first render, reveal header
        revealHeaderOnce();
      }

      // If Supabase is not ready, force logged-out UI (safe default)
      if (!window.supabaseClient) {
        console.warn('Supabase client not available - defaulting to logged-out UI');
        applyLoggedOut();
        return;
      }

      try {
        const { data: { session } } = await window.supabaseClient.auth.getSession();
        const loggedIn = !!(session && session.user);

        if (!loggedIn) {
          applyLoggedOut();
          return;
        }

        // Logged in: check is_admin flag
        let isAdmin = false;
        try {
          const email = session.user.email;
          const { data: client, error } = await window.supabaseClient
            .from('client')
            .select('is_admin')
            .eq('email', email)
            .single();

          if (!error && client) {
            isAdmin = client.is_admin === true;
          }
        } catch (e) {
          console.warn('Error checking admin status, treating as non-admin', e);
        }

        applyLoggedIn(isAdmin);

        // Wire logout buttons
        const wireLogout = (btn) => {
          if (!btn) return;
          btn.onclick = () => window.headerLogout();
        };
        wireLogout(logoutBtnHeader);
        wireLogout(logoutBtnMobileHeader);

      } catch (err) {
        console.error('Error in auth check, defaulting to logged-out UI:', err);
        applyLoggedOut();
      }
    }

    // Make updateHeaderAuth globally accessible for debugging
    window.updateHeaderAuth = updateHeaderAuth;

    // Bind exactly once and wait for authReady before first render
    (async function initHeaderAuthOnce() {
      if (window.__headerAuthBound) {
        return;
      }
      window.__headerAuthBound = true;

      // Wait up to 2000ms for authReady, then continue anyway
      if (window.authReady && typeof window.authReady.then === 'function') {
        try {
          await Promise.race([
            window.authReady,
            new Promise(resolve => setTimeout(() => resolve('timeout'), 2000))
          ]);
        } catch (e) {
          console.warn('Auth ready check failed:', e);
        }
      } else {
      }

      const run = () => {
        if (window.supabaseClient) {
          updateHeaderAuth();
        }
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', run, { once: true });
      } else {
        run();
      }

      // Subscribe once to future auth changes
      if (window.supabaseClient && !window.__headerAuthSub) {
        window.__headerAuthSub = window.supabaseClient.auth.onAuthStateChange((_event, _session) => {
            run();
        });
      } else {
      }

      // If your include loader fires a custom event after partials load, re-check
      window.addEventListener('partialsLoaded', () => {
        run();
      });

      // Fallback: also try after a short delay to catch any missed timing issues
      setTimeout(() => {
        if (window.supabaseClient) run();
      }, 1000);
    })();

    // ---------- Menu logic (single source of truth) ----------
    const mobileMenu  = document.getElementById('mobileMenu');
    const menuToggleBtn = document.getElementById('menuToggleBtn');
    const servicesBtn = document.getElementById('mobileServicesBtn');
    const servicesSub = document.getElementById('mobileServicesSubmenu');

    function openMenu() {
      if (!mobileMenu) return;
      mobileMenu.classList.remove('hidden');
      document.body.classList.add('overflow-hidden');
      if (menuToggleBtn) menuToggleBtn.setAttribute('aria-expanded', 'true');
    }
    function closeMenu() {
      if (!mobileMenu) return;
      mobileMenu.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
      if (menuToggleBtn) menuToggleBtn.setAttribute('aria-expanded', 'false');
    }
    window.closeMenu = closeMenu;   // because links call closeMenu()
    function toggleMenu() {
      if (!mobileMenu) return;
      mobileMenu.classList.contains('hidden') ? openMenu() : closeMenu();
    }
    window.toggleMenu = toggleMenu; // if HTML uses onclick

    function toggleSubmenu(ev) {
      if (!servicesBtn || !servicesSub) return;
      // Prevent outside click handler from closing immediately on iOS
      if (ev && ev.stopPropagation) ev.stopPropagation();
      if (ev && ev.preventDefault) ev.preventDefault();
      else if (window.event) window.event.cancelBubble = true;
      const caret = servicesBtn.querySelector('[data-caret]');
      const nowHidden = servicesSub.classList.toggle('hidden');
      servicesBtn.setAttribute('aria-expanded', nowHidden ? 'false' : 'true');
      if (caret) caret.classList.toggle('rotate-180', !nowHidden);
      return false;
    }
    window.toggleSubmenu = toggleSubmenu;

    // Close on Esc or outside click
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && mobileMenu && !mobileMenu.classList.contains('hidden')) closeMenu();
    });
    document.addEventListener('click', (e) => {
      if (!mobileMenu || mobileMenu.classList.contains('hidden')) return;
      const clickInside = mobileMenu.contains(e.target) || (menuToggleBtn && menuToggleBtn.contains(e.target));
      if (!clickInside) closeMenu();
    });
    
    // Close menu on scroll (common mobile UX pattern)
    let lastScrollY = window.scrollY;
    window.addEventListener('scroll', () => {
      if (!mobileMenu || mobileMenu.classList.contains('hidden')) return;
      // Close menu if user scrolls down more than 50px
      if (Math.abs(window.scrollY - lastScrollY) > 50) {
        closeMenu();
        lastScrollY = window.scrollY;
      }
    });

    // ---------- Desktop services dropdown (click support for touch) ----------
    (function () {
      const trigger = document.getElementById('nav-services');
      const menu    = document.getElementById('nav-services-menu');
      if (!trigger || !menu) return;
      trigger.addEventListener('click', function (e) {
        if (window.innerWidth >= 768) {
          const hidden = menu.classList.contains('hidden');
          if (hidden) {
            e.preventDefault();
            menu.classList.remove('hidden');
            const closer = (evt) => {
              if (!menu.contains(evt.target) && evt.target !== trigger) {
                menu.classList.add('hidden');
                document.removeEventListener('click', closer);
              }
            };
            document.addEventListener('click', closer);
          }
        }
      });
    })();
  } // End of init()

  // Start waiting for dependencies
  waitForReady();
})(); // End of wrapper IIFE
</script>
