<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Complete Your Profile | Auto-Man Driving School</title>
  <meta name="description" content="Complete your profile to get started with Auto-Man Driving School" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="assets/theme.css" rel="stylesheet">
  <script src="assets/config.js"></script>
  <script src="assets/js/modal.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/js/supabaseClient.js"></script>
  <style>
    .wizard-step {
      display: none;
      animation: fadeIn 0.4s ease-in;
    }
    .wizard-step.active {
      display: block;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .progress-bar {
      transition: width 0.3s ease;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
  
  <div class="w-full max-w-2xl">
    <!-- Progress Bar -->
    <div class="mb-8">
      <div class="bg-gray-800 rounded-full h-2.5 shadow-inner">
        <div id="progressBar" class="progress-bar bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
      </div>
      <p class="text-center mt-3 text-sm font-semibold text-white">
        <span id="stepIndicator">Step 1 of 5</span>
      </p>
    </div>

    <!-- Wizard Container (Card) -->
    <div class="rounded-2xl shadow-2xl p-8 md:p-12" style="background-color: var(--card); border: 1px solid var(--border);">
      
      <!-- Step 1: Name -->
      <div class="wizard-step active" data-step="1">
        <div class="mb-8">
          <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-3">Welcome! Let's get started üëã</h1>
          <p class="text-lg text-gray-600">First, what's your name?</p>
        </div>
        
        <div class="space-y-4 mb-8">
          <div>
            <label for="firstName" class="block text-sm font-medium text-gray-700 mb-2">First Name *</label>
            <input 
              type="text" 
              id="firstName" 
              required
              class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg focus:border-blue-600 transition-colors text-black"
              placeholder="Enter your first name"
              autocomplete="given-name"
            />
          </div>
          <div>
            <label for="lastName" class="block text-sm font-medium text-gray-700 mb-2">Last Name *</label>
            <input 
              type="text" 
              id="lastName" 
              required
              class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg focus:border-blue-600 transition-colors text-black"
              placeholder="Enter your last name"
              autocomplete="family-name"
            />
          </div>
        </div>

        <div class="flex justify-end">
          <button onclick="nextStep()" class="btn btn-primary px-8 py-3">
            Next ‚Üí
          </button>
        </div>
      </div>

      <!-- Step 2: Mobile Number -->
      <div class="wizard-step" data-step="2">
        <div class="mb-8">
          <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-3 flex items-center gap-3">üì± What's your contact number</h2>
          <p class="text-lg text-gray-600">We'll use this to send you lesson reminders</p>
        </div>
        
        <div class="mb-8">
          <label for="mobile" class="block text-sm font-medium text-gray-700 mb-2">Mobile Number *</label>
          <input 
            type="tel" 
            id="mobile" 
            required
            class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg focus:border-blue-600 transition-colors text-black"
            placeholder="04XX XXX XXX"
            autocomplete="tel"
            pattern="[0-9\s\-\+\(\)]+"
          />
          <p class="text-sm text-gray-500 mt-2">Australian mobile format (e.g. 0412 345 678)</p>
        </div>

        <div class="flex justify-between mt-6">
          <button onclick="prevStep()" class="btn btn-secondary px-6 py-3">
            ‚Üê Back
          </button>
          <button onclick="nextStep()" class="btn btn-primary px-8 py-3">
            Next ‚Üí
          </button>
        </div>
      </div>

      <!-- Step 3: Licence/Permit Number -->
      <div class="wizard-step" data-step="3">
        <div class="mb-8">
          <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-3 flex items-center gap-3">ü™™ Your licence details</h2>
          <p class="text-lg text-gray-600">Enter your learner's permit or licence number</p>
        </div>
        
        <div class="mb-8">
          <label for="licenseNumber" class="block text-sm font-medium text-gray-700 mb-2">Licence/Permit Number *</label>
          <input 
            type="text" 
            id="licenseNumber" 
            required
            class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg focus:border-blue-600 transition-colors text-black"
            placeholder="Enter your licence or permit number"
          />
          <p class="text-sm text-gray-500 mt-2">You'll need to show this at your first lesson</p>
        </div>

        <div class="flex justify-between mt-6">
          <button onclick="prevStep()" class="btn btn-secondary px-6 py-3">
            ‚Üê Back
          </button>
          <button onclick="nextStep()" class="btn btn-primary px-8 py-3">
            Next ‚Üí
          </button>
        </div>
      </div>

      <!-- Step 4: Medical Conditions -->
      <div class="wizard-step" data-step="4">
        <div class="mb-8">
          <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-3 flex items-center gap-3">üè• Medical information</h2>
          <p class="text-lg text-gray-600">Do you have any medical conditions that may affect your driving?</p>
        </div>
        
        <div class="mb-8">
          <label for="medicalConditions" class="block text-sm font-medium text-gray-700 mb-2">Medical Conditions (Optional)</label>
          <textarea 
            id="medicalConditions" 
            rows="4"
            class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg focus:border-blue-600 transition-colors resize-none text-black placeholder:text-gray-400"
            placeholder="E.g. epilepsy, diabetes, vision impairment, etc. (or leave blank if none)"
          ></textarea>
          <p class="text-sm text-gray-500 mt-2">This helps us provide better support during your lessons</p>
        </div>

        <div class="flex justify-between">
          <button onclick="prevStep()" class="btn btn-secondary px-6 py-3">
            ‚Üê Back
          </button>
          <button onclick="nextStep()" class="btn btn-primary px-8 py-3">
            Next ‚Üí
          </button>
        </div>
      </div>

      <!-- Step 5: Driver Profile -->
      <div class="wizard-step" data-step="5">
        <div class="mb-8">
          <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-3 flex items-center gap-3">üéØ Almost done!</h2>
          <p class="text-lg text-gray-600">Tell us about your driving experience</p>
        </div>
        
        <div class="mb-8 space-y-4">
          <p class="text-sm font-medium text-gray-700 mb-3">Select all that apply:</p>
          
          <label class="flex items-start gap-3 p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-blue-400 transition-colors">
            <input type="checkbox" id="isBeginner" class="mt-1 w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
            <div>
              <span class="font-semibold text-gray-900">I am a complete beginner</span>
              <p class="text-sm text-gray-600">We'll start with the basics and build your confidence</p>
            </div>
          </label>

          <label class="flex items-start gap-3 p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-blue-400 transition-colors">
            <input type="checkbox" id="isAnxious" class="mt-1 w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
            <div>
              <span class="font-semibold text-gray-900">I am an anxious or nervous driver</span>
              <p class="text-sm text-gray-600">We'll provide extra support and patience</p>
            </div>
          </label>

          <label class="flex items-start gap-3 p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-blue-400 transition-colors">
            <input type="checkbox" id="isSenior" class="mt-1 w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
            <div>
              <span class="font-semibold text-gray-900">I am a senior driver</span>
              <p class="text-sm text-gray-600">We'll provide help and support as you prepare for a retest</p>
            </div>
          </label>

          <label class="flex items-start gap-3 p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-blue-400 transition-colors">
            <input type="checkbox" id="isOther" class="mt-1 w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" onchange="toggleOtherText()">
            <div class="flex-1">
              <span class="font-semibold text-gray-900">I have other learning needs or preferences</span>
              <p class="text-sm text-gray-600 mb-2">Please tell us anything else that would help us tailor your lessons</p>
              <input 
                type="text" 
                id="otherDetails" 
                disabled
                class="w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:border-blue-600 transition-colors disabled:bg-gray-100 disabled:cursor-not-allowed text-black"
                placeholder="Please specify..."
              />
            </div>
          </label>
        </div>

        <div class="flex justify-between mt-6">
          <button onclick="prevStep()" class="btn btn-secondary px-6 py-3">
            ‚Üê Back
          </button>
          <button onclick="submitForm()" class="btn btn-primary px-8 py-3">
            Complete Profile
          </button>
        </div>
      </div>

      <!-- Success Message (hidden initially) -->
      <div id="successMessage" class="hidden text-center">
        <div class="mb-6">
          <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
          <h2 class="text-3xl font-bold text-gray-900 mb-3">All set! üéâ</h2>
          <p class="text-lg text-gray-600 mb-6">Your profile has been completed successfully</p>
        </div>
        <a href="portal.html" class="btn btn-primary px-8 py-3">
          Go to Dashboard
        </a>
      </div>

    </div>

    <!-- Skip Link (optional) -->
    <div class="text-center mt-6 space-y-2">
      <a href="#" onclick="skipIntake(); return false;" class="text-sm font-semibold text-gray-300 hover:text-white underline block">
        Skip for now (you can complete this later)
      </a>
      <button 
        id="resetButton" 
        onclick="resetFormOnly(); return false;" 
        class="btn btn-secondary text-xs px-3 py-1.5"
        style="display: none;">
        Reset Form
      </button>
    </div>
    <script>
      // Only show reset button on localhost
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        document.getElementById('resetButton').style.display = 'inline-flex';
      }
    </script>
  </div>

  <script>
    let currentStep = 1;
    const totalSteps = 5;
    const CACHE_KEY = 'onboarding_form_data';
    const STEP_KEY = 'onboarding_current_step';

    // Wait for the SHARED Supabase client (from auth-scripts or supabaseClient.js)
    async function waitForSupabaseClient(timeoutMs = 5000) {
      const t0 = Date.now();
      while (!window.supabaseClient && Date.now() - t0 < timeoutMs) {
        await new Promise(r => setTimeout(r, 100));
      }
      if (!window.supabaseClient) {
        console.error('[intake] ‚ùå window.supabaseClient not available after waiting');
      }
      return window.supabaseClient;
    }

    // Fetch booking data to pre-populate form if blank
    async function fetchBookingData() {
      const supabase = await waitForSupabaseClient();
      if (!supabase) {
        console.log('[intake] ‚ùå Supabase not initialized');
        return null;
      }
      
      try {
        // Get current user
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
          console.log('[intake] ‚ùå No user logged in:', userError);
          return null;
        }
        
        console.log('[intake] ‚úÖ User logged in:', user.email);

        // Get client ID
        const { data: client, error: clientError } = await supabase
          .from('client')
          .select('id')
          .eq('email', user.email)
          .single();
        
        if (clientError || !client?.id) {
          console.log('[intake] ‚ùå Client not found:', clientError);
          return null;
        }
        
        console.log('[intake] ‚úÖ Client ID:', client.id);

        // Get the most recent booking for this client
        const { data: bookings, error: bookingError } = await supabase
          .from('booking')
          .select('first_name, last_name, mobile')
          .eq('client_id', client.id)
          .order('start_time', { ascending: false })
          .limit(1);

        if (bookingError) {
          console.log('[intake] ‚ùå Booking query error:', bookingError);
          return null;
        }
        
        console.log('[intake] üìã Bookings found:', bookings);

        if (bookings && bookings.length > 0) {
          const booking = bookings[0];
          console.log('[intake] üìã Latest booking:', booking);
          
          const result = {
            firstName: booking.first_name || '',
            lastName: booking.last_name || '',
            mobile: booking.mobile || ''
          };
          
          console.log('[intake] ‚úÖ Extracted data:', result);
          return result;
        } else {
          console.log('[intake] ‚ö†Ô∏è No bookings found for this client');
        }
      } catch (err) {
        console.error('[intake] ‚ùå Error fetching booking data:', err);
      }
      
      return null;
    }

    // Save form data to localStorage
    function saveToCache() {
      const formData = {
        firstName: document.getElementById('firstName').value,
        lastName: document.getElementById('lastName').value,
        mobile: document.getElementById('mobile').value,
        licenseNumber: document.getElementById('licenseNumber').value,
        medicalConditions: document.getElementById('medicalConditions').value,
        isBeginner: document.getElementById('isBeginner').checked,
        isAnxious: document.getElementById('isAnxious').checked,
        isSenior: document.getElementById('isSenior').checked,
        isOther: document.getElementById('isOther').checked,
        otherDetails: document.getElementById('otherDetails').value
      };
      localStorage.setItem(CACHE_KEY, JSON.stringify(formData));
      localStorage.setItem(STEP_KEY, currentStep.toString());
    }

    // Load form data from localStorage
    function loadFromCache() {
      const cached = localStorage.getItem(CACHE_KEY);
      if (cached) {
        try {
          const data = JSON.parse(cached);
          document.getElementById('firstName').value = data.firstName || '';
          document.getElementById('lastName').value = data.lastName || '';
          document.getElementById('mobile').value = data.mobile || '';
          document.getElementById('licenseNumber').value = data.licenseNumber || '';
          document.getElementById('medicalConditions').value = data.medicalConditions || '';
          document.getElementById('isBeginner').checked = data.isBeginner || false;
          document.getElementById('isAnxious').checked = data.isAnxious || false;
          document.getElementById('isSenior').checked = data.isSenior || false;
          document.getElementById('isOther').checked = data.isOther || false;
          document.getElementById('otherDetails').value = data.otherDetails || '';
          
          // Enable/disable other textbox based on checkbox
          document.getElementById('otherDetails').disabled = !data.isOther;
        } catch (e) {
          console.error('Error loading cached data:', e);
        }
      }
      
      // Restore step
      const savedStep = localStorage.getItem(STEP_KEY);
      if (savedStep) {
        const step = parseInt(savedStep, 10);
        if (step >= 1 && step <= totalSteps) {
          showStep(step);
        }
      }
    }

    // Clear cache after successful submission
    function clearCache() {
      localStorage.removeItem(CACHE_KEY);
      localStorage.removeItem(STEP_KEY);
    }

    function updateProgress() {
      const progress = (currentStep / totalSteps) * 100;
      document.getElementById('progressBar').style.width = progress + '%';
      document.getElementById('stepIndicator').textContent = `Step ${currentStep} of ${totalSteps}`;
    }

    function showStep(step) {
      document.querySelectorAll('.wizard-step').forEach(el => el.classList.remove('active'));
      const stepEl = document.querySelector(`[data-step="${step}"]`);
      if (stepEl) stepEl.classList.add('active');
      currentStep = step;
      updateProgress();
      saveToCache(); // Save step progress
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function validateStep(step) {
      if (step === 1) {
        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        if (!firstName || !lastName) {
          Modal.error('Please enter both your first and last name');
          return false;
        }
      }
      if (step === 2) {
        const mobile = document.getElementById('mobile').value.trim();
        if (!mobile) {
          Modal.error('Please enter your mobile number');
          return false;
        }
        // Basic Australian mobile validation
        const mobileClean = mobile.replace(/[\s\-\(\)]/g, '');
        if (!/^(\+61|0)[4-5]\d{8}$/.test(mobileClean)) {
          Modal.error('Please enter a valid Australian mobile number (e.g. 0412 345 678)');
          return false;
        }
      }
      if (step === 3) {
        const license = document.getElementById('licenseNumber').value.trim();
        if (!license) {
          Modal.error('Please enter your licence or permit number');
          return false;
        }
      }
      return true;
    }

    function nextStep() {
      if (!validateStep(currentStep)) return;
      saveToCache(); // Save before moving to next step
      if (currentStep < totalSteps) {
        showStep(currentStep + 1);
      }
    }

    function prevStep() {
      if (currentStep > 1) {
        showStep(currentStep - 1);
      }
    }

    function skipIntake() {
      // Set a session flag to indicate user skipped intake
      sessionStorage.setItem('intake_skipped', 'true');
      // Redirect to portal
      window.location.href = 'portal.html';
    }

    function resetFormOnly() {
      // Clear localStorage cache
      localStorage.removeItem(CACHE_KEY);
      localStorage.removeItem(STEP_KEY);
      
      // Clear all form fields
      document.getElementById('firstName').value = '';
      document.getElementById('lastName').value = '';
      document.getElementById('mobile').value = '';
      document.getElementById('licenseNumber').value = '';
      document.getElementById('medicalConditions').value = '';
      document.getElementById('isBeginner').checked = false;
      document.getElementById('isAnxious').checked = false;
      document.getElementById('isSenior').checked = false;
      document.getElementById('isOther').checked = false;
      document.getElementById('otherDetails').value = '';
      document.getElementById('otherDetails').disabled = true;
      
      // Go back to step 1
      showStep(1);
      
      alert('Form and cache cleared! Refresh the page (F5) to test auto-loading from booking data.');
      document.getElementById('firstName').focus();
    }

    function toggleOtherText() {
      const checkbox = document.getElementById('isOther');
      const textbox = document.getElementById('otherDetails');
      textbox.disabled = !checkbox.checked;
      if (checkbox.checked) {
        textbox.focus();
      } else {
        textbox.value = '';
      }
      saveToCache(); // Save when checkbox changes
    }

    async function submitForm() {
      const supabase = await waitForSupabaseClient();
      if (!supabase) {
        Modal.error('Unable to connect to database. Please try again later.');
        return;
      }

      // Get form data
      const formData = {
        first_name: document.getElementById('firstName').value.trim(),
        last_name: document.getElementById('lastName').value.trim(),
        mobile: document.getElementById('mobile').value.trim(),
        learner_permit_number: document.getElementById('licenseNumber').value.trim().toUpperCase(),
        medical_conditions: document.getElementById('medicalConditions').value.trim() || null,
        is_beginner: document.getElementById('isBeginner').checked,
        is_anxious_nervous: document.getElementById('isAnxious').checked,
        is_senior: document.getElementById('isSenior').checked,
        learning_needs_other: document.getElementById('isOther').checked ? document.getElementById('otherDetails').value.trim() : null,
        intake_completed: true,
        updated_at: new Date().toISOString()
      };

      try {
        // Check if Supabase is initialized
        if (!supabase) {
          Modal.error('Configuration error. Please contact support.', 'Setup Required');
          return;
        }

        // Get current user
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
          Modal.error('Please log in to complete your profile', 'Authentication Required');
          setTimeout(() => { window.location.href = 'login.html'; }, 2000);
          return;
        }

        // Use upsert to handle both insert and update (using email as the unique key)
        const { error } = await supabase
          .from('client')
          .upsert(
            { ...formData, email: user.email },
            { onConflict: 'email' }
          );

        if (error) {
          console.error('Error updating profile:', error);
          Modal.error('There was an error saving your profile. Please try again.');
          return;
        }

        // Clear cache on successful submission
        clearCache();
        
        // Clear the skip flag since they completed it
        sessionStorage.removeItem('intake_skipped');
        
        // Redirect to portal
        window.location.href = 'portal.html';
        
      } catch (err) {
        console.error('Unexpected error:', err);
        Modal.error('An unexpected error occurred. Please try again.');
      }
    }

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        const activeStep = document.querySelector('.wizard-step.active');
        if (activeStep) {
          const nextBtn = activeStep.querySelector('button[onclick*="next"]');
          const submitBtn = activeStep.querySelector('button[onclick*="submit"]');
          if (nextBtn && !document.activeElement.matches('textarea')) {
            e.preventDefault();
            nextBtn.click();
          } else if (submitBtn) {
            e.preventDefault();
            submitBtn.click();
          }
        }
      }
    });

    // Auto-uppercase licence number as user types
    document.getElementById('licenseNumber').addEventListener('input', function(e) {
      this.value = this.value.toUpperCase();
    });

    // Auto-save on input change
    document.addEventListener('input', (e) => {
      if (e.target.matches('input, textarea')) {
        saveToCache();
      }
    });

    // Auto-save on checkbox change
    document.addEventListener('change', (e) => {
      if (e.target.matches('input[type="checkbox"]')) {
        saveToCache();
      }
    });

    // Load cached data and focus first input on page load
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('[intake] üöÄ Page loaded, starting initialization...');
      
      loadFromCache();
      
      // If form is blank (no cached data), try to pre-populate from booking
      const firstNameInput = document.getElementById('firstName');
      const lastNameInput = document.getElementById('lastName');
      const mobileInput = document.getElementById('mobile');
      
      const isFormBlank = !firstNameInput.value && !lastNameInput.value && !mobileInput.value;
      
      console.log('[intake] üìù Form blank?', isFormBlank, {
        firstName: firstNameInput.value,
        lastName: lastNameInput.value,
        mobile: mobileInput.value
      });
      
      if (isFormBlank) {
        console.log('[intake] üîç Attempting to fetch booking data...');
        
        // Wait a bit for auth to initialize properly
        await new Promise(r => setTimeout(r, 500));
        
        const bookingData = await fetchBookingData();
        if (bookingData) {
          console.log('[intake] ‚úÖ Populating form with:', bookingData);
          if (bookingData.firstName) firstNameInput.value = bookingData.firstName;
          if (bookingData.lastName) lastNameInput.value = bookingData.lastName;
          if (bookingData.mobile) mobileInput.value = bookingData.mobile;
        } else {
          console.log('[intake] ‚ö†Ô∏è No booking data to populate (user may not be logged in)');
        }
      } else {
        console.log('[intake] ‚ÑπÔ∏è Form already has data, skipping booking fetch');
      }
      
      firstNameInput.focus();
    });
  </script>
  <!-- Google Analytics -->
  <div data-include="partials/analytics.html"></div>
</body>
</html>
