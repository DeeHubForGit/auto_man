<header class="bg-white shadow-sm sticky top-0 z-50">
  <div class="container mx-auto px-4 py-3 flex items-center justify-between">
    <!-- Left: logo + title grouped -->
    <div class="flex items-center gap-2 md:gap-3 min-w-0">
      <img src="images/auto-man-small-logo-website-header.png" alt="Auto-Man Driving School logo" class="h-8 w-auto" decoding="async" fetchpriority="high" />
      <a href="index.html" class="logo text-lg md:text-xl font-bold tracking-tight whitespace-nowrap" style="font-family: Tahoma, Verdana, sans-serif;">Auto-Man Driving School</a>
    </div>

    <!-- Desktop nav -->
    <nav class="hidden md:flex items-center gap-6 text-sm relative">
      <!-- Services + dropdown -->
      <div class="relative group">
        <a id="nav-services" href="index.html#services" class="hover:text-blue-600 inline-flex items-center gap-1">
          Services
          <svg aria-hidden="true" width="14" height="14" viewBox="0 0 20 20" class="mt-[1px]">
            <path d="M6 8l4 4 4-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </a>

        <!-- Desktop dropdown -->
        <div
          id="nav-services-menu"
          class="absolute left-0 top-full w-64 bg-white border rounded-lg shadow-lg py-2 z-50
                 hidden group-hover:block hover:block focus-within:block"
        >
          <a class="block px-4 py-2 hover:bg-blue-50" href="beginner-drivers.html">Beginner Drivers</a> 
          <a class="block px-4 py-2 hover:bg-blue-50" href="driving-test-package.html">Driving Test Package</a>
          <a class="block px-4 py-2 hover:bg-blue-50" href="overseas-licence.html">Overseas Licence Conversion</a>
          <a class="block px-4 py-2 hover:bg-blue-50" href="nervous-drivers.html">Nervous Drivers</a>
          <a class="block px-4 py-2 hover:bg-blue-50" href="senior-drivers.html">Senior Driver Retests</a>
          <a class="block px-4 py-2 hover:bg-blue-50" href="special-requirements.html">Special Requirements</a>
        </div>
      </div>

      <a href="about.html" class="hover:text-blue-600">About Us</a>
      <a href="faq.html" class="hover:text-blue-600">FAQs</a>
      <!-- 
      <a href="index.html#pricing" class="hover:text-blue-600">Lesson Packages</a>
      -->
      <a href="index.html#contact" class="hover:text-blue-600">Contact</a>
      <a href="portal.html" id="portalBtn" class="hidden hover:text-blue-600">My Account</a>
    </nav>

    <!-- Auth controls (middle cluster) -->
    <div class="hidden md:flex items-center gap-3">
      <!-- Sign Up as text link -->
      <a href="signup.html" id="signupBtn" class="md:inline-block text-sm text-gray-700 hover:text-blue-600 transition-colors">Sign Up</a>
      <!-- Login as button -->
      <a href="login.html" id="loginBtn" class="md:inline-block text-blue-600 border border-blue-600 px-4 py-2 rounded-lg hover:bg-blue-50 transition-colors">Login</a>
      <!-- My Account -->
      <a href="portal.html" id="portalBtnHeader" class="hidden md:inline-block hover:text-blue-600 transition-colors">My Account</a>
      <!-- Sign Out button (desktop) -->
      <button id="logoutBtnHeader" class="hidden md:inline-block border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors">Sign Out</button>
    </div>

    <div class="flex items-center gap-4">
      <a href="tel:{{PHONE_LINK}}" class="hidden md:inline-flex items-center gap-2 text-blue-500 font-semibold hover:text-blue-600">ðŸ“ž {{PHONE}}</a>

      <!-- WhatsApp button (placeholder for now) -->
      <a href="https://wa.me/61403632313" target="_blank" rel="noopener"
        class="hidden md:inline-block border border-blue-400 text-blue-400 hover:bg-blue-500 hover:text-white rounded-lg px-4 py-2 text-sm transition">
        <i class="fa-brands fa-whatsapp"></i> WhatsApp
      </a>

      <!-- Book Now as primary CTA -->
      <a href="booking.html"
        class="hidden md:inline-block bg-blue-600 text-white px-5 py-2.5 rounded-lg shadow-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 font-semibold transition-all">
        Book Now
      </a>
      <!-- Mobile Book button -->
      <a href="booking.html" class="md:hidden bg-blue-600 text-white px-3 py-2 rounded-lg shadow hover:bg-blue-700 text-sm ml-2">Book</a>
      <button id="menuToggleBtn" type="button" class="md:hidden px-3 py-2 border rounded select-none touch-manipulation z-50 pointer-events-auto" style="-webkit-tap-highlight-color: transparent;" onclick="toggleMenu()" aria-label="Toggle menu" aria-expanded="false" aria-controls="mobileMenu" role="button">â˜°</button>
    </div>
  </div>

  <!-- Mobile Nav -->
  <div id="mobileMenu"
      class="md:hidden hidden fixed inset-x-0 top-14 z-50 bg-white text-slate-900 border-t shadow-lg">
    <nav class="px-4 py-3 flex flex-col gap-2 text-base">
      <!-- Services (collapsible) -->
      <button id="mobileServicesBtn"
              type="button"
              class="flex items-center justify-between w-full py-2 font-medium"
              aria-controls="mobileServicesSubmenu"
              aria-expanded="false"
              onclick="(function(e){e.preventDefault();e.stopPropagation();var s=document.getElementById('mobileServicesSubmenu');var btn=document.getElementById('mobileServicesBtn');if(!s||!btn)return false;var hidden=s.classList.toggle('hidden');if(!hidden){s.classList.add('block');}else{s.classList.remove('block');}btn.setAttribute('aria-expanded', hidden?'false':'true');var c=btn.querySelector('[data-caret]');if(c)c.classList.toggle('rotate-180',!hidden);return false;})(event)">
        <span>Services</span>
        <span data-caret class="transition-transform transform">â–¾</span>
      </button>

      <div id="mobileServicesSubmenu" class="hidden pl-3 border-l flex flex-col gap-2">
        <a class="block py-1 hover:underline" href="index.html#services" onclick="window.closeMenu?window.closeMenu():null">All Services</a>
        <a class="block py-1 hover:underline" href="beginner-drivers.html" onclick="window.closeMenu?window.closeMenu():null">Beginner Drivers</a>
        <a class="block py-1 hover:underline" href="driving-test-package.html" onclick="window.closeMenu?window.closeMenu():null">Driving Test Package</a>
        <a class="block py-1 hover:underline" href="overseas-licence.html" onclick="window.closeMenu?window.closeMenu():null">Overseas Licence Conversion</a>
        <a class="block py-1 hover:underline" href="nervous-drivers.html" onclick="window.closeMenu?window.closeMenu():null">Nervous Drivers</a>
        <a class="block py-1 hover:underline" href="senior-drivers.html" onclick="window.closeMenu?window.closeMenu():null">Senior Driver Retests</a>
        <a class="block py-1 hover:underline" href="special-requirements.html" onclick="window.closeMenu?window.closeMenu():null">Special Requirements</a>
      </div>

      <a class="block py-2 hover:underline" href="about.html" onclick="window.closeMenu?window.closeMenu():null">About Us</a>
      <a class="block py-2 hover:underline" href="faq.html" onclick="window.closeMenu?window.closeMenu():null">FAQs</a>
      <a class="block py-2 hover:underline" href="index.html#contact" onclick="window.closeMenu?window.closeMenu():null">Contact</a>

      <!-- Auth -->
      <a href="login.html" id="loginBtnMobile"
        class="mt-1 px-4 py-2 rounded border border-blue-600 text-blue-600 hover:bg-blue-50 text-center"
        onclick="window.closeMenu?window.closeMenu():null">Login</a>

      <!-- Phone & CTA -->
      <a href="tel:{{PHONE_LINK}}"
        class="flex items-center gap-2 py-2 font-semibold text-blue-700"
        onclick="window.closeMenu?window.closeMenu():null">ðŸ“ž Call {{PHONE}}</a>

      <a href="booking.html"
        class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 text-center"
        onclick="window.closeMenu?window.closeMenu():null">Book Now</a>
    </nav>
  </div>

  <!-- tiny helpers -->
  <script>
    // ---------- Auth state ----------
    async function updateHeaderAuth() {
      if (!window.supabaseClient) {
        setTimeout(updateHeaderAuth, 100);
        return;
      }
      try {
        const { data: { session } } = await window.supabaseClient.auth.getSession();

        const signupBtn = document.getElementById('signupBtn');
        const loginBtn = document.getElementById('loginBtn');
        const portalBtn = document.getElementById('portalBtn');
        const portalBtnHeader = document.getElementById('portalBtnHeader');
        const logoutBtnHeader = document.getElementById('logoutBtnHeader');
        const signupBtnMobile = document.getElementById('signupBtnMobile');
        const loginBtnMobile  = document.getElementById('loginBtnMobile');
        const portalBtnMobile = document.getElementById('portalBtnMobile');

        const loggedIn = !!(session && session.user);

        // Desktop
        if (signupBtn) signupBtn.classList.toggle('hidden', loggedIn);
        if (loginBtn)  loginBtn.classList.toggle('hidden', loggedIn);
        if (portalBtn) portalBtn.classList.toggle('hidden', !loggedIn);
        if (portalBtnHeader) portalBtnHeader.classList.toggle('hidden', !loggedIn);
        if (logoutBtnHeader) {
          logoutBtnHeader.classList.toggle('hidden', !loggedIn);
          if (loggedIn) {
            logoutBtnHeader.onclick = async () => {
              try { await window.supabaseClient.auth.signOut(); window.location.href = 'index.html'; }
              catch (e) { console.error('Error signing out:', e); }
            };
          }
        }

        // Mobile
        if (signupBtnMobile) signupBtnMobile.classList.toggle('hidden', loggedIn);
        if (loginBtnMobile)  loginBtnMobile.classList.toggle('hidden', loggedIn);
        if (portalBtnMobile) portalBtnMobile.classList.toggle('hidden', !loggedIn);
      } catch (err) {
        console.error('Error checking auth state:', err);
      }
    }

    function initHeaderAuth() {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', updateHeaderAuth);
      } else {
        updateHeaderAuth();
      }
    }
    initHeaderAuth();

    setTimeout(() => {
      if (window.supabaseClient) {
        window.supabaseClient.auth.onAuthStateChange(() => updateHeaderAuth());
      }
    }, 500);

    // ---------- Menu logic (single source of truth) ----------
    const menuToggleBtn = document.getElementById('menuToggleBtn'); // â˜° button
    const mobileMenu    = document.getElementById('mobileMenu');
    const servicesBtn   = document.getElementById('mobileServicesBtn');
    const servicesSub   = document.getElementById('mobileServicesSubmenu');

    function openMenu() {
      if (!mobileMenu) return;
      mobileMenu.classList.remove('hidden');
      document.body.classList.add('overflow-hidden');
      if (menuToggleBtn) menuToggleBtn.setAttribute('aria-expanded', 'true');
      console.log('[header] mobile menu opened');
    }
    function closeMenu() {
      if (!mobileMenu) return;
      mobileMenu.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
      if (menuToggleBtn) menuToggleBtn.setAttribute('aria-expanded', 'false');
      console.log('[header] mobile menu closed');
    }
    window.closeMenu = closeMenu;   // because links call closeMenu() inline
    function toggleMenu() {
      if (!mobileMenu) return;
      mobileMenu.classList.contains('hidden') ? openMenu() : closeMenu();
    }
    window.toggleMenu = toggleMenu; // if HTML uses onclick

    function toggleSubmenu(ev) {
      if (!servicesBtn || !servicesSub) return;
      // Prevent outside click handler from closing immediately on iOS
      if (ev && ev.stopPropagation) ev.stopPropagation();
      if (ev && ev.preventDefault) ev.preventDefault();
      else if (window.event) window.event.cancelBubble = true;
      const caret = servicesBtn.querySelector('[data-caret]');
      const nowHidden = servicesSub.classList.toggle('hidden');
      servicesBtn.setAttribute('aria-expanded', nowHidden ? 'false' : 'true');
      if (caret) caret.classList.toggle('rotate-180', !nowHidden);
      return false;
    }
    window.toggleSubmenu = toggleSubmenu;

    // Prefer inline handlers for reliability; no duplicate JS bindings

    // Close on Esc or outside click
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && mobileMenu && !mobileMenu.classList.contains('hidden')) closeMenu();
    });
    document.addEventListener('click', (e) => {
      if (!mobileMenu || mobileMenu.classList.contains('hidden')) return;
      const clickInside = mobileMenu.contains(e.target) || (menuToggleBtn && menuToggleBtn.contains(e.target));
      if (!clickInside) closeMenu();
    });

    // ---------- Desktop services dropdown (click support for touch) ----------
    (function () {
      const trigger = document.getElementById('nav-services');
      const menu    = document.getElementById('nav-services-menu');
      if (!trigger || !menu) return;
      trigger.addEventListener('click', function (e) {
        if (window.innerWidth >= 768) {
          const hidden = menu.classList.contains('hidden');
          if (hidden) {
            e.preventDefault();
            menu.classList.remove('hidden');
            const closer = (evt) => {
              if (!menu.contains(evt.target) && evt.target !== trigger) {
                menu.classList.add('hidden');
                document.removeEventListener('click', closer);
              }
            };
            document.addEventListener('click', closer);
          }
        }
      });
    })();
  </script>

</header>
