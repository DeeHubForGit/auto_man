<!-- Admin Contact Messages Section -->
<style>
  /* Custom scrollbar for contact messages */
  #contactsScrollContainer {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f1f5f9;
  }
  
  #contactsScrollContainer::-webkit-scrollbar {
    width: 8px;
  }
  
  #contactsScrollContainer::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
  }
  
  #contactsScrollContainer::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
  }
  
  #contactsScrollContainer::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }
  
  .contact-card {
    background-color: #dbeafe !important;
    border: 1px solid #3b82f6 !important;
    border-radius: 0.5rem !important;
    color: #111827 !important;
    box-shadow: none !important;
    padding: 1rem !important;
    transition: all 0.2s ease !important;
  }
  
  .contact-card.unread {
    border-color: #3b82f6 !important;
    border-width: 1px !important;
    box-shadow: 0 0 0 1px #3b82f6 !important;
  }
  
  /* Read (grey card, very clear difference) */
  .contact-card.read {
    background-color: #e2e8f0 !important;   /* slate-200 */
    border-color: #94a3b8 !important;       /* slate-400 */
  }
  
  /* Only colour normal text, not buttons */
  .contact-card p,
  .contact-card span,
  .contact-card div,
  .contact-card strong,
  .contact-card em {
    color: #111827;
  }
  
  .contact-card svg {
    color: #4b5563 !important;
  }
  
  /* Contact card header layout */
  .contact-card-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
  }
  
  .mark-unread-btn {
    background: #e0edff !important;        /* soft blue */
    border: 1px solid #3b82f6 !important;   /* blue outline */
    border-radius: 6px;
    color: #1e40af !important;              /* darker blue text */
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    padding: 3px 10px;
    white-space: nowrap;
    transition: all 0.2s;
  }

  .mark-unread-btn:hover {
    background-color: transparent !important;
    border-color: #3b82f6 !important;   /* bright blue-500 */
    color: #3b82f6 !important;           /* same bright blue */
    transform: none !important;
    box-shadow: none !important;
  }

  .contact-card-name {
    font-weight: 600;
  }
  
  .reply-btn {
    background: #e6efff !important;          /* light-blue background */
    border: 1px solid #4f8df7 !important;    /* medium blue border */
    border-radius: 6px;
    color: #1d4ed8 !important;               /* blue text */
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    padding: 4px 12px;
    white-space: nowrap;
    transition: all 0.2s;
    margin-left: auto;
  }
  
  .reply-btn:hover {
      background-color: #d4e5ff !important;    
      border-color: #2563eb !important;        /* darker blue border */
      color: #1e40af !important;               /* darker blue text */
  }
</style>

<section id="section-contacts" class="section-content bg-white border rounded-2xl shadow-sm p-5 hidden">
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-3">
      <h2 class="text-xl font-semibold">Contact Messages</h2>
      <span id="contactsCount" class="text-sm text-gray-600"></span>
    </div>
    <button id="reloadContacts" class="btn btn-primary px-3 py-1.5">
      <span id="reloadContactsText">Reload</span>
      <span id="reloadContactsSpinner" class="hidden">
        <svg class="animate-spin h-4 w-4 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </span>
    </button>
  </div>
  
  <!-- Filters -->
  <div class="flex flex-wrap items-center gap-3 mb-4">
    <input 
      id="contactSearch" 
      type="text" 
      placeholder="Search by name, email, or message..." 
      class="flex-1 min-w-[200px] bg-white text-gray-900 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
    />
    <select 
      id="contactReadFilter" 
      class="bg-white text-gray-900 border border-gray-300 rounded-lg px-3 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-[150px]"
    >
      <option value="all">All Messages</option>
      <option value="unread">Unread Only</option>
      <option value="read">Read Only</option>
    </select>
    <select 
      id="contactSort" 
      class="bg-white text-gray-900 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
    >
      <option value="newest">Newest first</option>
      <option value="oldest">Oldest first</option>
    </select>
    <select 
      id="contactsPerPage" 
      class="bg-white text-gray-900 border border-gray-300 rounded-lg px-3 py-2 pr-8 focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-[140px]"
    >
      <option value="10" selected>10 per page</option>
      <option value="25">25 per page</option>
      <option value="50">50 per page</option>
      <option value="100">100 per page</option>
    </select>
  </div>
  
  <!-- Scrollable Messages container -->
  <div id="contactsScrollContainer" class="overflow-y-auto max-h-[600px] border border-gray-200 rounded-lg p-3 mb-4">
    <div id="contactsList" class="space-y-3"></div>
  </div>
  
  <!-- Pagination -->
  <div id="contactsPagination" class="flex items-center justify-between">
    <div class="text-sm text-gray-600">
      <span id="paginationInfo"></span>
    </div>
    <div class="flex items-center gap-3">
      <button id="prevPage" class="btn btn-secondary px-3 py-2 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed" title="Previous page" aria-label="Previous page">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
      <span id="pageNumbers" class="text-sm text-gray-700 font-medium min-w-[80px] text-center"></span>
      <button id="nextPage" class="btn btn-primary px-3 py-2 disabled:opacity-50 disabled:cursor-not-allowed" title="Next page" aria-label="Next page">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </button>
    </div>
  </div>
</section>

<script>
(function() {
  // Contact Messages - Store for filtering and pagination
  let allContactMessages = [];
  let currentPage = 1;
  
  async function loadContacts(){
    const box = document.getElementById('contactsList');
    const reloadBtn = document.getElementById('reloadContacts');
    const reloadText = document.getElementById('reloadContactsText');
    const reloadSpinner = document.getElementById('reloadContactsSpinner');
    
    if (!box) {
      console.error('[admin-contacts] contactsList element not found');
      return;
    }
    
    if (!window.supabaseClient) {
      console.error('[admin-contacts] supabaseClient not available for loadContacts');
      box.innerHTML = '<div class="p-4 text-center text-gray-500">Supabase not connected</div>';
      return;
    }
    
    // Show loading spinner
    if (reloadText) reloadText.classList.add('hidden');
    if (reloadSpinner) reloadSpinner.classList.remove('hidden');
    if (reloadBtn) reloadBtn.disabled = true;
    
    box.innerHTML = '<div class="p-8 text-center text-gray-500">Loading messages...</div>';
    
    try {
      const { data, error, status, statusText } = await window.supabaseClient
        .from('contact_messages')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(100);
      
      if (error) {
        console.error('[admin-contacts] Error loading contacts:', error);
        box.innerHTML = `<div class="p-4 text-center text-red-600">Error: ${error.message}</div>`;
        return;
      }
      
      allContactMessages = Array.isArray(data) ? data : [];
      currentPage = 1; // Reset to first page on reload
      renderContactMessages();
      
    } catch (e) {
      console.error('[admin-contacts] Unexpected error loading contacts:', e);
      box.innerHTML = `<div class="p-4 text-center text-red-600">Error: ${e?.message || String(e)}</div>`;
    } finally {
      // Hide loading spinner
      if (reloadText) reloadText.classList.remove('hidden');
      if (reloadSpinner) reloadSpinner.classList.add('hidden');
      if (reloadBtn) reloadBtn.disabled = false;
    }
  }
  
  function renderContactMessages() {
    const box = document.getElementById('contactsList');
    const searchTerm = (document.getElementById('contactSearch')?.value || '').toLowerCase();
    const readFilter = document.getElementById('contactReadFilter')?.value || 'all';
    const sortOrder = document.getElementById('contactSort')?.value || 'newest';
    const perPage = parseInt(document.getElementById('contactsPerPage')?.value || '10');
    const contactsCount = document.getElementById('contactsCount');
    const paginationInfo = document.getElementById('paginationInfo');
    const pageNumbers = document.getElementById('pageNumbers');
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    
    if (!box) return;
    
    // Filter messages
    let filtered = allContactMessages.filter(row => {
      // Read status filter
      if (readFilter === 'unread' && row.is_read) return false;
      if (readFilter === 'read' && !row.is_read) return false;
      
      // Search filter
      if (!searchTerm) return true;
      const name = (row.name || '').toLowerCase();
      const email = (row.email || '').toLowerCase();
      const message = (row.message || '').toLowerCase();
      const phone = (row.phone || '').toLowerCase();
      return name.includes(searchTerm) || email.includes(searchTerm) || 
             message.includes(searchTerm) || phone.includes(searchTerm);
    });
    
    // Sort messages
    filtered.sort((a, b) => {
      const dateA = new Date(a.created_at).getTime();
      const dateB = new Date(b.created_at).getTime();
      return sortOrder === 'newest' ? dateB - dateA : dateA - dateB;
    });
    
    // Update total count
    if (contactsCount) {
      contactsCount.textContent = `(${filtered.length} total)`;
    }
    
    // Calculate pagination
    const totalPages = Math.ceil(filtered.length / perPage);
    if (currentPage > totalPages && totalPages > 0) {
      currentPage = totalPages;
    }
    if (currentPage < 1) currentPage = 1;
    
    const startIdx = (currentPage - 1) * perPage;
    const endIdx = startIdx + perPage;
    const paginatedMessages = filtered.slice(startIdx, endIdx);
    
    // Update pagination info
    if (paginationInfo) {
      if (filtered.length === 0) {
        paginationInfo.textContent = '';
      } else if (totalPages <= 1) {
        // Single page - show "Showing all X"
        paginationInfo.textContent = `Showing all ${filtered.length}`;
      } else {
        // Multiple pages - show range
        const start = startIdx + 1;
        const end = Math.min(endIdx, filtered.length);
        if (start === end) {
          paginationInfo.textContent = `Showing ${start} of ${filtered.length}`;
        } else {
          paginationInfo.textContent = `Showing ${start}-${end} of ${filtered.length}`;
        }
      }
    }
    
    // Update page numbers
    if (pageNumbers) {
      pageNumbers.textContent = totalPages > 0 ? `Page ${currentPage} of ${totalPages}` : '';
    }
    
    // Update prev/next buttons
    if (prevBtn) {
      prevBtn.disabled = currentPage <= 1;
    }
    if (nextBtn) {
      nextBtn.disabled = currentPage >= totalPages;
    }
    // Render
    box.innerHTML = '';
    
    if (filtered.length === 0) {
      const emptyMsg = searchTerm 
        ? `<div class="p-8 text-center text-gray-500">No messages match "${searchTerm}"</div>`
        : '<div class="p-8 text-center text-gray-500">ðŸ“­ No contact messages yet</div>';
      box.innerHTML = emptyMsg;
      return;
    }
    
    paginatedMessages.forEach(row => {
      const card = document.createElement('div');
      // Add visual indicator for unread messages - unread gets bright blue border, read gets gray
      const isRead = row.is_read;
      const readClass = isRead ? 'read' : 'unread';
      card.className = `contact-card ${readClass} mb-3 cursor-pointer`;
      card.setAttribute('data-message-id', row.id);
      card.setAttribute('data-is-read', isRead);
      
      const name = row.name || 'Anonymous';
      const email = row.email || '';
      const phone = row.phone || '';
      const message = row.message || '';
      const date = new Date(row.created_at).toLocaleString('en-AU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      
      // Unread badge
      const unreadBadge = '';
      
      // Mark as unread button (only show for read messages)
      const markUnreadBtn = row.is_read 
        ? `<button class="btn mark-unread-btn" type="button">Mark as unread</button>`
        : '';
      
      // Reply button
      const replyBtn = email 
        ? `<button class="btn reply-btn" type="button" data-email="${email}" data-name="${name.replace(/"/g, '&quot;')}">Reply</button>`
        : '';
      
      card.innerHTML = `
        <div class="contact-card-header">
          <span class="contact-card-name">${name}</span>
          ${unreadBadge}
          ${markUnreadBtn}
          ${replyBtn}
        </div>

        <div class="text-sm mb-1 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
              d="M21.75 7.5v9a2.25 2.25 0 0 1-2.25 2.25h-15A2.25 2.25 0 0 1 2.25 16.5v-9m19.5 0A2.25 2.25 0 0 0 19.5 5.25h-15A2.25 2.25 0 0 0 2.25 7.5m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.915l-7.5 4.5a2.25 2.25 0 0 1-2.31 0l-7.5-4.5A2.25 2.25 0 0 1 2.25 7.743V7.5" />
          </svg>
          <span>${email || 'â€”'}</span>
        </div>

        ${phone ? `
          <div class="text-sm mb-2 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                d="M2.25 6.75c0 7.456 6.044 13.5 13.5 13.5a2.25 2.25 0 0 0 2.25-2.25v-1.17a1.5 1.5 0 0 0-1.03-1.422l-3.03-1.01a1.5 1.5 0 0 0-1.64.54l-.64.85a10.5 10.5 0 0 1-4.56-4.56l.85-.64a1.5 1.5 0 0 0 .54-1.64l-1.01-3.03A1.5 1.5 0 0 0 6.17 4.5H5a2.25 2.25 0 0 0-2.75 2.25z" />
            </svg>
            <span>${phone}</span>
          </div>
        ` : '<div class="mb-2"></div>'}

        <div class="whitespace-pre-wrap mb-2"><strong>Message:</strong> ${message}</div>
        <div class="text-xs opacity-80 mt-2">${date}</div>
      `;
      
      box.appendChild(card);
    });
  }
  
  // Mark message as read
  async function markMessageAsRead(messageId) {
    if (!window.supabaseClient) {
      console.error('[admin-contacts] supabaseClient not available');
      return;
    }
    
    try {
      const { data, error } = await window.supabaseClient
        .from('contact_messages')
        .update({ is_read: true })
        .eq('id', messageId)
        .select();
      
      if (error) {
        console.error('[admin-contacts] Error marking message as read:', error);
        return;
      }
      
      // Update the message in our local array
      const message = allContactMessages.find(m => m.id === messageId);
      if (message) {
        message.is_read = true;
      }
      
      // Re-render to update UI
      renderContactMessages();
      
      // Update notification badges if available
      if (window.updateNotificationBadges) {
        window.updateNotificationBadges();
      }
    } catch (error) {
      console.error('[admin-contacts] Error marking message as read:', error);
    }
  }
  
  // Mark message as unread
  async function markMessageAsUnread(messageId) {
    if (!window.supabaseClient) {
      console.error('[admin-contacts] supabaseClient not available');
      return;
    }
    
    try {
      const { data, error } = await window.supabaseClient
        .from('contact_messages')
        .update({ is_read: false })
        .eq('id', messageId)
        .select();
      
      if (error) {
        console.error('[admin-contacts] Error marking message as unread:', error);
        return;
      }
      
      // Update the message in our local array
      const message = allContactMessages.find(m => m.id === messageId);
      if (message) {
        message.is_read = false;
      }
      
      // Re-render to update UI
      renderContactMessages();
      
      // Update notification badges if available
      if (window.updateNotificationBadges) {
        window.updateNotificationBadges();
      }
    } catch (error) {
      console.error('[admin-contacts] Error marking message as unread:', error);
    }
  }
  
  // Show reply modal
  function showReplyModal(recipientEmail, recipientName) {
    const firstName = recipientName.split(' ')[0]; // Get first name
    
    // Create modal HTML
    const modalHTML = `
      <div id="replyModal" class="fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
          <div class="p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">Reply to Contact Message</h3>
            
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">To:</label>
                <input type="email" id="replyTo" value="${recipientEmail}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" />
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Subject:</label>
                <input type="text" id="replySubject" value="Re: Your enquiry - Auto-Man Driving School" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Message:</label>
                <textarea id="replyMessage" rows="12" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Write your reply...">Dear ${firstName},

Thank you for contacting Auto-Man Driving School. 

Kind regards,
Darren
Auto-Man Driving School
ðŸ“ž 0403 632 313</textarea>
              </div>
            </div>
            
            <div class="mt-6 flex gap-3 justify-end">
              <button id="replyCancelBtn" class="btn btn-secondary">Cancel</button>
              <button id="replySendBtn" class="btn btn-primary">Send</button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('replyModal');
    if (existingModal) {
      existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    const modal = document.getElementById('replyModal');
    const sendBtn = document.getElementById('replySendBtn');
    const cancelBtn = document.getElementById('replyCancelBtn');
    
    function closeModal() {
      modal.remove();
    }
    
    // Send button handler
    sendBtn.addEventListener('click', async () => {
      const to = document.getElementById('replyTo')?.value;
      const subject = document.getElementById('replySubject')?.value;
      const message = document.getElementById('replyMessage')?.value;
      
      if (!to || !subject || !message) {
        if (window.Modal && window.Modal.error) {
          window.Modal.error('Please fill in all fields');
        } else {
          alert('Please fill in all fields');
        }
        return;
      }
      
      // Disable button while sending
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';
      
      // Send email via Supabase function
      try {
        const supabaseUrl = window.SITE_CONFIG?.SUPABASE_URL || window.SUPABASE_URL;
        const supabaseKey = window.SITE_CONFIG?.SUPABASE_ANON_KEY || window.SUPABASE_ANON_KEY;
        
        if (!supabaseUrl || !supabaseKey) {
          throw new Error('Supabase configuration not found');
        }
        
        const response = await fetch(`${supabaseUrl}/functions/v1/email`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${supabaseKey}`,
            'apikey': supabaseKey
          },
          body: JSON.stringify({
            to: to,
            subject: subject,
            text: message,
            html: message.replace(/\n/g, '<br>')
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
          throw new Error(errorData.error || `HTTP ${response.status}`);
        }
        
        closeModal();
        
        if (window.Modal && window.Modal.success) {
          window.Modal.success('Email sent successfully!');
        } else {
          alert('Email sent successfully!');
        }
      } catch (error) {
        console.error('[admin-contacts] Error sending email:', error);
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
        
        if (window.Modal && window.Modal.error) {
          window.Modal.error('Failed to send email: ' + error.message);
        } else {
          alert('Failed to send email: ' + error.message);
        }
      }
    });
    
    // Cancel button handler
    cancelBtn.addEventListener('click', closeModal);
    
    // Close on backdrop click
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });
    
    // Close on Escape key
    function handleEscape(e) {
      if (e.key === 'Escape') {
        closeModal();
        document.removeEventListener('keydown', handleEscape);
      }
    }
    document.addEventListener('keydown', handleEscape);
  }

  // Wire up when partial loads
  if (window.adminContactsReady) {
    // Already initialized
  } else {
    window.adminContactsReady = true;
    
    // Expose function globally for onclick handler
    window.markContactAsUnread = markMessageAsUnread;
    
    const initContacts = () => {
      const reloadContactsBtn = document.getElementById('reloadContacts');
      if (reloadContactsBtn) reloadContactsBtn.onclick = loadContacts;
      
      // Wire up search and sort filters
      const contactSearch = document.getElementById('contactSearch');
      if (contactSearch) {
        contactSearch.addEventListener('input', () => {
          currentPage = 1; // Reset to page 1 when searching
          renderContactMessages();
        });
      }
      
      const contactReadFilter = document.getElementById('contactReadFilter');
      if (contactReadFilter) {
        contactReadFilter.addEventListener('change', () => {
          currentPage = 1; // Reset to page 1 when filter changes
          renderContactMessages();
        });
      }
      
      const contactSort = document.getElementById('contactSort');
      if (contactSort) {
        contactSort.addEventListener('change', () => {
          currentPage = 1; // Reset to page 1 when sorting changes
          renderContactMessages();
        });
      }
      
      const contactsPerPage = document.getElementById('contactsPerPage');
      if (contactsPerPage) {
        contactsPerPage.addEventListener('change', () => {
          currentPage = 1; // Reset to page 1 when per-page changes
          renderContactMessages();
        });
      }
      
      // Click on message card to mark as read (like email clients)
      const contactsList = document.getElementById('contactsList');
      if (contactsList) {
        contactsList.addEventListener('click', (e) => {
          // Handle Reply button clicks
          const replyBtn = e.target.closest('.reply-btn');
          if (replyBtn) {
            e.stopPropagation();
            const email = replyBtn.getAttribute('data-email');
            const name = replyBtn.getAttribute('data-name');
            if (email) {
              showReplyModal(email, name);
            }
            return;
          }
          
          // Handle "Mark as unread" button clicks
          const unreadBtn = e.target.closest('.mark-unread-btn');
          if (unreadBtn) {
            e.stopPropagation();
            const card = unreadBtn.closest('.contact-card');
            const messageId = card ? card.getAttribute('data-message-id') : null;
            
            console.log('[admin-contacts] Mark as unread clicked, card:', card, 'messageId:', messageId);
            
            if (messageId) {
              markMessageAsUnread(messageId);
            } else {
              console.error('[admin-contacts] Could not find message ID');
            }
            return;
          }
          
          // Find the card element (could be clicking on child elements)
          const card = e.target.closest('.contact-card');
          if (card) {
            const messageId = card.getAttribute('data-message-id');
            const isRead = card.getAttribute('data-is-read') === 'true';
            
            // Only mark as read if currently unread
            if (messageId && !isRead) {
              markMessageAsRead(messageId);
            }
          }
        });
      }
      
      // Pagination buttons
      const prevPage = document.getElementById('prevPage');
      if (prevPage) {
        prevPage.addEventListener('click', () => {
          if (currentPage > 1) {
            currentPage--;
            renderContactMessages();
            // Scroll to top of messages
            document.getElementById('contactsScrollContainer')?.scrollTo(0, 0);
          }
        });
      }
      
      const nextPage = document.getElementById('nextPage');
      if (nextPage) {
        nextPage.addEventListener('click', () => {
          currentPage++;
          renderContactMessages();
          // Scroll to top of messages
          document.getElementById('contactsScrollContainer')?.scrollTo(0, 0);
        });
      }
      
      loadContacts();
    };
    
    // Expose functions globally for notification icons
    window.adminContactsLoadAndFilter = function(readFilter) {
      const filterDropdown = document.getElementById('contactReadFilter');
      if (filterDropdown && readFilter) {
        filterDropdown.value = readFilter;
      }
      loadContacts();
    };
    
    window.adminContactsGetUnreadCount = function() {
      return allContactMessages.filter(m => !m.is_read).length;
    };
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initContacts);
    } else {
      initContacts();
    }
  }
})();
</script>
