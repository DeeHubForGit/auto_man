<!-- Admin Send SMS & Email Section -->
<style>
  /* Force white backgrounds and black text for messaging inputs - override dark theme */
  #section-messaging input,
  #section-messaging textarea {
    background-color: white !important;
    color: black !important;
    border: 1px solid #d1d5db !important;
  }
  
  #section-messaging input::placeholder,
  #section-messaging textarea::placeholder {
    color: #6b7280 !important;
  }
  
  #section-messaging input:focus,
  #section-messaging textarea:focus {
    border-color: #3b82f6 !important;
    ring-color: #3b82f6 !important;
    background-color: white !important;
    color: black !important;
  }
</style>
<section id="section-messaging" class="section-content bg-white border rounded-2xl shadow-sm p-5 hidden">
  <!-- Header with help text -->
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-semibold">Send SMS & Email</h2>
    <span class="text-gray-400 cursor-help" title="Send test messages to verify SMS and email functionality">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
    </span>
  </div>
  
  <div class="grid gap-4">
    <div>
      <label class="block text-sm font-medium mb-2 text-gray-900">Mobile (AU)</label>
      <input id="smsTo" type="text" class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="04XXXXXXXX or +614XXXXXXXX" />
      <label class="block text-sm font-medium mt-3 mb-2 text-gray-900">Message</label>
      <textarea id="smsBody" class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3" placeholder="Your message..."></textarea>
      <div class="mt-3 flex gap-2">
        <button id="sendSms" class="btn-primary px-5 py-2.5 rounded-lg">Send SMS</button>
        <button id="clearSms" class="btn-secondary px-5 py-2.5 rounded-lg">Clear</button>
      </div>
      <div id="smsMsg" class="text-sm mt-2"></div>
    </div>
    <div class="border-t pt-4">
      <label class="block text-sm font-medium mb-2 text-gray-900">Email</label>
      <input id="emailTo" type="email" class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="you@example.com" />
      <label class="block text-sm font-medium mt-3 mb-2 text-gray-900">Subject</label>
      <input id="emailSubj" class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Subject" />
      <label class="block text-sm font-medium mt-3 mb-2 text-gray-900">Body</label>
      <textarea id="emailBody" class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="4" placeholder="Email text..."></textarea>
      <div class="mt-3 flex gap-2">
        <button id="sendEmail" class="btn-primary px-5 py-2.5 rounded-lg">Send Email</button>
        <button id="clearEmail" class="btn-secondary px-5 py-2.5 rounded-lg">Clear</button>
      </div>
      <div id="emailMsg" class="text-sm mt-2"></div>
    </div>
  </div>
</section>

<script>
(function() {
  // Phone validators (from portal-details)
  function normaliseDigits(v){ return (v||'').replace(/\D+/g,''); }
  
  function isValidAuMobile(v){
    if (!v) return false;
    const cleaned = v.trim();
    const digits = normaliseDigits(cleaned);
    
    // Must be exactly 10 digits starting with 04, or 11 digits starting with 614
    if (!/^(04\d{8}|614\d{8})$/.test(digits)) return false;
    
    // Ensure no invalid characters (only digits, spaces, +, -, parentheses)
    if (!/^[\d\s+\-()]+$/.test(cleaned)) return false;
    
    // If starts with +, must be +61
    if (cleaned.startsWith('+') && !cleaned.startsWith('+61')) return false;
    
    return true;
  }
  
  // Email validator (from signup)
  function isValidEmail(email) {
    if (!email) return false;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email.trim());
  }

  // Send SMS & Email logic
  async function sendSms(){
    const to = (document.getElementById('smsTo').value || '').trim();
    const message = (document.getElementById('smsBody').value || '').trim(); // <-- was "body"
    const msgEl = document.getElementById('smsMsg');

    if (!to || !message) { 
      msgEl.textContent = 'Please enter mobile and message.'; 
      msgEl.className = 'text-sm mt-2 text-red-600';
      return; 
    }
    
    // Validate mobile number
    if (!isValidAuMobile(to)) {
      msgEl.textContent = 'Please enter a valid AU mobile (e.g. 04XX XXX XXX or +614XX XXX XXX)';
      msgEl.className = 'text-sm mt-2 text-red-600';
      return;
    }

    msgEl.textContent = 'Sending...';
    msgEl.className = 'text-sm mt-2 text-blue-400';
    try{
      // invoker adds the auth headers for you
      const { data, error } = await window.supabaseClient.functions.invoke('sms', {
        body: { to, message },
        headers: {
          apikey: window.SITE_CONFIG.SUPABASE_ANON_KEY
        }
      });
      
      console.log('[admin-messaging] SMS response:', data);

      if (error) {
        msgEl.textContent = 'Error: ' + (error.message || 'failed');
        msgEl.className = 'text-sm mt-2 text-red-600';
      } else if (data?.ok) {
        // Handle both old (data.data) and new (data.clicksend) response formats
        const cs = data.clicksend || data.data;
        console.log('[admin-messaging] ClickSend data:', cs);
        
        if (cs?.response_code === 'SUCCESS' || cs?.http_code === 200) {
          msgEl.textContent = '✓ Sent';
          msgEl.className = 'text-sm mt-2 text-blue-400';
        } else if (cs?.response_msg) {
          msgEl.textContent = `ClickSend: ${cs.response_msg} (code: ${cs.response_code || 'unknown'})`;
          msgEl.className = 'text-sm mt-2 text-red-600';
        } else {
          msgEl.textContent = 'Unexpected response. Check console for details.';
          msgEl.className = 'text-sm mt-2 text-red-600';
          console.log('[admin-messaging] Full ClickSend response:', cs);
        }
      } else {
        msgEl.textContent = 'Unexpected response. Check console for details.';
        msgEl.className = 'text-sm mt-2 text-red-600';
        console.log('[admin-messaging] Full response:', data);
      }
    } catch(e){
      console.error('[admin-messaging] SMS error:', e);
      msgEl.textContent = 'Error sending: ' + (e.message || 'Unknown error');
      msgEl.className = 'text-sm mt-2 text-red-600';
    }
  }

  async function sendEmail(){
    const to = (document.getElementById('emailTo').value||'').trim();
    const subject = (document.getElementById('emailSubj').value||'').trim();
    const text = (document.getElementById('emailBody').value||'').trim();
    const msgEl = document.getElementById('emailMsg');

    if (!to || !subject || !text) {
      msgEl.textContent = 'Please fill in all email fields';
      msgEl.className = 'text-sm mt-2 text-red-600';
      return;
    }
    
    // Validate email address
    if (!isValidEmail(to)) {
      msgEl.textContent = 'Please enter a valid email address';
      msgEl.className = 'text-sm mt-2 text-red-600';
      return;
    }

    const html = `<p>${text.replace(/\n/g, '<br>')}</p>`;
    const fnUrl = `${window.SITE_CONFIG.SUPABASE_URL}/functions/v1/email`;

    msgEl.textContent = 'Sending...';
    msgEl.className = 'text-sm mt-2 text-blue-400';

    try {
      // direct fetch to the Edge Function (matches the working console/dashboard tests)
      const resp = await fetch(fnUrl, {
        method: 'POST',
        headers: {
          'content-type': 'application/json',
          'authorization': 'Bearer ' + window.SITE_CONFIG.SUPABASE_ANON_KEY,
          'apikey': window.SITE_CONFIG.SUPABASE_ANON_KEY
        },
        body: JSON.stringify({ to, subject, html })
      });

      const data = await resp.json().catch(() => null);
      console.log('[admin-messaging] Email response:', { status: resp.status, data });

      if (!resp.ok) {
        msgEl.textContent = `Error: HTTP ${resp.status}`;
        msgEl.className = 'text-sm mt-2 text-red-600';
      } else if (data?.ok) {
        msgEl.textContent = '✓ Email sent';
        msgEl.className = 'text-sm mt-2 text-blue-400';
      } else {
        msgEl.textContent = 'Unexpected response. Check console.';
        msgEl.className = 'text-sm mt-2 text-red-600';
      }
    } catch (e) {
      console.error('[admin-messaging] Email exception:', e);
      msgEl.textContent = 'Error: ' + (e.message || 'Unknown error');
      msgEl.className = 'text-sm mt-2 text-red-600';
    }
  }

  function clearSms() {
    document.getElementById('smsTo').value = '';
    document.getElementById('smsBody').value = '';
    document.getElementById('smsMsg').textContent = '';
  }

  function clearEmail() {
    document.getElementById('emailTo').value = '';
    document.getElementById('emailSubj').value = '';
    document.getElementById('emailBody').value = '';
    document.getElementById('emailMsg').textContent = '';
  }

  // Wire up when partial loads
  if (window.adminMessagingReady) {
    // Already initialized
  } else {
    window.adminMessagingReady = true;
    
    const initMessaging = () => {
      const sendSmsBtn = document.getElementById('sendSms');
      if (sendSmsBtn) sendSmsBtn.onclick = sendSms;
      
      const clearSmsBtn = document.getElementById('clearSms');
      if (clearSmsBtn) clearSmsBtn.onclick = clearSms;
      
      const sendEmailBtn = document.getElementById('sendEmail');
      if (sendEmailBtn) sendEmailBtn.onclick = sendEmail;
      
      const clearEmailBtn = document.getElementById('clearEmail');
      if (clearEmailBtn) clearEmailBtn.onclick = clearEmail;
    };
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initMessaging);
    } else {
      initMessaging();
    }
  }
})();
</script>
