<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Auto-Man Driving School</title>
  <meta name="description" content="Admin dashboard for Auto-Man Driving School" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="assets/theme.css" rel="stylesheet">
  <script src="assets/config.js"></script>
  <script src="assets/render-helpers.js" defer></script>
  <script src="assets/include.js" defer></script>
  <script src="assets/js/modal.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <style>
    /* Prevent white background on notification icon buttons */
    #refundAlertIcon:focus,
    #refundAlertIcon:active,
    #messageAlertIcon:focus,
    #messageAlertIcon:active {
      background-color: #f3f4f6 !important;
    }
  </style>
  <!-- Auth scripts -->
  <div data-include="partials/auth-scripts.html"></div>
  <!-- Shared Header - permanent container prevents layout shift -->
  <div id="header-container" class="hydrating" style="min-height: 70px;">
    <div data-include="partials/header.html"></div>
  </div>

  <main class="container mx-auto px-4 py-8">
    <div class="flex items-center gap-3 mb-6">
      <h1 class="text-2xl sm:text-3xl font-extrabold whitespace-nowrap">Admin Dashboard</h1>
      
      <!-- Notification Icons -->
      <div id="adminNotifications" class="flex items-center gap-3 flex-shrink-0">
        <!-- Refund Alerts -->
        <button id="refundAlertIcon" style="background-color: transparent !important;" class="hidden relative p-2 hover:bg-gray-100 active:bg-gray-200 rounded-lg transition-all" onclick="showRefundAlerts()" title="Refund alerts" type="button">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-gray-900 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span id="refundAlertBadge" class="absolute top-0 right-0 inline-flex items-center justify-center px-1.5 py-0.5 text-xs font-bold leading-none text-white bg-red-600 rounded-full min-w-[20px] pointer-events-none"></span>
        </button>
        
        <!-- Unread Messages -->
        <button id="messageAlertIcon" style="background-color: transparent !important;" class="hidden relative p-2 hover:bg-gray-100 active:bg-gray-200 rounded-lg transition-all" onclick="showUnreadMessages()" title="Unread messages" type="button">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-gray-900 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
          <span id="messageAlertBadge" class="absolute top-0 right-0 inline-flex items-center justify-center px-1.5 py-0.5 text-xs font-bold leading-none text-white bg-red-600 rounded-full min-w-[20px] pointer-events-none"></span>
        </button>
      </div>
    </div>

    <div id="notAdmin" class="hidden p-4 border rounded bg-amber-50 text-amber-800 mb-8">
      You do not have access to this page.
    </div>

    <div id="adminContent" class="flex flex-col lg:flex-row gap-6">
      <!-- Sidebar Navigation -->
      <aside class="lg:w-64 flex-shrink-0">
        <div class="bg-white rounded-2xl border shadow-sm p-6 sticky top-24">
          <nav class="space-y-1">
            <a href="#calendar" onclick="showSection('calendar')" id="nav-calendar"
               class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors border-l-4 border-transparent">
              <span class="font-medium">Calendar</span>
            </a>
            <a href="#cancellations" onclick="showSection('cancellations')" id="nav-cancellations"
               class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors border-l-4 border-transparent">
              <span class="font-medium">Cancellations</span>
            </a>
            <a href="#progress" onclick="showSection('progress')" id="nav-progress"
               class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors border-l-4 border-transparent">
              <span class="font-medium">Client Progress</span>
            </a>
            <a href="#messaging" onclick="showSection('messaging')" id="nav-messaging"
               class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors border-l-4 border-transparent">
              <span class="font-medium">Test SMS & Email</span>
            </a>
            <a href="#contacts" onclick="showSection('contacts')" id="nav-contacts"
               class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors border-l-4 border-transparent">
              <span class="font-medium">Contact Messages</span>
            </a>
          </nav>
        </div>
      </aside>

      <!-- Main Content Area -->
      <div class="flex-1 min-w-0">
        <!-- Include all admin sections as partials -->
        <div data-include="partials/admin-calendar.html"></div>
        <div data-include="partials/admin-cancellations.html"></div>
        <div data-include="partials/admin-progress.html"></div>
        <div data-include="partials/admin-messaging.html"></div>
        <div data-include="partials/admin-contacts.html"></div>
      </div>
    </div>
  </main>

  <div data-include="partials/footer.html"></div>

  <script>
    // Admin allowlist from SITE_CONFIG.ADMIN_EMAILS (array)
    const ADMIN_EMAILS = Array.isArray(window.SITE_CONFIG?.ADMIN_EMAILS) ? window.SITE_CONFIG.ADMIN_EMAILS : [
      'darren@automandrivingschool.com.au'
    ];

    async function ensureAdmin() {
      // Check authentication and admin access using is_admin flag from database
      const adminContent = document.getElementById('adminContent');
      const notAdmin = document.getElementById('notAdmin');
      
      if (!window.supabaseClient) { 
        console.error('[admin] supabaseClient not available');
        notAdmin.classList.remove('hidden'); 
        adminContent.style.display = 'none';
        return false; 
      }
      
      const { data: { session } } = await window.supabaseClient.auth.getSession();
      const email = session?.user?.email || '';
      
      if (!email) {
        console.log('[admin] No user logged in');
        notAdmin.classList.remove('hidden');
        adminContent.style.display = 'none';
        return false;
      }
      
      // Query the client table to check is_admin flag
      const { data: client, error } = await window.supabaseClient
        .from('client')
        .select('is_admin')
        .eq('email', email)
        .single();
      
      const isAdmin = client?.is_admin === true;
      
      console.log('[admin] ensureAdmin check:', { 
        email, 
        isAdmin,
        hasSession: !!session,
        clientData: client
      });
      
      if (isAdmin) {
        // User is admin - show admin dashboard
        notAdmin.classList.add('hidden');
        adminContent.style.display = '';
        return true;
      } else {
        // User is not admin - redirect to portal
        console.log('[admin] User is not admin, redirecting to portal');
        window.location.href = '/portal.html';
        return false;
      }
    }

    // Section navigation like portal.html
    function showSection(section, source = 'sidebar') {
      // Hide all sections
      document.querySelectorAll('.section-content').forEach(el => el.classList.add('hidden'));

      // Reset sidebar items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('is-active');
      });

      // Show selected section and highlight active link
      const targetSection = document.getElementById(`section-${section}`);
      if (targetSection) targetSection.classList.remove('hidden');

      const navItem = document.getElementById(`nav-${section}`);
      if (navItem) navItem.classList.add('is-active');
      
      // Reset filters to default when navigating to cancellations from sidebar
      if (section === 'cancellations' && source === 'sidebar') {
        setTimeout(() => {
          const searchInput = document.getElementById('cancellationSearch');
          const sortSelect = document.getElementById('cancellationSort');
          const eligibilityFilter = document.getElementById('refundEligibilityFilter');
          const statusFilter = document.getElementById('refundStatusFilter');
          const perPageSelect = document.getElementById('cancellationsPerPage');
          
          if (searchInput) searchInput.value = '';
          if (sortSelect) sortSelect.value = 'newest';
          if (eligibilityFilter) eligibilityFilter.value = 'all';
          if (statusFilter) statusFilter.value = 'all';
          if (perPageSelect) perPageSelect.value = '10';
          
          // Trigger render with reset filters
          if (window.renderCancellations) {
            window.renderCancellations();
          }
        }, 50);
      }
      
      // Reset filter to unread when navigating to contacts from sidebar
      if (section === 'contacts' && source === 'sidebar') {
        setTimeout(() => {
          if (window.adminContactsLoadAndFilter) {
            window.adminContactsLoadAndFilter('unread');
          }
        }, 50);
      }
    }
    
    // Notification icon handlers
    window.showRefundAlerts = function() {
      console.log('[admin] showRefundAlerts called');
      showSection('cancellations', 'alert');
      // Wait for section to be visible, then set filters
      setTimeout(() => {
        const eligibilityFilter = document.getElementById('refundEligibilityFilter');
        const statusFilter = document.getElementById('refundStatusFilter');
        console.log('[admin] Setting filters:', { eligibilityFilter: !!eligibilityFilter, statusFilter: !!statusFilter });
        if (eligibilityFilter) {
          eligibilityFilter.value = 'eligible';
          eligibilityFilter.dispatchEvent(new Event('change'));
        }
        if (statusFilter) {
          statusFilter.value = 'not-refunded';
          statusFilter.dispatchEvent(new Event('change'));
        }
      }, 200);
    };
    
    window.showUnreadMessages = function() {
      showSection('contacts', 'alert');
      // Set filter to unread and load
      if (window.adminContactsLoadAndFilter) {
        window.adminContactsLoadAndFilter('unread');
      }
    };
    
    // Update notification badges
    window.updateNotificationBadges = async function() {
      if (!window.supabaseClient) return;
      
      try {
        // Count unrefunded cancellations that are refund eligible
        const { data: cancellations, error: cancelError } = await window.supabaseClient
          .from('booking')
          .select('id, refunded, refund_eligible')
          .eq('status', 'cancelled')
          .eq('is_booking', true)
          .eq('refund_eligible', true);
        
        const refundCount = cancellations?.filter(b => !b.refunded).length || 0;
        
        // Get unread messages count
        const { data: messageData, error: messageError } = await window.supabaseClient
          .from('contact_messages')
          .select('id')
          .eq('is_read', false);
        
        const messageCount = messageData?.length || 0;
        
        // Update refund alert
        const refundIcon = document.getElementById('refundAlertIcon');
        const refundBadge = document.getElementById('refundAlertBadge');
        if (refundCount > 0) {
          if (refundIcon) refundIcon.classList.remove('hidden');
          if (refundBadge) refundBadge.textContent = refundCount;
        } else {
          if (refundIcon) refundIcon.classList.add('hidden');
        }
        
        // Update message alert
        const messageIcon = document.getElementById('messageAlertIcon');
        const messageBadge = document.getElementById('messageAlertBadge');
        if (messageCount > 0) {
          if (messageIcon) messageIcon.classList.remove('hidden');
          if (messageBadge) messageBadge.textContent = messageCount;
        } else {
          if (messageIcon) messageIcon.classList.add('hidden');
        }
        
        console.log('[admin] Notification badges updated:', { refundCount, messageCount });
      } catch (error) {
        console.error('[admin] Error updating notification badges:', error);
      }
    };


    // Wire up
    document.addEventListener('DOMContentLoaded', async function(){
      console.log('[admin] DOMContentLoaded - waiting for auth...');
      
      // Wait for authReady promise if it exists
      if (window.authReady) { 
        try { 
          await window.authReady; 
          console.log('[admin] authReady resolved');
        } catch(e) { 
          console.warn('[admin] authReady error:', e);
        } 
      }
      
      // Additional wait for supabaseClient if not ready yet
      let attempts = 0;
      while (!window.supabaseClient && attempts < 50) {
        console.log('[admin] Waiting for supabaseClient... attempt', attempts + 1);
        await new Promise(r => setTimeout(r, 100));
        attempts++;
      }
      
      if (!window.supabaseClient) {
        console.error('[admin] supabaseClient still not available after waiting');
      } else {
        console.log('[admin] supabaseClient is ready!');
      }
      
      const ok = await ensureAdmin();
      
      if (ok) {
        // Update notification badges on load
        await window.updateNotificationBadges();
        
        // Refresh notification badges every 30 seconds
        setInterval(window.updateNotificationBadges, 30000);
      }
      
      // Show first section by default
      showSection('calendar');
    });
  </script>
</body>
</html>
