<script src="/assets/js/validation.js"></script>
<script src="/assets/js/messaging.js"></script>
<!-- Admin Send SMS & Email Section -->
<style>
  /* Force white backgrounds and black text for messaging inputs - override dark theme */
  #section-messaging input,
  #section-messaging textarea {
    background-color: white !important;
    color: black !important;
    border: 1px solid #d1d5db !important;
  }
  
  #section-messaging input::placeholder,
  #section-messaging textarea::placeholder {
    color: #6b7280 !important;
  }
  
  #section-messaging input:focus,
  #section-messaging textarea:focus {
    border-color: #3b82f6 !important;
    ring-color: #3b82f6 !important;
    background-color: white !important;
    color: black !important;
  }
</style>
<section id="section-messaging" class="section-content bg-white border rounded-2xl shadow-sm p-5 hidden">
  <!-- Header with help text -->
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-semibold">Send SMS & Email</h2>
    <span class="text-gray-400 cursor-help" title="Send test messages to verify SMS and email functionality">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
    </span>
  </div>
  
  <div class="grid gap-4">
    <div>
      <label class="block text-sm font-medium mb-2 text-gray-900">Mobile (AU)</label>
      <input id="smsTo" type="text" class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="04XXXXXXXX or +614XXXXXXXX" />
      <div id="smsMsg" class="text-sm mt-2"></div>

      <label class="block text-sm font-medium mt-3 mb-2 text-gray-900">Message</label>
      <textarea id="smsBody" class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3" placeholder="Your message..."></textarea>
      <div id="smsBodyMsg" class="text-sm mt-2"></div>
      <div class="mt-3 flex flex-wrap items-center gap-2">
        <button id="sendSms" class="btn-primary px-5 py-2.5 rounded-lg">Send SMS</button>
        <button id="clearSms" class="btn-secondary px-5 py-2.5 rounded-lg">Clear</button>

        <span id="smsStatusMsg" class="text-sm ml-1 w-full sm:w-auto"></span>
      </div>
    </div>
    <div class="border-t pt-4">
      <label class="block text-sm font-medium mb-2 text-gray-900">Email</label>
      <input id="emailTo" type="email" class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="you@example.com" />
      <div id="emailMsg" class="text-sm mt-2"></div>

      <label class="block text-sm font-medium mt-3 mb-2 text-gray-900">Subject</label>
      <input id="emailSubj" class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Subject" />
      <div id="emailSubjMsg" class="text-sm mt-2"></div>
      <label class="block text-sm font-medium mt-3 mb-2 text-gray-900">Body</label>
      <textarea id="emailBody" class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="4" placeholder="Email text..."></textarea>
      <div id="emailBodyMsg" class="text-sm mt-2"></div>
      <div class="mt-3 flex flex-wrap items-center gap-2">
        <button id="sendEmail" class="btn-primary px-5 py-2.5 rounded-lg">Send Email</button>
        <button id="clearEmail" class="btn-secondary px-5 py-2.5 rounded-lg">Clear</button>

        <span id="emailStatusMsg" class="text-sm ml-1 w-full sm:w-auto"></span>
      </div>
    </div>
  </div>
</section>

<script>
(function() {
  // Send SMS & Email logic
  async function sendSms(){
    const to = (document.getElementById('smsTo').value || '').trim();
    const message = (document.getElementById('smsBody').value || '').trim();
    
    const toMsgEl = document.getElementById('smsMsg');         // mobile validation only
    const bodyMsgEl = document.getElementById('smsBodyMsg');   // message validation only
    const statusEl = document.getElementById('smsStatusMsg');  // sending/sent/errors

    // clear previous messages
    toMsgEl.textContent = '';
    toMsgEl.className = 'text-sm mt-2';
    bodyMsgEl.textContent = '';
    bodyMsgEl.className = 'text-sm mt-2';
    statusEl.textContent = '';
    statusEl.className = 'text-sm';

    let hasError = false;

    if (!to) {
      toMsgEl.textContent = 'Please enter mobile.';
      toMsgEl.className = 'text-sm mt-2 text-red-600';
      hasError = true;
    }

    if (!message) {
      bodyMsgEl.textContent = 'Please enter a message.';
      bodyMsgEl.className = 'text-sm mt-2 text-red-600';
      hasError = true;
    }

    // Validate mobile number (show alongside other errors)
    if (to && window.Validation?.isValidAuMobile && !window.Validation.isValidAuMobile(to)) {
      toMsgEl.textContent = 'Please enter a valid AU mobile (e.g. 04XX XXX XXX or +614XX XXX XXX)';
      toMsgEl.className = 'text-sm mt-2 text-red-600';
      hasError = true;
    }

    if (hasError) return;

    // Clear bodyMsg before sending
    bodyMsgEl.textContent = '';
    
    if (!window.Messaging?.sendSms) {
      statusEl.textContent = 'Error: messaging.js not loaded';
      statusEl.className = 'text-sm text-red-600';
      return;
    }

    statusEl.textContent = 'Sending...';
    statusEl.className = 'text-sm text-blue-400';

    const result = await window.Messaging.sendSms({ to, message });

    if (!result.ok) {
      if (result.error === 'MISSING_TO') {
        toMsgEl.textContent = 'Please enter mobile.';
        toMsgEl.className = 'text-sm mt-2 text-red-600';
      } else if (result.error === 'INVALID_MOBILE') {
        toMsgEl.textContent = 'Please enter a valid AU mobile (e.g. 04XX XXX XXX or +614XX XXX XXX)';
        toMsgEl.className = 'text-sm mt-2 text-red-600';
      } else if (result.error === 'MISSING_MESSAGE') {
        bodyMsgEl.textContent = 'Please enter a message.';
        bodyMsgEl.className = 'text-sm mt-2 text-red-600';
      } else {
        statusEl.textContent = 'Error: ' + result.error;
        statusEl.className = 'text-sm text-red-600';
      }
      return;
    }

    statusEl.textContent = '✓ Sent';
    statusEl.className = 'text-sm text-blue-400';
  }

  async function sendEmail(){
    const to = (document.getElementById('emailTo').value||'').trim();
    const subject = (document.getElementById('emailSubj').value||'').trim();
    const text = (document.getElementById('emailBody').value||'').trim();
    
    const toMsgEl = document.getElementById('emailMsg');
    const subjMsgEl = document.getElementById('emailSubjMsg');
    const bodyMsgEl = document.getElementById('emailBodyMsg');
    const statusEl = document.getElementById('emailStatusMsg');

    // clear previous messages
    toMsgEl.textContent = '';
    subjMsgEl.textContent = '';
    bodyMsgEl.textContent = '';
    statusEl.textContent = '';
    toMsgEl.className = 'text-sm mt-2';
    subjMsgEl.className = 'text-sm mt-2';
    bodyMsgEl.className = 'text-sm mt-2';
    statusEl.className = 'text-sm';

    let hasError = false;

    if (!to) {
      toMsgEl.textContent = 'Please enter email address.';
      toMsgEl.className = 'text-sm mt-2 text-red-600';
      hasError = true;
    }

    if (!subject) {
      subjMsgEl.textContent = 'Please enter subject.';
      subjMsgEl.className = 'text-sm mt-2 text-red-600';
      hasError = true;
    }

    if (!text) {
      bodyMsgEl.textContent = 'Please enter message body.';
      bodyMsgEl.className = 'text-sm mt-2 text-red-600';
      hasError = true;
    }

    // Validate email address
    if (to && window.Validation?.isValidEmail && !window.Validation.isValidEmail(to)) {
      toMsgEl.textContent = 'Please enter a valid email address';
      toMsgEl.className = 'text-sm mt-2 text-red-600';
      hasError = true;
    }

    if (hasError) return;

    // Clear field messages before sending
    subjMsgEl.textContent = '';
    bodyMsgEl.textContent = '';

    if (!window.Messaging?.sendEmail) {
      statusEl.textContent = 'Error: messaging.js not loaded';
      statusEl.className = 'text-sm text-red-600';
      return;
    }

    statusEl.textContent = 'Sending...';
    statusEl.className = 'text-sm text-blue-400';

    const result = await window.Messaging.sendEmail({
      to,
      subject,
      text
    });

    if (!result.ok) {
      if (result.error === 'MISSING_TO') {
        toMsgEl.textContent = 'Please enter email address.';
        toMsgEl.className = 'text-sm mt-2 text-red-600';
      } else if (result.error === 'INVALID_EMAIL') {
        toMsgEl.textContent = 'Please enter a valid email address.';
        toMsgEl.className = 'text-sm mt-2 text-red-600';
      } else if (result.error === 'MISSING_SUBJECT') {
        subjMsgEl.textContent = 'Please enter subject.';
        subjMsgEl.className = 'text-sm mt-2 text-red-600';
      } else if (result.error === 'MISSING_BODY') {
        bodyMsgEl.textContent = 'Please enter message body.';
        bodyMsgEl.className = 'text-sm mt-2 text-red-600';
      } else {
        statusEl.textContent = 'Error: ' + result.error;
        statusEl.className = 'text-sm text-red-600';
      }
      return;
    }

    statusEl.textContent = '✓ Email sent';
    statusEl.className = 'text-sm text-blue-400';
  }

  function clearSms() {
    document.getElementById('smsTo').value = '';
    document.getElementById('smsBody').value = '';
    document.getElementById('smsMsg').textContent = '';
    document.getElementById('smsBodyMsg').textContent = '';
    document.getElementById('smsStatusMsg').textContent = '';
  }

  function clearEmail() {
    document.getElementById('emailTo').value = '';
    document.getElementById('emailSubj').value = '';
    document.getElementById('emailBody').value = '';
    document.getElementById('emailMsg').textContent = '';
    document.getElementById('emailSubjMsg').textContent = '';
    document.getElementById('emailBodyMsg').textContent = '';
    document.getElementById('emailStatusMsg').textContent = '';
  }

  // Wire up when partial loads
  if (window.adminMessagingReady) {
    // Already initialized
  } else {
    window.adminMessagingReady = true;
    
    const initMessaging = () => {
      const sendSmsBtn = document.getElementById('sendSms');
      if (sendSmsBtn) sendSmsBtn.onclick = sendSms;
      
      const clearSmsBtn = document.getElementById('clearSms');
      if (clearSmsBtn) clearSmsBtn.onclick = clearSms;
      
      const sendEmailBtn = document.getElementById('sendEmail');
      if (sendEmailBtn) sendEmailBtn.onclick = sendEmail;
      
      const clearEmailBtn = document.getElementById('clearEmail');
      if (clearEmailBtn) clearEmailBtn.onclick = clearEmail;
    };
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initMessaging);
    } else {
      initMessaging();
    }
  }
})();
</script>
