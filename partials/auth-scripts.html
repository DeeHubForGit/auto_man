<!-- Supabase library (UMD) -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<!-- Single global client for ALL pages -->
<script src="assets/js/supabaseClient.js"></script>

<!-- partials/auth-scripts.html -->
<script>
// Guard: avoid re-initialising if this partial is included multiple times
if (!window.__authBootstrapped) {
  window.__authBootstrapped = true;

  // 1) Wait for include.js to finish injecting partials, if it exposes a hook.
  // If your include.js does not provide a hook, we polyfill a resolved one.
  window.whenIncludesDone = window.whenIncludesDone || Promise.resolve();

  // 2) Create a single Supabase client with stable storageKey.
  //    If you already have assets/js/supabaseClient.js, keep it, but ensure it only runs once.
  (function initSupabaseOnce(){
    if (window.supabaseClient) return;
    // If you keep a separate file, you can early-return here and rely on that one.
    // Inline minimal client creation to guarantee availability:
    // NOTE: assumes @supabase/supabase-js already loaded globally somewhere once.
    const supabaseUrl = window.SITE_CONFIG?.SUPABASE_URL;
    const supabaseKey = window.SITE_CONFIG?.SUPABASE_ANON_KEY;
    if (!supabaseUrl || !supabaseKey) {
      console.warn('[auth] Missing SUPABASE config in SITE_CONFIG');
      return;
    }
    window.supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        storage: window.localStorage,
        storageKey: 'sb-automansite-auth',
        debug: false  // Disable auth debug logging
      }
    });

    // Handle password recovery redirect
    window.supabaseClient.auth.onAuthStateChange((event, session) => {
      if (event === 'PASSWORD_RECOVERY' && !window.location.pathname.includes('reset-password.html')) {
        window.location.href = '/reset-password.html';
      }
    });

    // 3) Set up auth state change listener
    function handleAuthStateChange(event, session) {
      // The actual state change handling is done in the header's updateHeaderAuth()
    }

    // Set up the auth state change listener
    window.supabaseClient.auth.onAuthStateChange(handleAuthStateChange);
  })();
}
</script>
