<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Request a Booking - Auto-Man Driving School</title>
  <meta name="description" content="Request a driving lesson booking with Auto-Man Driving School." />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
  <style>
    .container { max-width: 1100px; }
    html { scroll-behavior: smooth; }
    /* Light flatpickr overrides to match site */
    .flatpickr-calendar {
      background: #ffffff !important; /* white */
      border-color: #e5e7eb !important; /* gray-200 */
      color: #111827 !important; /* gray-900 */
    }
    .flatpickr-months, .flatpickr-weekdays { background: #ffffff !important; }
    .flatpickr-day { color: #111827; border-radius: 9999px; }
    .flatpickr-day.prevMonthDay, .flatpickr-day.nextMonthDay { color: #9ca3af; }
    .flatpickr-day.today { border-color: #93c5fd; }
    .flatpickr-day:hover { background: #e0f2fe; color: #111827; border-radius: 9999px; cursor: pointer; }
    .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange {
      background: #2563eb !important; /* blue-600 */
      border-color: #2563eb !important;
      color: #ffffff !important;
    }
  </style>
  <script src="assets/config.js"></script>
  <script src="assets/include.js" defer></script>
  <!-- Load local Supabase config (git-ignored). Create assets/js/config.local.js to set
       window.SUPABASE_URL and window.SUPABASE_ANON_KEY. -->
  <script src="assets/js/config.local.js" defer></script>
  <!-- Supabase client (CDN) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.44.4/dist/umd/supabase.js" defer></script>
  <script src="assets/js/supabaseClient.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr" defer></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div data-include="partials/header.html"></div>

  <main class="py-16">
    <div class="container mx-auto px-4">
      <a href="book.html" class="inline-flex items-center text-gray-600 hover:text-gray-900 mb-6">← Back</a>
      <h1 class="text-4xl font-bold mb-2">Schedule your lesson</h1>
      <p class="text-gray-600 mb-8">Check out our availability and choose the date and time that works for you</p>

      <div class="rounded-2xl p-6 md:p-8 grid md:grid-cols-3 gap-8 bg-white border border-gray-200 shadow">
        <!-- Left: Calendar -->
        <div class="md:col-span-1">
          <h3 class="text-lg font-semibold mb-2">Select a Date and Time</h3>
          <div class="border-t border-gray-200 pt-4">
            <div id="datePicker"></div>
          </div>
        </div>

        <!-- Middle: Availability -->
        <div class="md:col-span-1">
          <h3 class="text-lg font-semibold">Availability for <span id="availDate">—</span></h3>
          <div class="text-xs text-gray-500 text-right mt-1">Australian Eastern Standard Time (AEST)</div>
          <div class="border-t border-gray-200 mt-2 pt-4">
            <div id="slots" class="flex flex-wrap gap-3"></div>
          </div>
        </div>

        <!-- Right: Service details -->
        <div class="md:col-span-1">
          <h3 class="text-lg font-semibold">Service Details</h3>
          <div class="p-4 bg-gray-50 border rounded-xl shadow-sm mt-2 space-y-3">
            <div id="serviceName" class="font-medium">Driving Lesson</div>
            <details class="text-gray-700">
              <summary class="cursor-pointer select-none">More details</summary>
              <p class="mt-2 text-sm text-gray-600">We’ll confirm availability and send you a confirmation.</p>
            </details>
            <div id="selectedMsg" class="mt-4 text-sm text-gray-700 hidden"></div>
            <div class="text-xs text-gray-500">Already a member? <a class="underline hover:text-gray-900" href="#">Log in</a></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div data-include="partials/footer.html"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function(){
      // Parse service from query and infer duration
      const params = new URLSearchParams(location.search);
      const serviceName = params.get('service') || 'Driving Lesson';
      const serviceId = params.get('service_id') || null; // optional if you have IDs
      const scheduleId = params.get('schedule_id') || null; // select a schedule to read from
      const durationMinutes = (function(s){
        const txt = (s || '').toLowerCase();
        if (txt.includes('1.5')) return 90;
        if (txt.includes('2')) return 120;
        return 60; // default
      })(serviceName);
      document.getElementById('serviceName').textContent = serviceName;

      // Flatpickr inline calendar
      const fp = flatpickr('#datePicker', {
        inline: true,
        minDate: 'today',
        altInput: false,
        dateFormat: 'Y-m-d',
        onChange: function(selectedDates){
          if (selectedDates && selectedDates[0]) renderSlots(selectedDates[0]);
        }
      });

      // Initial render for today
      const today = new Date();
      renderSlots(today);

      async function renderSlots(date){
        const slotsEl = document.getElementById('slots');
        slotsEl.innerHTML = '';
        document.getElementById('availDate').textContent = date.toLocaleDateString(undefined, { weekday:'long', day:'numeric', month:'short' });
        // Require Supabase + IDs
        const useSupabase = !!window.supabaseClient && !!scheduleId && !!serviceId;
        let slotRanges = [];
        if (useSupabase) {
          try {
            const y = date.getFullYear();
            const m = String(date.getMonth()+1).padStart(2,'0');
            const d = String(date.getDate()).padStart(2,'0');
            const dayStart = `${y}-${m}-${d}T00:00:00`;
            const dayEnd = `${y}-${m}-${d}T23:59:59`;
            const { data, error } = await window.supabaseClient
              .from('availability_slot')
              .select('id, start_at, end_at')
              .eq('schedule_id', scheduleId)
              .eq('service_id', serviceId)
              .eq('is_booked', false)
              .gte('start_at', dayStart)
              .lte('start_at', dayEnd)
              .order('start_at', { ascending: true });
            if (error) throw error;
            slotRanges = (data || []).map(r => ({
              start: new Date(r.start_at),
              end: new Date(r.end_at),
              id: r.id
            }));
          } catch (e) {
            console && console.warn && console.warn('Supabase slots error:', e.message || e);
          }
        } else {
          slotsEl.innerHTML = '<div class="text-sm text-amber-600">Live availability is not configured. Please provide schedule_id and service_id in the URL and ensure Supabase config is loaded.</div>';
          return;
        }

        let selectedBtn = null;
        const msgEl = document.getElementById('selectedMsg');
        for (const r of slotRanges){
          const label = r.start;
          const endLbl = r.end;
          const labelStr = label.toLocaleTimeString([], {hour: 'numeric', minute: '2-digit', hour12: true});
          const endStr = endLbl.toLocaleTimeString([], {hour: 'numeric', minute: '2-digit', hour12: true});

          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'px-5 py-2 rounded-full bg-blue-600 text-white font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300';
          btn.textContent = `${labelStr}`;
          btn.addEventListener('click', () => {
            // highlight selection
            if (selectedBtn) selectedBtn.classList.remove('ring-4','ring-blue-300');
            btn.classList.add('ring-4','ring-blue-300');
            selectedBtn = btn;
            const dateStr = date.toLocaleDateString(undefined, { weekday:'long', day:'numeric', month:'long', year:'numeric' });
            msgEl.innerHTML = `Timeslot selected:<br><strong>${serviceName}</strong><br>${dateStr} at ${labelStr}`;
            msgEl.classList.remove('hidden');
          });
          slotsEl.appendChild(btn);
        }
        if (!slotsEl.children.length){
          slotsEl.innerHTML = '<div class="text-gray-500">No availability for this date.</div>';
        }

        // Clear message if no slots
        if (!slotsEl.children.length) {
          msgEl.classList.add('hidden');
          msgEl.textContent = '';
        }
      }

      // No email sending for now per request
    });
  </script>
</body>
</html>
