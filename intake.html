<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Complete Your Profile | Auto-Man Driving School</title>
  <meta name="description" content="Complete your profile to get started with Auto-Man Driving School" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="assets/theme.css" rel="stylesheet">
  <script src="assets/config.js"></script>
  <script src="assets/js/modal.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/js/supabaseClient.js"></script>
  <style>
    .wizard-step {
      display: none;
      animation: fadeIn 0.4s ease-in;
    }
    .wizard-step.active {
      display: block;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .progress-bar {
      transition: width 0.3s ease;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
  
  <div class="w-full max-w-2xl">
    <!-- Progress Bar -->
    <div class="mb-8">
      <div class="bg-gray-800 rounded-full h-2.5 shadow-inner">
        <div id="progressBar" class="progress-bar bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
      </div>
      <p class="text-center mt-3 text-sm font-semibold text-white">
        <span id="stepIndicator">Step 1 of 3</span>
      </p>
    </div>

    <!-- Wizard Container (Card) -->
    <div class="rounded-2xl shadow-2xl p-8 md:p-12" style="background-color: var(--card); border: 1px solid var(--border);">
      
      <!-- Hidden fields for name and mobile (populated from booking data) -->
      <input type="hidden" id="firstName" />
      <input type="hidden" id="lastName" />
      <input type="hidden" id="mobile" />
      
      <!-- Step 1: Licence/Permit Number -->
      <div class="wizard-step active" data-step="1">
        <div class="mb-8">
          <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-3">Welcome! Let's complete your profile üëã</h1>
          <p class="text-lg text-gray-600">Enter your learner's permit or licence number</p>
        </div>
        
        <div class="mb-8">
          <label for="licenseNumber" class="block text-sm font-medium text-gray-700 mb-2">Licence/Permit Number *</label>
          <input 
            type="text" 
            id="licenseNumber" 
            required
            class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg focus:border-blue-600 transition-colors text-black"
            placeholder="Enter your licence or permit number"
          />
          <p class="text-sm text-gray-500 mt-2">You'll need to show this at your first lesson</p>
        </div>

        <div class="flex justify-end mt-6">
          <button onclick="nextStep()" class="btn btn-primary px-8 py-3">
            Next ‚Üí
          </button>
        </div>
      </div>

      <!-- Step 2: Medical Conditions -->
      <div class="wizard-step" data-step="2">
        <div class="mb-8">
          <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-3 flex items-center gap-3">üè• Medical information</h2>
          <p class="text-lg text-gray-600">Do you have any medical conditions that may affect your driving?</p>
        </div>
        
        <div class="mb-8">
          <label for="medicalConditions" class="block text-sm font-medium text-gray-700 mb-2">Medical Conditions (Optional)</label>
          <textarea 
            id="medicalConditions" 
            rows="4"
            class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg focus:border-blue-600 transition-colors resize-none text-black placeholder:text-gray-400"
            placeholder="E.g. epilepsy, diabetes, vision impairment, etc. (or leave blank if none)"
          ></textarea>
          <p class="text-sm text-gray-500 mt-2">This helps us provide better support during your lessons</p>
        </div>

        <div class="flex justify-between">
          <button onclick="prevStep()" class="btn btn-secondary px-6 py-3">
            ‚Üê Back
          </button>
          <button onclick="nextStep()" class="btn btn-primary px-8 py-3">
            Next ‚Üí
          </button>
        </div>
      </div>

      <!-- Step 3: Driver Profile -->
      <div class="wizard-step" data-step="3">
        <div class="mb-8">
          <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-3 flex items-center gap-3">üéØ Almost done!</h2>
          <p class="text-lg text-gray-600">Tell us about your driving experience</p>
        </div>
        
        <div class="mb-8 space-y-4">
          <p class="text-sm font-medium text-gray-700 mb-3">Select all that apply:</p>
          
          <label class="flex items-start gap-3 p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-blue-400 transition-colors">
            <input type="checkbox" id="isBeginner" class="mt-1 w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
            <div>
              <span class="font-semibold text-gray-900">I am a complete beginner</span>
              <p class="text-sm text-gray-600">We'll start with the basics and build your confidence</p>
            </div>
          </label>

          <label class="flex items-start gap-3 p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-blue-400 transition-colors">
            <input type="checkbox" id="isAnxious" class="mt-1 w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
            <div>
              <span class="font-semibold text-gray-900">I am an anxious or nervous driver</span>
              <p class="text-sm text-gray-600">We'll provide extra support and patience</p>
            </div>
          </label>

          <label class="flex items-start gap-3 p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-blue-400 transition-colors">
            <input type="checkbox" id="isSenior" class="mt-1 w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
            <div>
              <span class="font-semibold text-gray-900">I am a senior driver</span>
              <p class="text-sm text-gray-600">We'll provide help and support as you prepare for a retest</p>
            </div>
          </label>

          <label class="flex items-start gap-3 p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-blue-400 transition-colors">
            <input type="checkbox" id="isOther" class="mt-1 w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" onchange="toggleOtherText()">
            <div class="flex-1">
              <span class="font-semibold text-gray-900">I have other learning needs or preferences</span>
              <p class="text-sm text-gray-600 mb-2">Please tell us anything else that would help us tailor your lessons</p>
              <input 
                type="text" 
                id="otherDetails" 
                disabled
                class="w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:border-blue-600 transition-colors disabled:bg-gray-100 disabled:cursor-not-allowed text-black"
                placeholder="Please specify..."
              />
            </div>
          </label>
        </div>

        <div class="flex justify-between mt-6">
          <button onclick="prevStep()" class="btn btn-secondary px-6 py-3">
            ‚Üê Back
          </button>
          <button onclick="submitForm()" class="btn btn-primary px-8 py-3">
            Complete Profile
          </button>
        </div>
      </div>

      <!-- Success Message (hidden initially) -->
      <div id="successMessage" class="hidden text-center">
        <div class="mb-6">
          <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
          <h2 class="text-3xl font-bold text-gray-900 mb-3">All set! üéâ</h2>
          <p class="text-lg text-gray-600 mb-6">Your profile has been completed successfully</p>
        </div>
        <a href="portal.html" class="btn btn-primary px-8 py-3">
          Go to Dashboard
        </a>
      </div>

    </div>

    <!-- Skip Link (optional) -->
    <div class="text-center mt-6 space-y-2">
      <a href="#" onclick="skipIntake(); return false;" class="text-sm font-semibold text-gray-300 hover:text-white underline block">
        Skip for now (you can complete this later)
      </a>
      <button 
        id="resetButton" 
        onclick="resetFormOnly(); return false;" 
        class="btn btn-secondary text-xs px-3 py-1.5"
        style="display: none;">
        Reset Form
      </button>
    </div>
    <script>
      // Only show reset button on localhost
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        document.getElementById('resetButton').style.display = 'inline-flex';
      }
    </script>
  </div>

  <script>
    let currentStep = 1;
    const totalSteps = 3;
    let currentClientId = null; // Store client ID for DB operations
    let debounceTimer = null; // For debouncing text input

    // Wait for the SHARED Supabase client (from auth-scripts or supabaseClient.js)
    async function waitForSupabaseClient(timeoutMs = 5000) {
      const t0 = Date.now();
      while (!window.supabaseClient && Date.now() - t0 < timeoutMs) {
        await new Promise(r => setTimeout(r, 100));
      }
      if (!window.supabaseClient) {
        console.error('[intake] ‚ùå window.supabaseClient not available after waiting');
      }
      return window.supabaseClient;
    }

    // Get current client ID
    async function getClientId() {
      if (currentClientId) return currentClientId;
      
      const supabase = await waitForSupabaseClient();
      if (!supabase) return null;
      
      try {
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) return null;
        
        const { data: client, error: clientError } = await supabase
          .from('client')
          .select('id')
          .eq('email', user.email)
          .single();
        
        if (clientError || !client?.id) return null;
        
        currentClientId = client.id;
        console.log('[intake] ‚úÖ Client ID:', currentClientId);
        return currentClientId;
      } catch (err) {
        console.error('[intake] ‚ùå Error getting client ID:', err);
        return null;
      }
    }

    // Fetch intake data from DB and populate form
    async function loadIntakeDataFromDb() {
      console.log('[intake] üì• Loading intake data from DB...');
      
      const supabase = await waitForSupabaseClient();
      if (!supabase) {
        console.log('[intake] ‚ùå Supabase not initialized');
        return null;
      }
      
      const clientId = await getClientId();
      if (!clientId) {
        console.log('[intake] ‚ùå No client ID found');
        return null;
      }
      
      try {
        const { data: client, error } = await supabase
          .from('client')
          .select('first_name, last_name, mobile, learner_permit_number, medical_conditions, is_beginner, is_anxious_nervous, is_senior, learning_needs_other, intake_step, intake_completed')
          .eq('id', clientId)
          .single();
        
        if (error) {
          console.error('[intake] ‚ùå Error fetching client data:', error);
          return null;
        }
        
        if (client) {
          console.log('[intake] ‚úÖ DB data loaded:', client);
          
          // Populate hidden fields
          document.getElementById('firstName').value = client.first_name || '';
          document.getElementById('lastName').value = client.last_name || '';
          document.getElementById('mobile').value = client.mobile || '';
          
          // Populate intake fields
          document.getElementById('licenseNumber').value = client.learner_permit_number || '';
          document.getElementById('medicalConditions').value = client.medical_conditions || '';
          document.getElementById('isBeginner').checked = client.is_beginner || false;
          document.getElementById('isAnxious').checked = client.is_anxious_nervous || false;
          document.getElementById('isSenior').checked = client.is_senior || false;
          
          // Handle other needs
          if (client.learning_needs_other) {
            document.getElementById('isOther').checked = true;
            document.getElementById('otherDetails').value = client.learning_needs_other;
            document.getElementById('otherDetails').disabled = false;
          } else {
            document.getElementById('isOther').checked = false;
            document.getElementById('otherDetails').value = '';
            document.getElementById('otherDetails').disabled = true;
          }
          
          return client;
        }
      } catch (err) {
        console.error('[intake] ‚ùå Error loading intake data:', err);
      }
      
      return null;
    }

    // Fetch booking data to pre-populate name/mobile if DB is blank
    async function fetchBookingDataIfNeeded() {
      const supabase = await waitForSupabaseClient();
      if (!supabase) return;
      
      const clientId = await getClientId();
      if (!clientId) return;
      
      try {
        // Get the most recent booking for this client
        const { data: bookings, error: bookingError } = await supabase
          .from('booking')
          .select('first_name, last_name, mobile')
          .eq('client_id', clientId)
          .order('start_time', { ascending: false })
          .limit(1);

        if (!bookingError && bookings && bookings.length > 0) {
          const booking = bookings[0];
          console.log('[intake] üìã Latest booking:', booking);
          
          // Only update if fields are empty
          const firstNameInput = document.getElementById('firstName');
          const lastNameInput = document.getElementById('lastName');
          const mobileInput = document.getElementById('mobile');
          
          if (!firstNameInput.value && booking.first_name) firstNameInput.value = booking.first_name;
          if (!lastNameInput.value && booking.last_name) lastNameInput.value = booking.last_name;
          if (!mobileInput.value && booking.mobile) mobileInput.value = booking.mobile;
        }
      } catch (err) {
        console.error('[intake] ‚ùå Error fetching booking data:', err);
      }
    }

    // Update intake_step in DB
    async function updateStepInDb(step) {
      console.log(`[intake] üíæ Updating step to ${step} in DB...`);
      
      const supabase = await waitForSupabaseClient();
      if (!supabase) return false;
      
      const clientId = await getClientId();
      if (!clientId) return false;
      
      try {
        const { error } = await supabase
          .from('client')
          .update({
            intake_step: step,
            updated_at: new Date().toISOString()
          })
          .eq('id', clientId);
        
        if (error) {
          console.error('[intake] ‚ùå Error updating step:', error);
          return false;
        }
        
        console.log(`[intake] ‚úÖ Step updated to ${step}`);
        return true;
      } catch (err) {
        console.error('[intake] ‚ùå Error updating step:', err);
        return false;
      }
    }

    // Save Step 1 data to DB
    async function saveStep1ToDb() {
      console.log('[intake] üíæ Saving Step 1 to DB...');
      
      const supabase = await waitForSupabaseClient();
      if (!supabase) {
        Modal.error('Unable to connect to database. Please try again.');
        return false;
      }
      
      const clientId = await getClientId();
      if (!clientId) {
        Modal.error('Client ID not found. Please refresh and try again.');
        return false;
      }
      
      const licenseNumber = document.getElementById('licenseNumber').value.trim().toUpperCase();
      
      try {
        const { error } = await supabase
          .from('client')
          .update({
            learner_permit_number: licenseNumber,
            updated_at: new Date().toISOString()
          })
          .eq('id', clientId);
        
        if (error) {
          console.error('[intake] ‚ùå Error saving Step 1:', error);
          Modal.error('Failed to save. Please try again.');
          return false;
        }
        
        console.log('[intake] ‚úÖ Step 1 saved successfully');
        return true;
      } catch (err) {
        console.error('[intake] ‚ùå Error saving Step 1:', err);
        Modal.error('An error occurred. Please try again.');
        return false;
      }
    }

    // Save Step 2 data to DB
    async function saveStep2ToDb() {
      console.log('[intake] üíæ Saving Step 2 to DB...');
      
      const supabase = await waitForSupabaseClient();
      if (!supabase) {
        Modal.error('Unable to connect to database. Please try again.');
        return false;
      }
      
      const clientId = await getClientId();
      if (!clientId) {
        Modal.error('Client ID not found. Please refresh and try again.');
        return false;
      }
      
      const medicalConditions = document.getElementById('medicalConditions').value.trim() || null;
      
      try {
        const { error } = await supabase
          .from('client')
          .update({
            medical_conditions: medicalConditions,
            updated_at: new Date().toISOString()
          })
          .eq('id', clientId);
        
        if (error) {
          console.error('[intake] ‚ùå Error saving Step 2:', error);
          Modal.error('Failed to save. Please try again.');
          return false;
        }
        
        console.log('[intake] ‚úÖ Step 2 saved successfully');
        return true;
      } catch (err) {
        console.error('[intake] ‚ùå Error saving Step 2:', err);
        Modal.error('An error occurred. Please try again.');
        return false;
      }
    }

    // Save Step 3 checkbox to DB immediately
    async function saveCheckboxToDb(field, value) {
      console.log(`[intake] üíæ Saving ${field} = ${value} to DB...`);
      
      const supabase = await waitForSupabaseClient();
      if (!supabase) return;
      
      const clientId = await getClientId();
      if (!clientId) return;
      
      try {
        const updateData = {
          [field]: value,
          updated_at: new Date().toISOString()
        };
        
        const { error } = await supabase
          .from('client')
          .update(updateData)
          .eq('id', clientId);
        
        if (error) {
          console.error(`[intake] ‚ùå Error saving ${field}:`, error);
        } else {
          console.log(`[intake] ‚úÖ ${field} saved successfully`);
        }
      } catch (err) {
        console.error(`[intake] ‚ùå Error saving ${field}:`, err);
      }
    }

    // Save other details text to DB (debounced)
    function saveOtherDetailsToDb() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(async () => {
        const otherDetails = document.getElementById('otherDetails').value.trim() || null;
        await saveCheckboxToDb('learning_needs_other', otherDetails);
      }, 1000); // 1 second debounce
    }

    function updateProgress() {
      const progress = (currentStep / totalSteps) * 100;
      document.getElementById('progressBar').style.width = progress + '%';
      document.getElementById('stepIndicator').textContent = `Step ${currentStep} of ${totalSteps}`;
    }

    async function showStep(step, skipDbUpdate = false) {
      document.querySelectorAll('.wizard-step').forEach(el => el.classList.remove('active'));
      const stepEl = document.querySelector(`[data-step="${step}"]`);
      if (stepEl) stepEl.classList.add('active');
      currentStep = step;
      updateProgress();
      
      // Load fresh data from DB when showing a step
      await loadIntakeDataFromDb();
      
      // Update step in DB (unless this is initial load)
      if (!skipDbUpdate) {
        await updateStepInDb(step);
      }
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function validateStep(step) {
      if (step === 1) {
        const license = document.getElementById('licenseNumber').value.trim();
        if (!license) {
          Modal.error('Please enter your licence or permit number');
          return false;
        }
      }
      // Step 2 (medical) is optional - no validation needed
      // Step 3 (driver profile) is optional - no validation needed
      return true;
    }

    async function nextStep() {
      if (!validateStep(currentStep)) return;
      
      // Save to DB before advancing
      let saved = false;
      if (currentStep === 1) {
        saved = await saveStep1ToDb();
      } else if (currentStep === 2) {
        saved = await saveStep2ToDb();
      } else {
        saved = true; // Step 3 saves happen on checkbox change
      }
      
      if (!saved) return; // Don't advance if save failed
      
      if (currentStep < totalSteps) {
        showStep(currentStep + 1);
      }
    }

    function prevStep() {
      if (currentStep > 1) {
        showStep(currentStep - 1);
      }
    }

    function skipIntake() {
      // Set a session flag to indicate user skipped intake
      sessionStorage.setItem('intake_skipped', 'true');
      // Redirect to portal
      window.location.href = 'portal.html';
    }

    async function resetFormOnly() {
      // True reset: Wipe DB intake fields back to NULL
      console.log('[intake] üîÑ Resetting form (wiping DB intake fields to NULL)...');
      
      const supabase = await waitForSupabaseClient();
      if (!supabase) {
        alert('Unable to connect to database.');
        return;
      }
      
      const clientId = await getClientId();
      if (!clientId) {
        alert('Client ID not found.');
        return;
      }
      
      if (!confirm('This will permanently clear all your intake form data. Continue?')) {
        return;
      }
      
      try {
        const { error } = await supabase
          .from('client')
          .update({
            learner_permit_number: null,
            medical_conditions: null,
            is_beginner: false,
            is_anxious_nervous: false,
            is_senior: false,
            learning_needs_other: null,
            intake_completed: false,
            intake_step: 1,
            updated_at: new Date().toISOString()
          })
          .eq('id', clientId);
        
        if (error) {
          console.error('[intake] ‚ùå Error resetting form:', error);
          alert('Failed to reset form. Please try again.');
          return;
        }
        
        console.log('[intake] ‚úÖ Form reset successfully, DB wiped');
        
        // Clear all form fields
        document.getElementById('licenseNumber').value = '';
        document.getElementById('medicalConditions').value = '';
        document.getElementById('isBeginner').checked = false;
        document.getElementById('isAnxious').checked = false;
        document.getElementById('isSenior').checked = false;
        document.getElementById('isOther').checked = false;
        document.getElementById('otherDetails').value = '';
        document.getElementById('otherDetails').disabled = true;
        
        // Go back to step 1
        currentStep = 1;
        await showStep(1, true); // Skip DB update since we just set it to 1
        
        alert('Form reset complete! All intake data has been cleared.');
        document.getElementById('licenseNumber').focus();
      } catch (err) {
        console.error('[intake] ‚ùå Error resetting form:', err);
        alert('An error occurred. Please try again.');
      }
    }

    function toggleOtherText() {
      const checkbox = document.getElementById('isOther');
      const textbox = document.getElementById('otherDetails');
      textbox.disabled = !checkbox.checked;
      if (checkbox.checked) {
        textbox.focus();
      } else {
        textbox.value = '';
        // Clear the DB field if unchecked
        saveCheckboxToDb('learning_needs_other', null);
      }
    }

    async function submitForm() {
      const supabase = await waitForSupabaseClient();
      if (!supabase) {
        Modal.error('Unable to connect to database. Please try again later.');
        return;
      }

      // Get form data
      const formData = {
        first_name: document.getElementById('firstName').value.trim(),
        last_name: document.getElementById('lastName').value.trim(),
        mobile: document.getElementById('mobile').value.trim(),
        learner_permit_number: document.getElementById('licenseNumber').value.trim().toUpperCase(),
        medical_conditions: document.getElementById('medicalConditions').value.trim() || null,
        is_beginner: document.getElementById('isBeginner').checked,
        is_anxious_nervous: document.getElementById('isAnxious').checked,
        is_senior: document.getElementById('isSenior').checked,
        learning_needs_other: document.getElementById('isOther').checked ? document.getElementById('otherDetails').value.trim() : null,
        intake_completed: true,
        updated_at: new Date().toISOString()
      };

      try {
        // Get client ID
        const clientId = await getClientId();
        if (!clientId) {
          Modal.error('Client ID not found. Please refresh and try again.');
          return;
        }

        // Update client record using ID and reset step to 1
        const { error } = await supabase
          .from('client')
          .update({
            ...formData,
            intake_step: 1
          })
          .eq('id', clientId);

        if (error) {
          console.error('Error updating profile:', error);
          Modal.error('There was an error saving your profile. Please try again.');
          return;
        }

        // Clear the skip flag since they completed it
        sessionStorage.removeItem('intake_skipped');
        
        // Redirect to portal
        window.location.href = 'portal.html';
        
      } catch (err) {
        console.error('Unexpected error:', err);
        Modal.error('An unexpected error occurred. Please try again.');
      }
    }

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        const activeStep = document.querySelector('.wizard-step.active');
        if (activeStep) {
          const nextBtn = activeStep.querySelector('button[onclick*="next"]');
          const submitBtn = activeStep.querySelector('button[onclick*="submit"]');
          if (nextBtn && !document.activeElement.matches('textarea')) {
            e.preventDefault();
            nextBtn.click();
          } else if (submitBtn) {
            e.preventDefault();
            submitBtn.click();
          }
        }
      }
    });

    // Auto-uppercase licence number as user types
    document.getElementById('licenseNumber').addEventListener('input', function(e) {
      this.value = this.value.toUpperCase();
    });

    // Step 3: Save checkboxes immediately to DB
    document.getElementById('isBeginner').addEventListener('change', function() {
      if (currentStep === 3) {
        saveCheckboxToDb('is_beginner', this.checked);
      }
    });

    document.getElementById('isAnxious').addEventListener('change', function() {
      if (currentStep === 3) {
        saveCheckboxToDb('is_anxious_nervous', this.checked);
      }
    });

    document.getElementById('isSenior').addEventListener('change', function() {
      if (currentStep === 3) {
        saveCheckboxToDb('is_senior', this.checked);
      }
    });

    document.getElementById('isOther').addEventListener('change', function() {
      toggleOtherText();
    });

    // Debounce text input for other details
    document.getElementById('otherDetails').addEventListener('input', function() {
      if (currentStep === 3 && !this.disabled) {
        saveOtherDetailsToDb();
      }
    });

    // Load intake data from DB on page load
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('[intake] üöÄ Page loaded, starting initialization...');
      
      // Wait for auth to initialize
      await new Promise(r => setTimeout(r, 500));
      
      // Load all intake data from DB (source of truth)
      const clientData = await loadIntakeDataFromDb();
      
      // Determine which step to show
      let resumeStep = 1;
      if (clientData) {
        if (clientData.intake_completed) {
          // If completed, start fresh at step 1
          resumeStep = 1;
          console.log('[intake] ‚úÖ Intake already completed, starting at step 1');
        } else {
          // Resume at saved step (clamped to 1-3)
          resumeStep = Math.max(1, Math.min(3, clientData.intake_step || 1));
          console.log(`[intake] üìç Resuming at step ${resumeStep}`);
        }
      }
      
      // Show the appropriate step (skip DB update on initial load)
      await showStep(resumeStep, true);
      
      // If name/mobile still blank, try to get from booking
      await fetchBookingDataIfNeeded();
      
      document.getElementById('licenseNumber').focus();
    });
  </script>
  <!-- Google Analytics -->
  <div data-include="partials/analytics.html"></div>
</body>
</html>
