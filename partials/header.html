<!-- header.html -->
<style>
  /* Anti-flicker + reserve space so content below never jumps */
  html.loading * { transition: none !important; }
  header { min-height: 70px; }

  /* ---------- Header sizing guardrails ---------- */
  /* Stop page-level "leading-*" utilities from inflating header */
  header .nav-link,
  header nav a,
  header .btn { line-height: 1.25rem !important; } /* 20px */

  /* Consistent button height/shape in header */
  header .btn {
    height: 2.25rem;          /* 36px */
    padding: 0 1rem;          /* horizontal stays the same */
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  /* If a large button is ever placed in header, keep it tidy too */
  header .btn.btn-lg {
    height: 2.5rem;           /* 40px */
    padding: 0 1.125rem;
  }
</style>

<header class="bg-white shadow-sm sticky top-0 z-50">
  <div class="container mx-auto px-4 py-3 flex items-center justify-between">
    <!-- Left: logo + title grouped -->
    <div class="flex items-center gap-2 md:gap-3 min-w-0">
      <img src="images/auto-man-small-logo-website-header.png" alt="Auto-Man Driving School logo" class="h-8 w-auto" decoding="async" fetchpriority="high" />
      <a href="index.html" class="logo text-lg md:text-xl font-bold tracking-tight whitespace-nowrap" style="font-family: Tahoma, Verdana, sans-serif;">Auto-Man Driving School</a>
    </div>

    <!-- Desktop nav -->
    <nav class="hidden md:flex items-center gap-6 text-sm relative">
      <!-- Services + dropdown -->
      <div class="relative group">
        <a id="nav-services" href="index.html#services" class="text-light-hover-blue inline-flex items-center gap-1">
          Services
          <svg aria-hidden="true" focusable="false" width="14" height="14" viewBox="0 0 20 20" class="mt-[1px]">
            <path d="M6 8l4 4 4-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </a>

        <!-- Desktop dropdown -->
        <div
          id="nav-services-menu"
          class="absolute left-0 top-full w-64 bg-white border rounded-lg shadow-lg py-2 z-50
                 hidden group-hover:block hover:block focus-within:block"
        >
          <a class="block px-4 py-2 hover:bg-blue-50" href="beginner-drivers.html">Beginner Drivers</a> 
          <a class="block px-4 py-2 hover:bg-blue-50" href="driving-test-package.html">Driving Test Package</a>
          <a class="block px-4 py-2 hover:bg-blue-50" href="overseas-licence.html">Overseas Licence Conversion</a>
          <a class="block px-4 py-2 hover:bg-blue-50" href="nervous-drivers.html">Nervous Drivers</a>
          <a class="block px-4 py-2 hover:bg-blue-50" href="senior-drivers.html">Senior Driver Retests</a>
          <a class="block px-4 py-2 hover:bg-blue-50" href="special-requirements.html">Special Requirements</a>
        </div>
      </div>

      <a href="about.html" class="text-light-hover-blue">About Us</a>
      <a href="service-areas.html" class="text-light-hover-blue">Service Areas</a>
      <a href="faq.html" class="text-light-hover-blue">FAQs</a>
      <!-- <a href="index.html#pricing" class="hover:text-blue-600">Lesson Packages</a> -->
      <a href="index.html#contact" class="text-light-hover-blue">Contact</a>
    </nav>

    <!-- Auth controls (middle cluster) -->
    <div class="hidden md:flex items-center gap-3">
      <!-- Sign Up as text link - hidden by default -->
      <a href="signup.html" id="signupBtn" 
        class="hidden md:inline-block btn btn-secondary">
        Sign Up
      </a>

      <!-- Login as button - hidden by default -->
      <a href="login.html" id="loginBtn" class="hidden md:inline-block btn btn-primary-light">Login</a>
      <!-- Log Out button (desktop) - hidden by default -->
      <button id="logoutBtnHeader" class="hidden md:inline-block btn btn-secondary">Log Out</button>
      <!-- My Account - hidden by default -->
      <a href="portal.html" id="portalBtnHeader" class="hidden md:inline-block text-light-hover-blue transition-colors">My Account</a>
      <a href="admin.html" id="adminBtn" class="hidden hover:text-blue-600 font-semibold text-blue-400">Admin</a>
    </div>

    <div class="flex items-center gap-4">
      <a href="tel:{{PHONE_LINK}}" 
        class="hidden md:inline-flex items-center gap-2 text-blue-dark font-semibold">
        ðŸ“ž {{PHONE}}
      </a>

      <!-- WhatsApp button (placeholder for now) -->
      <a href="https://wa.me/61403632313" target="_blank" rel="noopener noreferrer"
        class="hidden md:inline-block btn btn-secondary">
        <i class="fa-brands fa-whatsapp" aria-hidden="true"></i> WhatsApp
      </a>

      <!-- Book Now as primary CTA -->
      <a href="booking.html"
        class="hidden md:inline-block btn btn-primary btn-lg">
        Book Now
      </a>
      <!-- Mobile Book button -->
      <a href="booking.html" class="md:hidden bg-blue-600 text-white px-3 py-2 rounded-lg shadow hover:bg-blue-700 text-sm ml-2">Book</a>
      <button id="menuToggleBtn" type="button" class="md:hidden px-3 py-2 border rounded select-none touch-manipulation z-50 pointer-events-auto" style="-webkit-tap-highlight-color: transparent;" onclick="toggleMenu()" aria-label="Toggle menu" aria-expanded="false" aria-controls="mobileMenu" role="button">â˜°</button>
    </div>
  </div>

  <!-- Mobile Nav -->
  <div id="mobileMenu"
      class="md:hidden hidden fixed inset-x-0 top-14 z-50 bg-white text-slate-900 border-t shadow-lg">
    <nav class="px-4 py-3 flex flex-col gap-2 text-base">
      <!-- Services (collapsible) -->
      <button id="mobileServicesBtn"
              type="button"
              class="flex items-center justify-between w-full py-2 font-medium"
              aria-controls="mobileServicesSubmenu"
              aria-expanded="false"
              onclick="(function(e){e.preventDefault();e.stopPropagation();var s=document.getElementById('mobileServicesSubmenu');var btn=document.getElementById('mobileServicesBtn');if(!s||!btn)return false;var hidden=s.classList.toggle('hidden');if(!hidden){s.classList.add('block');}else{s.classList.remove('block');}btn.setAttribute('aria-expanded', hidden?'false':'true');var c=btn.querySelector('[data-caret]');if(c)c.classList.toggle('rotate-180',!hidden);return false;})(event)">
        <span>Services</span>
        <span data-caret class="transition-transform transform">â–¾</span>
      </button>

      <div id="mobileServicesSubmenu" class="hidden pl-3 border-l flex flex-col gap-2">
        <a class="block py-1 hover:underline" href="index.html#services" onclick="window.closeMenu?window.closeMenu():null">All Services</a>
        <a class="block py-1 hover:underline" href="beginner-drivers.html" onclick="window.closeMenu?window.closeMenu():null">Beginner Drivers</a>
        <a class="block py-1 hover:underline" href="driving-test-package.html" onclick="window.closeMenu?window.closeMenu():null">Driving Test Package</a>
        <a class="block py-1 hover:underline" href="overseas-licence.html" onclick="window.closeMenu?window.closeMenu():null">Overseas Licence Conversion</a>
        <a class="block py-1 hover:underline" href="nervous-drivers.html" onclick="window.closeMenu?window.closeMenu():null">Nervous Drivers</a>
        <a class="block py-1 hover:underline" href="senior-drivers.html" onclick="window.closeMenu?window.closeMenu():null">Senior Driver Retests</a>
        <a class="block py-1 hover:underline" href="special-requirements.html" onclick="window.closeMenu?window.closeMenu():null">Special Requirements</a>
      </div>

      <a class="block py-2 hover:underline" href="about.html" onclick="window.closeMenu?window.closeMenu():null">About Us</a>
      <a class="block py-2 hover:underline" href="service-areas.html" onclick="window.closeMenu?window.closeMenu():null">Service Areas</a>
      <a class="block py-2 hover:underline" href="faq.html" onclick="window.closeMenu?window.closeMenu():null">FAQs</a>
      <a class="block py-2 hover:underline" href="index.html#contact" onclick="window.closeMenu?window.closeMenu():null">Contact</a>

      <!-- Auth -->
      <a href="signup.html" id="signupBtnMobile"
        class="mt-1 px-4 py-2 rounded text-gray-700 border border-gray-300 hover:bg-gray-50 text-center"
        onclick="window.closeMenu?window.closeMenu():null">Sign Up</a>
      <a href="login.html" id="loginBtnMobile"
        class="px-4 py-2 rounded border border-blue-600 text-blue-600 hover:bg-blue-50 text-center"
        onclick="window.closeMenu?window.closeMenu():null">Login</a>
      <a href="portal.html" id="portalBtnMobile"
        class="hidden px-4 py-2 rounded border border-gray-300 text-gray-800 hover:bg-gray-50 text-center"
        onclick="window.closeMenu?window.closeMenu():null">My Account</a>
      <a href="admin.html" id="adminBtnMobile"
        class="hidden px-4 py-2 rounded border border-orange-600 text-orange-600 hover:bg-orange-50 text-center font-semibold"
        onclick="window.closeMenu?window.closeMenu():null">Admin</a>
      <button id="logoutBtnMobile"
        class="hidden px-4 py-2 rounded border border-gray-300 text-gray-800 hover:bg-gray-50 text-center">Log Out</button>

      <!-- Phone & CTA -->
      <a href="tel:{{PHONE_LINK}}"
        class="flex items-center gap-2 py-2 font-semibold text-blue-700"
        onclick="window.closeMenu?window.closeMenu():null">ðŸ“ž Call {{PHONE}}</a>

      <a href="booking.html"
        class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 text-center"
        onclick="window.closeMenu?window.closeMenu():null">Book Now</a>
    </nav>
  </div>

</header>

<script>
// Anti-flicker: disable transitions on first paint
document.documentElement.classList.add('loading');
addEventListener('DOMContentLoaded', () =>
  requestAnimationFrame(() => document.documentElement.classList.remove('loading'))
);

// Global logout function - resilient with direct API fallback
window.headerLogout = function headerLogout() {
  // Wait for Modal to be available
  if (window.Modal && window.Modal.confirm) {
    window.Modal.confirm(
      'Are you sure you want to log out?',
      window.performLogout,
      null,
      'Log Out'
    );
  } else {
    // Modal not loaded yet, wait a bit and try again
    setTimeout(function() {
      if (window.Modal && window.Modal.confirm) {
        window.Modal.confirm(
          'Are you sure you want to log out?',
          window.performLogout,
          null,
          'Log Out'
        );
      } else {
        // Fallback: just logout without confirmation
        console.warn('[logout] Modal not available, logging out without confirmation');
        window.performLogout();
      }
    }, 100);
  }
};

// Actual logout implementation - make it global so Modal callback can access it
window.performLogout = async function performLogout() {
  const url = window.SUPABASE_URL || window.supabaseUrl || (window.supabaseClient && window.supabaseClient.rest && window.supabaseClient.rest.url?.replace('/rest/v1','').replace(/^\/+|\/+$/g,''));
  const key = window.SUPABASE_ANON_KEY || window.supabaseAnonKey;

  try {
    const { data: { session } } = await window.supabaseClient.auth.getSession().catch(() => ({data:{}}));

    // Try server logout (2s max). If this stalls we still continue.
    if (session?.access_token && url && key) {
      await Promise.race([
        fetch(`${url}/auth/v1/logout`, {
          method: 'POST',
          headers: { apikey: key, Authorization: `Bearer ${session.access_token}` },
          keepalive: true  // improves chances during navigation
        }),
        new Promise((_, rej) => setTimeout(() => rej(new Error('signOut timeout')), 2000))
      ]).catch(err => console.warn('[logout] server logout issue:', err?.message || err));
    } else {
      // Fallback to SDK with a 2s cap
      await Promise.race([
        window.supabaseClient.auth.signOut({ scope: 'global' }),
        new Promise((_, rej) => setTimeout(() => rej(new Error('SDK signOut timeout')), 2000))
      ]).catch(err => console.warn('[logout] SDK logout issue:', err?.message || err));
    }
  } finally {
    // Local cleanup (always)
    try {
      Object.keys(localStorage).forEach(k => {
        if (k.startsWith('sb-') || k.includes('supabase')) localStorage.removeItem(k);
      });
    } catch {}

    // Optional: notify other tabs
    try { localStorage.setItem('sb-signout', String(Date.now())); } catch {}

    // Go home
    window.location.href = 'index.html';
  }
};

(function() {
  // Wait for everything to be ready before initializing
  function waitForReady() {
    // Check if all dependencies are ready
    if (document.readyState === 'loading' || !window.supabaseClient) {
      setTimeout(waitForReady, 100);
      return;
    }
    init();
  }

  function init() {
    // ---------- Auth state (await authReady + bind once) ----------
    function setVisible(el, show) {
      if (!el) return;
      if (show) {
        // Remove hidden class and restore display
        el.classList.remove('hidden');
        el.classList.remove('md:hidden');
        el.style.display = '';
        el.setAttribute('aria-hidden', 'false');
      } else {
        // Hide the element
        el.classList.add('hidden');
        el.classList.add('md:hidden');
        el.style.display = 'none';
        el.setAttribute('aria-hidden', 'true');
      }
    }

    async function updateHeaderAuth() {
      if (!window.supabaseClient) {
        console.warn('[header] supabaseClient not available');
        return;
      }
      try {
        const { data: { session } } = await window.supabaseClient.auth.getSession();

        const signupBtn        = document.getElementById('signupBtn');
        const loginBtn         = document.getElementById('loginBtn');
        const portalBtn        = document.getElementById('portalBtn');
        const portalBtnHeader  = document.getElementById('portalBtnHeader');
        const logoutBtnHeader  = document.getElementById('logoutBtnHeader');
        const adminBtn         = document.getElementById('adminBtn');

        const signupBtnMobile  = document.getElementById('signupBtnMobile');
        const loginBtnMobile   = document.getElementById('loginBtnMobile');
        const portalBtnMobile  = document.getElementById('portalBtnMobile');
        const logoutBtnMobile  = document.getElementById('logoutBtnMobile');
        const adminBtnMobile   = document.getElementById('adminBtnMobile');

        const loggedIn = !!(session && session.user);

        // Check if user is admin
        let isAdmin = false;
        if (loggedIn) {
          const email = session.user.email;
          const { data: client } = await window.supabaseClient
            .from('client')
            .select('is_admin')
            .eq('email', email)
            .single();
          isAdmin = client?.is_admin === true;
        }

        // Desktop
        setVisible(signupBtn, !loggedIn);
        setVisible(loginBtn,  !loggedIn);
        setVisible(portalBtn, loggedIn && !isAdmin); // Hide for admins
        setVisible(portalBtnHeader, loggedIn && !isAdmin); // Hide for admins
        setVisible(logoutBtnHeader, loggedIn);
        setVisible(adminBtn, loggedIn && isAdmin);

        // Mobile
        setVisible(signupBtnMobile, !loggedIn);
        setVisible(loginBtnMobile,  !loggedIn);
        setVisible(portalBtnMobile, loggedIn && !isAdmin); // Hide for admins
        setVisible(logoutBtnMobile, loggedIn);
        setVisible(adminBtnMobile, loggedIn && isAdmin);

        // Wire logout handlers - use the global headerLogout function
        const wireLogout = (btn) => {
          if (!btn) return;
          btn.onclick = () => window.headerLogout();
        };
        if (loggedIn) {
          wireLogout(logoutBtnHeader);
          wireLogout(logoutBtnMobile);
        }
      } catch (err) {
        console.error('[header] âŒ Error checking auth state:', err);
      }
    }

    // Make updateHeaderAuth globally accessible for debugging
    window.updateHeaderAuth = updateHeaderAuth;

    // Bind exactly once and wait for authReady before first render
    (async function initHeaderAuthOnce() {
      if (window.__headerAuthBound) return;
      window.__headerAuthBound = true;

      // Wait for the auth bootstrap to finish its getSession() call
      if (window.authReady) {
        try { await window.authReady; } catch(e) { console.warn('[header] authReady error:', e); }
      }

      const run = () => window.supabaseClient && updateHeaderAuth();

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', run, { once: true });
      } else {
        run();
      }
      // Subscribe once to future auth changes
      if (window.supabaseClient && !window.__headerAuthSub) {
        window.__headerAuthSub = window.supabaseClient.auth.onAuthStateChange((_event, _session) => run());
      }
      // If your include loader fires a custom event after partials load, re-check
      window.addEventListener('partialsLoaded', () => run());
      // Fallback: also try after a short delay to catch any missed timing issues
      setTimeout(() => {
        if (window.supabaseClient) run();
        else console.warn('[header] supabaseClient still not available after 1s');
      }, 1000);
    })();

    // ---------- Menu logic (single source of truth) ----------
    const mobileMenu  = document.getElementById('mobileMenu');
    const menuToggleBtn = document.getElementById('menuToggleBtn');
    const servicesBtn = document.getElementById('mobileServicesBtn');
    const servicesSub = document.getElementById('mobileServicesSubmenu');

    function openMenu() {
      if (!mobileMenu) return;
      mobileMenu.classList.remove('hidden');
      document.body.classList.add('overflow-hidden');
      if (menuToggleBtn) menuToggleBtn.setAttribute('aria-expanded', 'true');
    }
    function closeMenu() {
      if (!mobileMenu) return;
      mobileMenu.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
      if (menuToggleBtn) menuToggleBtn.setAttribute('aria-expanded', 'false');
    }
    window.closeMenu = closeMenu;   // because links call closeMenu()
    function toggleMenu() {
      if (!mobileMenu) return;
      mobileMenu.classList.contains('hidden') ? openMenu() : closeMenu();
    }
    window.toggleMenu = toggleMenu; // if HTML uses onclick

    function toggleSubmenu(ev) {
      if (!servicesBtn || !servicesSub) return;
      // Prevent outside click handler from closing immediately on iOS
      if (ev && ev.stopPropagation) ev.stopPropagation();
      if (ev && ev.preventDefault) ev.preventDefault();
      else if (window.event) window.event.cancelBubble = true;
      const caret = servicesBtn.querySelector('[data-caret]');
      const nowHidden = servicesSub.classList.toggle('hidden');
      servicesBtn.setAttribute('aria-expanded', nowHidden ? 'false' : 'true');
      if (caret) caret.classList.toggle('rotate-180', !nowHidden);
      return false;
    }
    window.toggleSubmenu = toggleSubmenu;

    // Close on Esc or outside click
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && mobileMenu && !mobileMenu.classList.contains('hidden')) closeMenu();
    });
    document.addEventListener('click', (e) => {
      if (!mobileMenu || mobileMenu.classList.contains('hidden')) return;
      const clickInside = mobileMenu.contains(e.target) || (menuToggleBtn && menuToggleBtn.contains(e.target));
      if (!clickInside) closeMenu();
    });

    // ---------- Desktop services dropdown (click support for touch) ----------
    (function () {
      const trigger = document.getElementById('nav-services');
      const menu    = document.getElementById('nav-services-menu');
      if (!trigger || !menu) return;
      trigger.addEventListener('click', function (e) {
        if (window.innerWidth >= 768) {
          const hidden = menu.classList.contains('hidden');
          if (hidden) {
            e.preventDefault();
            menu.classList.remove('hidden');
            const closer = (evt) => {
              if (!menu.contains(evt.target) && evt.target !== trigger) {
                menu.classList.add('hidden');
                document.removeEventListener('click', closer);
              }
            };
            document.addEventListener('click', closer);
          }
        }
      });
    })();
  } // End of init()

  // Start waiting for dependencies
  waitForReady();
})(); // End of wrapper IIFE
</script>
