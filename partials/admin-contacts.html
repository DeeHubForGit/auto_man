<!-- Admin Contact Messages Section -->
<style>
  /* Custom scrollbar for contact messages */
  #contactsScrollContainer {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f1f5f9;
  }
  
  #contactsScrollContainer::-webkit-scrollbar {
    width: 8px;
  }
  
  #contactsScrollContainer::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
  }
  
  #contactsScrollContainer::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
  }
  
  #contactsScrollContainer::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }
  
  .contact-card {
    background-color: #dbeafe !important;
    border: 2px solid #3b82f6 !important;
    border-radius: 0.5rem !important;
    color: #111827 !important;
    box-shadow: none !important;
    padding: 1rem !important;
    transition: all 0.2s ease !important;
  }
  
  .contact-card.unread {
    border-color: #3b82f6 !important;
    border-width: 3px !important;
    box-shadow: 0 0 0 1px #3b82f6 !important;
  }
  
  .contact-card.read {
    background-color: #f3f4f6 !important;
    border-color: #9ca3af !important;
  }
  
  .contact-card * {
    color: #111827 !important;
  }
  
  .contact-card svg {
    color: #4b5563 !important;
  }
</style>

<section id="section-contacts" class="section-content bg-white border rounded-2xl shadow-sm p-5 hidden">
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-3">
      <h2 class="text-xl font-semibold">Contact Messages</h2>
      <span id="contactsCount" class="text-sm text-gray-600"></span>
    </div>
    <button id="reloadContacts" class="btn btn-primary px-3 py-1.5">
      <span id="reloadContactsText">Reload</span>
      <span id="reloadContactsSpinner" class="hidden">
        <svg class="animate-spin h-4 w-4 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </span>
    </button>
  </div>
  
  <!-- Filters -->
  <div class="flex flex-wrap items-center gap-3 mb-4">
    <input 
      id="contactSearch" 
      type="text" 
      placeholder="Search by name, email, or message..." 
      class="flex-1 min-w-[200px] bg-white text-gray-900 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
    />
    <select 
      id="contactReadFilter" 
      class="bg-white text-gray-900 border border-gray-300 rounded-lg px-3 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-[150px]"
    >
      <option value="all">All Messages</option>
      <option value="unread">Unread Only</option>
      <option value="read">Read Only</option>
    </select>
    <select 
      id="contactSort" 
      class="bg-white text-gray-900 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
    >
      <option value="newest">Newest first</option>
      <option value="oldest">Oldest first</option>
    </select>
    <select 
      id="contactsPerPage" 
      class="bg-white text-gray-900 border border-gray-300 rounded-lg px-3 py-2 pr-8 focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-[140px]"
    >
      <option value="10" selected>10 per page</option>
      <option value="25">25 per page</option>
      <option value="50">50 per page</option>
      <option value="100">100 per page</option>
    </select>
  </div>
  
  <!-- Scrollable Messages container -->
  <div id="contactsScrollContainer" class="overflow-y-auto max-h-[600px] border border-gray-200 rounded-lg p-3 mb-4">
    <div id="contactsList" class="space-y-3"></div>
  </div>
  
  <!-- Pagination -->
  <div id="contactsPagination" class="flex items-center justify-between">
    <div class="text-sm text-gray-600">
      <span id="paginationInfo"></span>
    </div>
    <div class="flex items-center gap-3">
      <button id="prevPage" class="btn btn-secondary px-3 py-2 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed" title="Previous page" aria-label="Previous page">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
      <span id="pageNumbers" class="text-sm text-gray-700 font-medium min-w-[80px] text-center"></span>
      <button id="nextPage" class="btn btn-primary px-3 py-2 disabled:opacity-50 disabled:cursor-not-allowed" title="Next page" aria-label="Next page">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </button>
    </div>
  </div>
</section>

<script>
(function() {
  // Contact Messages - Store for filtering and pagination
  let allContactMessages = [];
  let currentPage = 1;
  
  async function loadContacts(){
    const box = document.getElementById('contactsList');
    const reloadBtn = document.getElementById('reloadContacts');
    const reloadText = document.getElementById('reloadContactsText');
    const reloadSpinner = document.getElementById('reloadContactsSpinner');
    
    if (!box) {
      console.error('[admin-contacts] contactsList element not found');
      return;
    }
    
    if (!window.supabaseClient) {
      console.error('[admin-contacts] supabaseClient not available for loadContacts');
      box.innerHTML = '<div class="p-4 text-center text-gray-500">Supabase not connected</div>';
      return;
    }
    
    // Show loading spinner
    if (reloadText) reloadText.classList.add('hidden');
    if (reloadSpinner) reloadSpinner.classList.remove('hidden');
    if (reloadBtn) reloadBtn.disabled = true;
    
    box.innerHTML = '<div class="p-8 text-center text-gray-500">Loading messages...</div>';
    
    try {
      const { data, error, status, statusText } = await window.supabaseClient
        .from('contact_messages')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(100);
      
      if (error) {
        console.error('[admin-contacts] Error loading contacts:', error);
        box.innerHTML = `<div class="p-4 text-center text-red-600">Error: ${error.message}</div>`;
        return;
      }
      
      allContactMessages = Array.isArray(data) ? data : [];
      currentPage = 1; // Reset to first page on reload
      renderContactMessages();
      
    } catch (e) {
      console.error('[admin-contacts] Unexpected error loading contacts:', e);
      box.innerHTML = `<div class="p-4 text-center text-red-600">Error: ${e?.message || String(e)}</div>`;
    } finally {
      // Hide loading spinner
      if (reloadText) reloadText.classList.remove('hidden');
      if (reloadSpinner) reloadSpinner.classList.add('hidden');
      if (reloadBtn) reloadBtn.disabled = false;
    }
  }
  
  function renderContactMessages() {
    const box = document.getElementById('contactsList');
    const searchTerm = (document.getElementById('contactSearch')?.value || '').toLowerCase();
    const readFilter = document.getElementById('contactReadFilter')?.value || 'all';
    const sortOrder = document.getElementById('contactSort')?.value || 'newest';
    const perPage = parseInt(document.getElementById('contactsPerPage')?.value || '10');
    const contactsCount = document.getElementById('contactsCount');
    const paginationInfo = document.getElementById('paginationInfo');
    const pageNumbers = document.getElementById('pageNumbers');
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    
    if (!box) return;
    
    // Filter messages
    let filtered = allContactMessages.filter(row => {
      // Read status filter
      if (readFilter === 'unread' && row.is_read) return false;
      if (readFilter === 'read' && !row.is_read) return false;
      
      // Search filter
      if (!searchTerm) return true;
      const name = (row.name || '').toLowerCase();
      const email = (row.email || '').toLowerCase();
      const message = (row.message || '').toLowerCase();
      const phone = (row.phone || '').toLowerCase();
      return name.includes(searchTerm) || email.includes(searchTerm) || 
             message.includes(searchTerm) || phone.includes(searchTerm);
    });
    
    // Sort messages
    filtered.sort((a, b) => {
      const dateA = new Date(a.created_at).getTime();
      const dateB = new Date(b.created_at).getTime();
      return sortOrder === 'newest' ? dateB - dateA : dateA - dateB;
    });
    
    // Update total count
    if (contactsCount) {
      contactsCount.textContent = `(${filtered.length} total)`;
    }
    
    // Calculate pagination
    const totalPages = Math.ceil(filtered.length / perPage);
    if (currentPage > totalPages && totalPages > 0) {
      currentPage = totalPages;
    }
    if (currentPage < 1) currentPage = 1;
    
    const startIdx = (currentPage - 1) * perPage;
    const endIdx = startIdx + perPage;
    const paginatedMessages = filtered.slice(startIdx, endIdx);
    
    // Update pagination info
    if (paginationInfo) {
      if (filtered.length === 0) {
        paginationInfo.textContent = '';
      } else if (totalPages <= 1) {
        // Single page - show "Showing all X"
        paginationInfo.textContent = `Showing all ${filtered.length}`;
      } else {
        // Multiple pages - show range
        const start = startIdx + 1;
        const end = Math.min(endIdx, filtered.length);
        if (start === end) {
          paginationInfo.textContent = `Showing ${start} of ${filtered.length}`;
        } else {
          paginationInfo.textContent = `Showing ${start}-${end} of ${filtered.length}`;
        }
      }
    }
    
    // Update page numbers
    if (pageNumbers) {
      pageNumbers.textContent = totalPages > 0 ? `Page ${currentPage} of ${totalPages}` : '';
    }
    
    // Update prev/next buttons
    if (prevBtn) {
      prevBtn.disabled = currentPage <= 1;
    }
    if (nextBtn) {
      nextBtn.disabled = currentPage >= totalPages;
    }
    // Render
    box.innerHTML = '';
    
    if (filtered.length === 0) {
      const emptyMsg = searchTerm 
        ? `<div class="p-8 text-center text-gray-500">No messages match "${searchTerm}"</div>`
        : '<div class="p-8 text-center text-gray-500">ðŸ“­ No contact messages yet</div>';
      box.innerHTML = emptyMsg;
      return;
    }
    
    paginatedMessages.forEach(row => {
      const card = document.createElement('div');
      // Add visual indicator for unread messages - unread gets bright blue border, read gets gray
      const isRead = row.is_read;
      const readClass = isRead ? 'read' : 'unread';
      card.className = `contact-card ${readClass} mb-3 cursor-pointer`;
      card.setAttribute('data-message-id', row.id);
      card.setAttribute('data-is-read', isRead);
      
      const name = row.name || 'Anonymous';
      const email = row.email || '';
      const phone = row.phone || '';
      const message = row.message || '';
      const date = new Date(row.created_at).toLocaleString('en-AU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      
      // Unread badge
      const unreadBadge = row.is_read ? '' : '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 ml-2">NEW</span>';
      
      card.innerHTML = `
        <div class="font-semibold mb-1 flex items-center">
          ${name}
          ${unreadBadge}
        </div>

        <div class="text-sm mb-1 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
              d="M21.75 7.5v9a2.25 2.25 0 0 1-2.25 2.25h-15A2.25 2.25 0 0 1 2.25 16.5v-9m19.5 0A2.25 2.25 0 0 0 19.5 5.25h-15A2.25 2.25 0 0 0 2.25 7.5m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.915l-7.5 4.5a2.25 2.25 0 0 1-2.31 0l-7.5-4.5A2.25 2.25 0 0 1 2.25 7.743V7.5" />
          </svg>
          <span>${email || 'â€”'}</span>
        </div>

        ${phone ? `
          <div class="text-sm mb-2 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                d="M2.25 6.75c0 7.456 6.044 13.5 13.5 13.5a2.25 2.25 0 0 0 2.25-2.25v-1.17a1.5 1.5 0 0 0-1.03-1.422l-3.03-1.01a1.5 1.5 0 0 0-1.64.54l-.64.85a10.5 10.5 0 0 1-4.56-4.56l.85-.64a1.5 1.5 0 0 0 .54-1.64l-1.01-3.03A1.5 1.5 0 0 0 6.17 4.5H5a2.25 2.25 0 0 0-2.75 2.25z" />
            </svg>
            <span>${phone}</span>
          </div>
        ` : '<div class="mb-2"></div>'}

        <div class="whitespace-pre-wrap mb-2"><strong>Message:</strong> ${message}</div>
        <div class="text-xs opacity-80 mt-2">${date}</div>
      `;
      
      box.appendChild(card);
    });
  }
  
  // Mark message as read
  async function markMessageAsRead(messageId) {
    if (!window.supabaseClient) {
      console.error('[admin-contacts] supabaseClient not available');
      return;
    }
    
    try {
      const { data, error } = await window.supabaseClient
        .from('contact_messages')
        .update({ is_read: true })
        .eq('id', messageId)
        .select();
      
      if (error) {
        console.error('[admin-contacts] Error marking message as read:', error);
        return;
      }
      
      // Update the message in our local array
      const message = allContactMessages.find(m => m.id === messageId);
      if (message) {
        message.is_read = true;
      }
      
      // Re-render to update UI
      renderContactMessages();
      
      // Update notification badges if available
      if (window.updateNotificationBadges) {
        window.updateNotificationBadges();
      }
    } catch (error) {
      console.error('[admin-contacts] Error marking message as read:', error);
    }
  }

  // Wire up when partial loads
  if (window.adminContactsReady) {
    // Already initialized
  } else {
    window.adminContactsReady = true;
    
    const initContacts = () => {
      const reloadContactsBtn = document.getElementById('reloadContacts');
      if (reloadContactsBtn) reloadContactsBtn.onclick = loadContacts;
      
      // Wire up search and sort filters
      const contactSearch = document.getElementById('contactSearch');
      if (contactSearch) {
        contactSearch.addEventListener('input', () => {
          currentPage = 1; // Reset to page 1 when searching
          renderContactMessages();
        });
      }
      
      const contactReadFilter = document.getElementById('contactReadFilter');
      if (contactReadFilter) {
        contactReadFilter.addEventListener('change', () => {
          currentPage = 1; // Reset to page 1 when filter changes
          renderContactMessages();
        });
      }
      
      const contactSort = document.getElementById('contactSort');
      if (contactSort) {
        contactSort.addEventListener('change', () => {
          currentPage = 1; // Reset to page 1 when sorting changes
          renderContactMessages();
        });
      }
      
      const contactsPerPage = document.getElementById('contactsPerPage');
      if (contactsPerPage) {
        contactsPerPage.addEventListener('change', () => {
          currentPage = 1; // Reset to page 1 when per-page changes
          renderContactMessages();
        });
      }
      
      // Click on message card to mark as read (like email clients)
      const contactsList = document.getElementById('contactsList');
      if (contactsList) {
        contactsList.addEventListener('click', (e) => {
          // Find the card element (could be clicking on child elements)
          const card = e.target.closest('.contact-card');
          if (card) {
            const messageId = card.getAttribute('data-message-id');
            const isRead = card.getAttribute('data-is-read') === 'true';
            
            // Only mark as read if currently unread
            if (messageId && !isRead) {
              markMessageAsRead(messageId);
            }
          }
        });
      }
      
      // Pagination buttons
      const prevPage = document.getElementById('prevPage');
      if (prevPage) {
        prevPage.addEventListener('click', () => {
          if (currentPage > 1) {
            currentPage--;
            renderContactMessages();
            // Scroll to top of messages
            document.getElementById('contactsScrollContainer')?.scrollTo(0, 0);
          }
        });
      }
      
      const nextPage = document.getElementById('nextPage');
      if (nextPage) {
        nextPage.addEventListener('click', () => {
          currentPage++;
          renderContactMessages();
          // Scroll to top of messages
          document.getElementById('contactsScrollContainer')?.scrollTo(0, 0);
        });
      }
      
      loadContacts();
    };
    
    // Expose functions globally for notification icons
    window.adminContactsLoadAndFilter = function(readFilter) {
      const filterDropdown = document.getElementById('contactReadFilter');
      if (filterDropdown && readFilter) {
        filterDropdown.value = readFilter;
      }
      loadContacts();
    };
    
    window.adminContactsGetUnreadCount = function() {
      return allContactMessages.filter(m => !m.is_read).length;
    };
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initContacts);
    } else {
      initContacts();
    }
  }
})();
</script>
